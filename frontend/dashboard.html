<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="User Dashboard - Much Love, No Fear">
    <title>Dashboard - Much Love, No Fear</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/dashboard-viking.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <div class="flex flex-between">
                <div class="site-logo">
                    <i class="fas fa-shield-alt site-logo-icon"></i>
                    <span>Much Love, No Fear</span>
                </div>
                
                <nav class="site-nav" id="mainNav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="pages/live.html" class="nav-link">Live</a>
                    <a href="pages/archive.html" class="nav-link">Love Vault</a>
                    <a href="pages/blog.html" class="nav-link">Blog</a>
                    <a href="pages/news.html" class="nav-link">News</a>
                    <a href="pages/messageboard.html" class="nav-link">Board</a>
                    <a href="pages/donations.html" class="nav-link">Support</a>
                    <a href="pages/merch.html" class="nav-link">Merch</a>
                    <a href="dashboard.html" class="nav-link active" id="dashboardLink">Dashboard</a>
                    
                    <!-- Notification Bell -->
                    <div class="notification-bell" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">3</span>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="user-menu">
                        <button class="user-menu-toggle" id="userMenuToggle">
                            <img src="https://via.placeholder.com/150/4A90E2/FFFFFF?text=User" alt="User" class="avatar-sm">
                            <span class="username-display">User</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="user-menu-dropdown hidden" id="userMenuDropdown">
                            <a href="#profile"><i class="fas fa-user"></i> Profile</a>
                            <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
                            <a href="#" onclick="MLNFAuth.logout(); return false;"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <button class="btn-icon" id="themeToggle" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </nav>
                
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Dashboard Content -->
    <section style="padding: 2rem 0;">
        <div class="container">
            <div class="grid" style="grid-template-columns: 250px 1fr; gap: 2rem;">
                <!-- Sidebar Navigation -->
                <aside class="dashboard-sidebar">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <img src="https://via.placeholder.com/150/4A90E2/FFFFFF?text=User" alt="User" class="avatar-lg mb-2">
                                <h4 class="username-display">User</h4>
                                <div class="badge badge-gold user-badge">New Viking</div>
                            </div>
                            
                            <div class="runegold-display mb-3" style="background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md);">
                                <div class="flex flex-between">
                                    <span>Runegold Balance</span>
                                    <strong style="color: var(--gold);">1,250</strong>
                                </div>
                            </div>
                            
                            <nav class="dashboard-nav">
                                <a href="#overview" class="active"><i class="fas fa-home"></i> Overview</a>
                                <a href="#livestream"><i class="fas fa-broadcast-tower"></i> Go Live</a>
                                <a href="#videos"><i class="fas fa-video"></i> My Videos</a>
                                <a href="#blog-posts"><i class="fas fa-pen"></i> Blog Posts</a>
                                <a href="#runegold"><i class="fas fa-coins"></i> Runegold Shop</a>
                                <a href="#messages"><i class="fas fa-envelope"></i> Messages</a>
                                <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
                                <a href="#badges"><i class="fas fa-medal"></i> Badges</a>
                                <a href="#subscription"><i class="fas fa-crown"></i> Subscription</a>
                            </nav>
                        </div>
                    </div>
                </aside>

                <!-- Main Dashboard Area -->
                <main>
                    <!-- Stats Overview -->
                    <div class="grid grid-4 mb-3" id="statsOverview">
                        <div class="card">
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div>
                                        <p class="text-muted text-sm">Total Views</p>
                                        <h3 id="totalViews">45,892</h3>
                                    </div>
                                    <i class="fas fa-eye text-indigo" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div>
                                        <p class="text-muted text-sm">Followers</p>
                                        <h3 id="totalFollowers">1,234</h3>
                                    </div>
                                    <i class="fas fa-users text-peach" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div>
                                        <p class="text-muted text-sm">Videos</p>
                                        <h3 id="totalVideos">28</h3>
                                    </div>
                                    <i class="fas fa-video text-gold" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div>
                                        <p class="text-muted text-sm">Comments</p>
                                        <h3 id="totalComments">892</h3>
                                    </div>
                                    <i class="fas fa-comments text-success" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Creator Studio - Livestreaming Section (hidden by default) -->
                    <div id="livestreamSection" class="hidden">
                        <!-- Live Status Banner -->
                        <div class="card mb-3" id="liveStatusBanner" style="display: none; background: linear-gradient(135deg, var(--error) 0%, var(--peach) 100%); color: white; border: none; box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4); position: relative; overflow: hidden;">
                            <!-- Animated background effect -->
                            <div style="position: absolute; top: 0; right: 0; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); opacity: 0.5;"></div>

                            <div class="card-body" style="position: relative; z-index: 1;">
                                <div class="flex flex-between" style="align-items: center;">
                                    <div>
                                        <h3 style="color: white; margin: 0; font-size: 1.75rem;">
                                            <i class="fas fa-circle" style="animation: pulse-live 2s infinite; margin-right: 0.5rem;"></i>
                                            You're Live!
                                        </h3>
                                        <p style="margin: 0.5rem 0 0; opacity: 0.95; font-size: 1rem;">
                                            <i class="fas fa-clock"></i> Stream started <span id="streamStartTime">--</span> ago
                                        </p>
                                    </div>
                                    <div style="display: flex; gap: 1.5rem; align-items: center;">
                                        <!-- Viewer count card -->
                                        <div style="text-align: center; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 1.25rem 1.5rem; border-radius: var(--radius-lg); min-width: 120px;">
                                            <div style="font-size: 2.5rem; font-weight: 800; line-height: 1;">
                                                <span id="currentViewers">0</span>
                                            </div>
                                            <div style="font-size: 0.875rem; opacity: 0.95; margin-top: 0.25rem; font-weight: 600;">
                                                <i class="fas fa-users"></i> Warriors
                                            </div>
                                        </div>
                                        <!-- End stream button -->
                                        <button class="btn" style="background: white; color: var(--error); font-weight: 700; padding: 0.75rem 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2);" onclick="endStream()">
                                            <i class="fas fa-stop-circle"></i> End Stream
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Create New Stream -->
                        <div class="card mb-3" style="border: 2px solid var(--gold); box-shadow: var(--shadow-viking);">
                            <div class="card-body">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--gray-200);">
                                    <div>
                                        <h3 style="margin: 0; color: var(--navy);"><i class="fas fa-broadcast-tower text-gold"></i> Creator Studio</h3>
                                        <p style="margin: 0.5rem 0 0; color: var(--gray-600); font-size: 0.9375rem;">Prepare your stream for the warriors</p>
                                    </div>
                                    <div style="background: linear-gradient(135deg, var(--gold) 0%, #C4A035 100%); color: var(--navy); padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; font-size: 0.875rem;">
                                        <i class="fas fa-shield-alt"></i> Ready to Broadcast
                                    </div>
                                </div>

                                <form id="createStreamForm" class="mb-3">
                                    <div class="grid grid-2 gap-md mb-3">
                                        <div class="form-group">
                                            <label for="streamTitle">Stream Title *</label>
                                            <input type="text" id="streamTitle" class="form-control" placeholder="Enter an engaging title..." maxlength="100" required>
                                            <small class="text-muted">Make it descriptive so warriors know what to expect</small>
                                        </div>

                                        <div class="form-group">
                                            <label for="streamCategory">Category</label>
                                            <select id="streamCategory" class="form-control">
                                                <option value="General">General</option>
                                                <option value="Politics">Politics</option>
                                                <option value="Health">Health & Wellness</option>
                                                <option value="Finance">Finance & Economics</option>
                                                <option value="Tech">Technology</option>
                                                <option value="Education">Education</option>
                                                <option value="Entertainment">Entertainment</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group mb-3">
                                        <label for="streamDescription">Description (Optional)</label>
                                        <textarea id="streamDescription" class="form-control" rows="3" placeholder="What will you be discussing?" maxlength="1000"></textarea>
                                    </div>

                                    <div class="flex gap-md">
                                        <button type="submit" class="btn btn-viking">
                                            <i class="fas fa-plus-circle"></i> Create Stream & Get Key
                                        </button>
                                        <button type="button" class="btn btn-outline" onclick="toggleOBSGuide()">
                                            <i class="fas fa-question-circle"></i> OBS Setup Guide
                                        </button>
                                    </div>
                                </form>

                                <!-- OBS Setup Guide (collapsed by default) -->
                                <div id="obsGuide" class="hidden" style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-md); margin-top: 1rem;">
                                    <h4 class="mb-2"><i class="fas fa-desktop"></i> How to Stream with OBS</h4>
                                    <ol style="line-height: 1.8;">
                                        <li>Create your stream above to get your unique stream key</li>
                                        <li>Open OBS Studio (Download from <a href="https://obsproject.com/" target="_blank">obsproject.com</a>)</li>
                                        <li>Go to <strong>Settings → Stream</strong></li>
                                        <li>Service: <strong>Custom</strong></li>
                                        <li>Server: <code style="background: var(--gray-100); padding: 0.25rem 0.5rem; border-radius: 4px;">rtmp://150.136.140.253:1935/live</code></li>
                                        <li>Stream Key: <strong>Paste your key from below</strong></li>
                                        <li>Click "Start Streaming" in OBS</li>
                                        <li>Come back here and click "Go Live" to make your stream visible to warriors!</li>
                                    </ol>
                                    <div style="margin-top: 1rem; padding: 1rem; background: var(--indigo); color: white; border-radius: var(--radius-md);">
                                        <strong><i class="fas fa-shield-alt"></i> Pro Tip:</strong> Test your stream settings before going live. Recommended bitrate: 3500-6000 Kbps for 1080p.
                                    </div>
                                </div>

                                <!-- Stream Key Display (appears after creating stream) -->
                                <div id="streamKeyDisplay" class="hidden" style="background: linear-gradient(135deg, var(--navy), var(--indigo)); color: white; padding: 1.5rem; border-radius: var(--radius-md); margin-top: 1rem;">
                                    <h4 style="color: var(--gold); margin-bottom: 1rem;"><i class="fas fa-key"></i> Your Stream Key</h4>
                                    <div class="flex gap-md" style="align-items: center;">
                                        <input type="password" id="streamKeyValue" class="form-control" style="flex: 1; font-family: monospace; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white;" readonly>
                                        <button class="btn" style="background: var(--gold); color: var(--navy);" onclick="toggleStreamKeyVisibility()">
                                            <i class="fas fa-eye" id="streamKeyToggleIcon"></i>
                                        </button>
                                        <button class="btn" style="background: var(--peach); color: white;" onclick="copyStreamKey()">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                    </div>
                                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: var(--radius-md);">
                                        <strong style="color: var(--gold);"><i class="fas fa-exclamation-triangle"></i> Keep this secret!</strong> Anyone with your stream key can broadcast to your channel.
                                    </div>
                                    <div style="margin-top: 1rem;">
                                        <button class="btn btn-viking" onclick="goLive()" id="goLiveButton">
                                            <i class="fas fa-play-circle"></i> ⚡ Go Live!
                                        </button>
                                        <small style="display: block; margin-top: 0.5rem; opacity: 0.8;">Make sure OBS is streaming before clicking this!</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Your Streams -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h3 class="mb-3"><i class="fas fa-history"></i> Your Streams</h3>
                                <div id="userStreamsList">
                                    <div class="text-center text-muted" style="padding: 2rem;">
                                        <i class="fas fa-broadcast-tower" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                        <p>No streams yet. Create your first stream above!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <h3 class="mb-3">Recent Activity</h3>
                            <div class="activity-timeline">
                                <div class="activity-item">
                                    <div class="activity-icon" style="background: var(--success);">
                                        <i class="fas fa-video"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p><strong>Your video "Truth About Health Freedom"</strong> reached 10k views!</p>
                                        <small class="text-muted">2 hours ago</small>
                                    </div>
                                </div>
                                
                                <div class="activity-item">
                                    <div class="activity-icon" style="background: var(--indigo);">
                                        <i class="fas fa-comment"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p><strong>FreedomFighter</strong> commented on your video</p>
                                        <small class="text-muted">5 hours ago</small>
                                    </div>
                                </div>
                                
                                <div class="activity-item">
                                    <div class="activity-icon" style="background: var(--gold);">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p>You earned <strong>50 Runegold</strong> from video boosts</p>
                                        <small class="text-muted">1 day ago</small>
                                    </div>
                                </div>
                                
                                <div class="activity-item">
                                    <div class="activity-icon" style="background: var(--peach);">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p><strong>12 new followers</strong> this week</p>
                                        <small class="text-muted">2 days ago</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Section (instant messaging) -->
                    <div id="messagesSection" class="hidden">
                        <!-- Messages Header -->
                        <div class="card mb-3" style="background: linear-gradient(135deg, var(--indigo), var(--navy)); color: white; border: none;">
                            <div class="card-body">
                                <div class="flex flex-between" style="align-items: center;">
                                    <div>
                                        <h3 style="color: white; margin: 0;"><i class="fas fa-envelope"></i> Messages</h3>
                                        <p style="margin: 0.5rem 0 0; opacity: 0.9;">Connect directly with warriors</p>
                                    </div>
                                    <button class="btn" style="background: var(--gold); color: var(--navy);" onclick="openNewMessage()">
                                        <i class="fas fa-plus-circle"></i> New Message
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Interface -->
                        <div class="grid grid-2 gap-md" style="min-height: 600px;">
                            <!-- Conversations List -->
                            <div class="card">
                                <div class="card-body" style="padding: 0;">
                                    <div style="padding: 1rem; border-bottom: 2px solid var(--gray-200);">
                                        <input type="search" class="form-control" placeholder="Search conversations..." id="conversationSearch" style="border-radius: 20px;">
                                    </div>

                                    <div id="conversationsList" style="max-height: 500px; overflow-y: auto;">
                                        <!-- Conversations will be loaded here -->
                                        <div class="text-center text-muted" style="padding: 3rem 1rem;">
                                            <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                            <p>No conversations yet</p>
                                            <small>Send a message to start chatting!</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Window -->
                            <div class="card">
                                <div class="card-body" style="padding: 0; display: flex; flex-direction: column; height: 600px;">
                                    <!-- Chat Header -->
                                    <div id="chatHeader" class="hidden" style="padding: 1rem; border-bottom: 2px solid var(--gray-200); background: var(--gray-50);">
                                        <div class="flex gap-md" style="align-items: center;">
                                            <div class="thread-avatar" style="width: 40px; height: 40px; font-size: 1rem;">
                                                U
                                            </div>
                                            <div style="flex: 1;">
                                                <h5 style="margin: 0;" id="chatUsername">Username</h5>
                                                <small class="text-muted" id="chatStatus">Online</small>
                                            </div>
                                            <button class="btn btn-sm btn-outline" onclick="closeChat()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Chat Messages -->
                                    <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 1.5rem; background: white;">
                                        <div class="text-center text-muted" style="padding: 3rem 1rem;">
                                            <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                            <p>Select a conversation to start chatting</p>
                                        </div>
                                    </div>

                                    <!-- Message Input -->
                                    <div id="messageInput" class="hidden" style="padding: 1rem; border-top: 2px solid var(--gray-200); background: var(--gray-50);">
                                        <form id="sendMessageForm" class="flex gap-md" style="align-items: center;">
                                            <input type="text" class="form-control" placeholder="Type a message..." id="messageText" required style="flex: 1; border-radius: 20px;">
                                            <button type="submit" class="btn btn-viking" style="border-radius: 50%; width: 48px; height: 48px; padding: 0;">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Your Videos Section -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="flex flex-between mb-3">
                                <h3>Your Videos</h3>
                                <button class="btn btn-viking btn-sm">
                                    <i class="fas fa-upload"></i> Upload New
                                </button>
                            </div>

                            <div class="grid grid-3">
                                <div class="video-card">
                                    <div class="video-thumbnail" style="position: relative;">
                                        <img src="https://via.placeholder.com/320x180/333333/FFFFFF?text=Video" alt="Video" style="width: 100%; border-radius: var(--radius-md);">
                                        <span class="badge badge-error" style="position: absolute; top: 10px; right: 10px;">LIVE</span>
                                    </div>
                                    <h5 class="mt-2">Truth About Health Freedom</h5>
                                    <div class="flex gap-md text-sm text-muted">
                                        <span><i class="fas fa-eye"></i> 10.2k</span>
                                        <span><i class="fas fa-thumbs-up"></i> 892</span>
                                        <span><i class="fas fa-comment"></i> 145</span>
                                    </div>
                                </div>
                                
                                <div class="video-card">
                                    <div class="video-thumbnail">
                                        <img src="https://via.placeholder.com/320x180/333333/FFFFFF?text=Video" alt="Video" style="width: 100%; border-radius: var(--radius-md);">
                                    </div>
                                    <h5 class="mt-2">Exposing the Financial System</h5>
                                    <div class="flex gap-md text-sm text-muted">
                                        <span><i class="fas fa-eye"></i> 8.5k</span>
                                        <span><i class="fas fa-thumbs-up"></i> 723</span>
                                        <span><i class="fas fa-comment"></i> 89</span>
                                    </div>
                                </div>
                                
                                <div class="video-card">
                                    <div class="video-thumbnail">
                                        <img src="https://via.placeholder.com/320x180/333333/FFFFFF?text=Video" alt="Video" style="width: 100%; border-radius: var(--radius-md);">
                                    </div>
                                    <h5 class="mt-2">Natural Immunity Evidence</h5>
                                    <div class="flex gap-md text-sm text-muted">
                                        <span><i class="fas fa-eye"></i> 6.3k</span>
                                        <span><i class="fas fa-thumbs-up"></i> 567</span>
                                        <span><i class="fas fa-comment"></i> 67</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <a href="#" class="btn btn-outline">View All Videos</a>
                            </div>
                        </div>
                    </div>

                    <!-- Runegold Shop -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <h3 class="mb-3">
                                <i class="fas fa-coins text-gold"></i> Runegold Shop
                            </h3>
                            <p class="text-muted mb-3">Use your Runegold to boost videos, highlight comments, and get exclusive perks!</p>
                            
                            <div class="grid grid-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-rocket text-peach" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                        <h5>Video Boost</h5>
                                        <p class="text-muted text-sm">Promote your video</p>
                                        <div class="price text-gold">100 RG</div>
                                        <button class="btn btn-sm btn-outline mt-2">Purchase</button>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-star text-gold" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                        <h5>Pin Comment</h5>
                                        <p class="text-muted text-sm">Highlight your message</p>
                                        <div class="price text-gold">50 RG</div>
                                        <button class="btn btn-sm btn-outline mt-2">Purchase</button>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-badge text-indigo" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                        <h5>Custom Badge</h5>
                                        <p class="text-muted text-sm">Stand out in comments</p>
                                        <div class="price text-gold">200 RG</div>
                                        <button class="btn btn-sm btn-outline mt-2">Purchase</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <button class="btn btn-viking">
                                    <i class="fas fa-plus-circle"></i> Get More Runegold
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Achievements -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="mb-3">Your Achievements</h3>
                            <div class="grid grid-6">
                                <div class="text-center">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--gold);">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <p class="text-sm">Truth Warrior</p>
                                </div>
                                
                                <div class="text-center">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--indigo);">
                                        <i class="fas fa-video"></i>
                                    </div>
                                    <p class="text-sm">Content Creator</p>
                                </div>
                                
                                <div class="text-center">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--peach);">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <p class="text-sm">Community Leader</p>
                                </div>
                                
                                <div class="text-center">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--success);">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <p class="text-sm">Active Commenter</p>
                                </div>
                                
                                <div class="text-center">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--gray-300);">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <p class="text-sm">Locked</p>
                                </div>
                                
                                <div class="text-center">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--gray-300);">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <p class="text-sm">Locked</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </section>

    <!-- Profile Edit Modal -->
    <div class="modal" id="profileEditModal" style="display: none;">
        <div class="modal-overlay" onclick="closeProfileEdit()"></div>
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Edit Profile</h2>
                <button class="modal-close" onclick="closeProfileEdit()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="profileEditForm">
                    <!-- Avatar Upload -->
                    <div class="form-group text-center mb-4">
                        <div class="avatar-upload-container" style="position: relative; display: inline-block;">
                            <img id="profileAvatarPreview" src="https://via.placeholder.com/150/4A90E2/FFFFFF?text=User" alt="Avatar" class="avatar-xl" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover;">
                            <label for="avatarUpload" class="avatar-upload-btn" style="position: absolute; bottom: 0; right: 0; background: var(--indigo); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="previewAvatar(event)">
                        </div>
                        <p class="text-sm text-muted mt-2">Click camera icon to change avatar</p>
                    </div>

                    <!-- Basic Info -->
                    <div class="form-group">
                        <label for="editUsername">Username</label>
                        <input type="text" id="editUsername" class="form-control" placeholder="Your username" readonly style="background: var(--gray-50);">
                        <small class="text-muted">Username cannot be changed</small>
                    </div>

                    <div class="grid grid-2 gap-md">
                        <div class="form-group">
                            <label for="editFirstName">First Name</label>
                            <input type="text" id="editFirstName" class="form-control" placeholder="First name">
                        </div>
                        
                        <div class="form-group">
                            <label for="editLastName">Last Name</label>
                            <input type="text" id="editLastName" class="form-control" placeholder="Last name">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editEmail">Email (Optional)</label>
                        <input type="email" id="editEmail" class="form-control" placeholder="your@email.com">
                    </div>

                    <div class="form-group">
                        <label for="editBio">Bio</label>
                        <textarea id="editBio" class="form-control" rows="4" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                        <small class="text-muted"><span id="bioCharCount">0</span>/500 characters</small>
                    </div>

                    <!-- Social Links -->
                    <h4 class="mt-4 mb-3"><i class="fas fa-share-alt"></i> Social Links</h4>
                    
                    <div class="form-group">
                        <label for="editTwitter">
                            <i class="fab fa-twitter text-indigo"></i> Twitter/X
                        </label>
                        <input type="url" id="editTwitter" class="form-control" placeholder="https://twitter.com/yourhandle">
                    </div>

                    <div class="form-group">
                        <label for="editYoutube">
                            <i class="fab fa-youtube text-error"></i> YouTube
                        </label>
                        <input type="url" id="editYoutube" class="form-control" placeholder="https://youtube.com/@yourchannel">
                    </div>

                    <div class="form-group">
                        <label for="editTelegram">
                            <i class="fab fa-telegram text-info"></i> Telegram
                        </label>
                        <input type="url" id="editTelegram" class="form-control" placeholder="https://t.me/yourhandle">
                    </div>

                    <div class="form-group">
                        <label for="editWebsite">
                            <i class="fas fa-globe text-success"></i> Website
                        </label>
                        <input type="url" id="editWebsite" class="form-control" placeholder="https://yourwebsite.com">
                    </div>

                    <!-- Location -->
                    <div class="form-group">
                        <label for="editLocation">
                            <i class="fas fa-map-marker-alt text-error"></i> Location
                        </label>
                        <input type="text" id="editLocation" class="form-control" placeholder="City, Country">
                    </div>

                    <!-- Privacy Settings -->
                    <h4 class="mt-4 mb-3"><i class="fas fa-shield-alt"></i> Privacy</h4>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editPrivateProfile"> Make profile private
                        </label>
                        <p class="text-sm text-muted" style="margin: 0.5rem 0 0 1.5rem;">Only followers can see your profile</p>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editHideEmail"> Hide email from public
                        </label>
                        <p class="text-sm text-muted" style="margin: 0.5rem 0 0 1.5rem;">Email won't be visible to other users</p>
                        </div>

                    <!-- Save Button -->
                    <div class="flex gap-md mt-4">
                        <button type="submit" class="btn btn-viking btn-lg">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-outline btn-lg" onclick="closeProfileEdit()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Runegold Shop Modal -->
    <div class="modal" id="runegoldShopModal" style="display: none;">
        <div class="modal-overlay" onclick="closeRunegoldShop()"></div>
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-coins text-gold"></i> Runegold Shop</h2>
                <button class="modal-close" onclick="closeRunegoldShop()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Balance Display -->
                <div class="card mb-3" style="background: linear-gradient(135deg, var(--gold), var(--peach)); color: white;">
                    <div class="card-body text-center">
                        <h4 style="color: white;">Your Balance</h4>
                        <div style="font-size: 3rem; font-weight: bold;" id="shopRunegoldBalance">0</div>
                        <p style="opacity: 0.9;">Runegold</p>
                    </div>
                </div>

                <!-- Shop Categories -->
                <div class="shop-categories mb-3">
                    <button class="btn btn-outline shop-category-btn active" data-category="all">
                        <i class="fas fa-th"></i> All Items
                    </button>
                    <button class="btn btn-outline shop-category-btn" data-category="badges">
                        <i class="fas fa-medal"></i> Badges
                    </button>
                    <button class="btn btn-outline shop-category-btn" data-category="features">
                        <i class="fas fa-star"></i> Features
                    </button>
                    <button class="btn btn-outline shop-category-btn" data-category="cosmetics">
                        <i class="fas fa-palette"></i> Cosmetics
                    </button>
                </div>

                <!-- Shop Items Grid -->
                <div class="grid grid-3 gap-md" id="shopItemsGrid">
                    <!-- Badge Items -->
                    <div class="card shop-item" data-category="badges">
                        <div class="card-body text-center">
                            <i class="fas fa-shield-alt text-gold" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Viking Warrior</h4>
                            <p class="text-muted text-sm">Show your dedication</p>
                            <div class="price-tag">
                                <span class="price text-gold">100 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseBadge('viking_warrior', 100)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="badges">
                        <div class="card-body text-center">
                            <i class="fas fa-crown text-gold" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Truth Seeker</h4>
                            <p class="text-muted text-sm">Elite truth warrior</p>
                            <div class="price-tag">
                                <span class="price text-gold">200 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseBadge('truth_seeker', 200)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="badges">
                        <div class="card-body text-center">
                            <i class="fas fa-fire text-peach" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Content Creator</h4>
                            <p class="text-muted text-sm">Premium creator badge</p>
                            <div class="price-tag">
                                <span class="price text-gold">150 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseBadge('content_creator', 150)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <!-- Feature Items -->
                    <div class="card shop-item" data-category="features">
                        <div class="card-body text-center">
                            <i class="fas fa-ad text-indigo" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Ad-Free Experience</h4>
                            <p class="text-muted text-sm">30 days no ads</p>
                            <div class="price-tag">
                                <span class="price text-gold">500 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseFeature('ad_free', 500)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="features">
                        <div class="card-body text-center">
                            <i class="fas fa-rocket text-peach" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Video Boost</h4>
                            <p class="text-muted text-sm">Featured for 1 hour</p>
                            <div class="price-tag">
                                <span class="price text-gold">50 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="showBoostVideoSelector()">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="features">
                        <div class="card-body text-center">
                            <i class="fas fa-star text-gold" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Highlight Comment</h4>
                            <p class="text-muted text-sm">Make it stand out</p>
                            <div class="price-tag">
                                <span class="price text-gold">20 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="showHighlightCommentSelector()">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <!-- Cosmetic Items -->
                    <div class="card shop-item" data-category="cosmetics">
                        <div class="card-body text-center">
                            <i class="fas fa-palette text-indigo" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Custom Profile Color</h4>
                            <p class="text-muted text-sm">Stand out everywhere</p>
                            <div class="price-tag">
                                <span class="price text-gold">100 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseCosmetic('profile_color', 100)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="cosmetics">
                        <div class="card-body text-center">
                            <i class="fas fa-comment-dots text-success" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Custom Username Color</h4>
                            <p class="text-muted text-sm">Unique display</p>
                            <div class="price-tag">
                                <span class="price text-gold">75 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseCosmetic('username_color', 75)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="cosmetics">
                        <div class="card-body text-center">
                            <i class="fas fa-image text-peach" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Profile Banner</h4>
                            <p class="text-muted text-sm">Custom header image</p>
                            <div class="price-tag">
                                <span class="price text-gold">150 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseCosmetic('profile_banner', 150)">
                                Purchase
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: var(--navy); color: var(--cream); padding: 3rem 0;">
        <div class="container">
            <div class="grid grid-3">
                <div>
                    <h4 style="color: var(--gold);">Much Love, No Fear</h4>
                    <p>A sanctuary for truth-seekers and free thinkers.</p>
                    <div class="flex gap-md" style="margin-top: 1rem;">
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-twitter"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-discord"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Quick Links</h5>
                    <ul style="list-style: none;">
                        <li><a href="pages/archive.html" style="color: var(--cream);">Love Vault</a></li>
                        <li><a href="pages/blog.html" style="color: var(--cream);">Blog</a></li>
                        <li><a href="pages/messageboard.html" style="color: var(--cream);">Message Board</a></li>
                        <li><a href="pages/donations.html" style="color: var(--cream);">Support Us</a></li>
                    </ul>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Community</h5>
                    <ul style="list-style: none;">
                        <li><a href="#" style="color: var(--cream);">Guidelines</a></li>
                        <li><a href="#" style="color: var(--cream);">Privacy Policy</a></li>
                        <li><a href="#" style="color: var(--cream);">Terms of Service</a></li>
                        <li><a href="#" style="color: var(--cream);">Contact</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="text-center" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <p>&copy; 2024 Much Love, No Fear. All rights reserved. Built with ❤️ and Viking spirit.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="api-client.js"></script>
    <script src="auth-handler.js"></script>
    <script src="mock-data.js"></script>
    <!-- Load scripts.js BEFORE page-loader.js so APIClient is defined -->
    <script src="scripts.js"></script>
    <script src="notifications.js"></script>
    <script src="page-loader.js"></script>
    
    <!-- Dashboard Real Data Loader -->
    <script>
        // Load real user data from API with proper loading states
        document.addEventListener('DOMContentLoaded', async function() {
            // Show loading indicators
            showLoadingState();

            try {
                // Fetch current user data from API
                const response = await APIClient.auth.getProfile();
                const user = response.user;

                console.log('✅ Dashboard - Loaded user data:', user);

                // Update Runegold balance
                const runegoldElements = document.querySelectorAll('.runegold-balance, .runegold-amount, #runegoldAmount');
                runegoldElements.forEach(el => {
                    animateNumber(el, 0, user.runegoldBalance || 0, 800);
                });

                // Update user stats from REAL data
                updateDashboardStats(user);

                // Load user's actual videos
                await loadUserVideos(user._id);

                // Load real activity feed
                await loadRecentActivity(user._id);

                // Hide loading indicators
                hideLoadingState();

            } catch (error) {
                console.error('❌ Error loading dashboard data:', error);
                hideLoadingState();

                // Show error message to user
                showNotification('Failed to load dashboard data. Please refresh the page.', 'error');

                // Fallback to localStorage data
                const userData = localStorage.getItem('mlnf_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    const runegoldElements = document.querySelectorAll('.runegold-balance, .runegold-amount, #runegoldAmount');
                    runegoldElements.forEach(el => {
                        el.textContent = user.runegoldBalance || 0;
                    });
                }
            }
        });

        // Update dashboard stats with real data
        function updateDashboardStats(user) {
            // Total Videos (from uploadedVideos array)
            const totalVideos = user.uploadedVideos ? user.uploadedVideos.length : 0;
            const totalVideosEl = document.getElementById('totalVideos');
            if (totalVideosEl) {
                animateNumber(totalVideosEl, 0, totalVideos, 600);
            }

            // Total Followers (from followers array)
            const totalFollowers = user.followers ? user.followers.length : 0;
            const totalFollowersEl = document.getElementById('totalFollowers');
            if (totalFollowersEl) {
                animateNumber(totalFollowersEl, 0, totalFollowers, 600);
            }

            // Calculate total views from user's videos
            let totalViews = 0;
            if (user.uploadedVideos && user.uploadedVideos.length > 0) {
                totalViews = user.uploadedVideos.reduce((sum, video) => sum + (video.views || 0), 0);
            }
            const totalViewsEl = document.getElementById('totalViews');
            if (totalViewsEl) {
                animateNumber(totalViewsEl, 0, totalViews, 800);
            }

            // Total Comments (would need separate API call in full implementation)
            // For now, show 0 or calculate from videos if comments are embedded
            const totalCommentsEl = document.getElementById('totalComments');
            if (totalCommentsEl) {
                totalCommentsEl.textContent = '0';
                totalCommentsEl.style.opacity = '0.5';
            }
        }

        // Animate number changes (smooth counting effect)
        function animateNumber(element, start, end, duration) {
            const startTime = performance.now();
            const range = end - start;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Easing function (ease-out)
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (range * easeOut));

                element.textContent = current.toLocaleString();

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        // Load user's actual videos
        async function loadUserVideos(userId) {
            const videosContainer = document.querySelector('.grid.grid-3');
            if (!videosContainer) return;

            // Clear placeholder videos
            videosContainer.innerHTML = '<div class="col-span-3 text-center" style="padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--indigo);"></i><p class="mt-2 text-muted">Loading your videos...</p></div>';

            try {
                // Fetch user's videos from API
                const response = await fetch(`${APIClient.auth.getProfile().then(r => r.user._id) === userId ? '/api' : 'https://much-love-no-fear.onrender.com/api'}/videos?userId=${userId}`);
                const data = await response.json();

                if (data.videos && data.videos.length > 0) {
                    // Clear loading message
                    videosContainer.innerHTML = '';

                    // Display up to 3 most recent videos
                    const recentVideos = data.videos.slice(0, 3);
                    recentVideos.forEach(video => {
                        const videoCard = createVideoCard(video);
                        videosContainer.appendChild(videoCard);
                    });
                } else {
                    // No videos uploaded yet
                    videosContainer.innerHTML = `
                        <div class="col-span-3 text-center" style="padding: 3rem;">
                            <i class="fas fa-video" style="font-size: 4rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                            <h4 style="color: var(--gray-600);">No videos yet</h4>
                            <p class="text-muted">Upload your first video to share with warriors!</p>
                            <button class="btn btn-viking mt-3">
                                <i class="fas fa-upload"></i> Upload Video
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading videos:', error);
                videosContainer.innerHTML = `
                    <div class="col-span-3 text-center text-error" style="padding: 2rem;">
                        <i class="fas fa-exclamation-triangle"></i> Failed to load videos
                    </div>
                `;
            }
        }

        // Create video card element
        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'video-card';

            const thumbnail = video.thumbnail || 'https://via.placeholder.com/320x180/333333/FFFFFF?text=Video';
            const isLive = video.status === 'live';

            card.innerHTML = `
                <div class="video-thumbnail" style="position: relative;">
                    <img src="${thumbnail}" alt="${video.title}" style="width: 100%; border-radius: var(--radius-md); aspect-ratio: 16/9; object-fit: cover;">
                    ${isLive ? '<span class="badge badge-error" style="position: absolute; top: 10px; right: 10px;">LIVE</span>' : ''}
                </div>
                <h5 class="mt-2" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${video.title}">${video.title}</h5>
                <div class="flex gap-md text-sm text-muted">
                    <span><i class="fas fa-eye"></i> ${formatNumber(video.views || 0)}</span>
                    <span><i class="fas fa-thumbs-up"></i> ${formatNumber(video.upvotes || 0)}</span>
                    <span><i class="fas fa-comment"></i> ${formatNumber(video.comments?.length || 0)}</span>
                </div>
            `;

            // Make clickable
            card.style.cursor = 'pointer';
            card.addEventListener('click', () => {
                window.location.href = `/pages/video.html?id=${video._id}`;
            });

            return card;
        }

        // Format large numbers (1000 -> 1k, 1000000 -> 1M)
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        // Load recent activity feed
        async function loadRecentActivity(userId) {
            const activityTimeline = document.querySelector('.activity-timeline');
            if (!activityTimeline) return;

            // Clear placeholder activity
            activityTimeline.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading activity...</div>';

            try {
                // In a full implementation, this would fetch from an activity/notifications endpoint
                // For now, we'll generate activity from user's actual data
                const response = await APIClient.auth.getProfile();
                const user = response.user;

                const activities = [];

                // Check if user has videos with views
                if (user.uploadedVideos && user.uploadedVideos.length > 0) {
                    const topVideo = user.uploadedVideos.reduce((prev, current) =>
                        (current.views > (prev?.views || 0)) ? current : prev
                    , null);

                    if (topVideo && topVideo.views > 0) {
                        activities.push({
                            icon: 'fa-video',
                            color: 'var(--success)',
                            text: `Your video "${topVideo.title}" has ${formatNumber(topVideo.views)} views!`,
                            time: 'Recently'
                        });
                    }
                }

                // Check if user has followers
                if (user.followers && user.followers.length > 0) {
                    const recentFollower = user.followers[user.followers.length - 1];
                    activities.push({
                        icon: 'fa-user-plus',
                        color: 'var(--peach)',
                        text: `<strong>${recentFollower.username}</strong> started following you`,
                        time: 'Recently'
                    });
                }

                // If user has Runegold
                if (user.runegoldBalance > 0) {
                    activities.push({
                        icon: 'fa-coins',
                        color: 'var(--gold)',
                        text: `Your Runegold balance: <strong>${user.runegoldBalance} RG</strong>`,
                        time: 'Current'
                    });
                }

                // Display activities or show empty state
                if (activities.length > 0) {
                    activityTimeline.innerHTML = activities.map(activity => `
                        <div class="activity-item">
                            <div class="activity-icon" style="background: ${activity.color};">
                                <i class="fas ${activity.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <p>${activity.text}</p>
                                <small class="text-muted">${activity.time}</small>
                            </div>
                        </div>
                    `).join('');
                } else {
                    activityTimeline.innerHTML = `
                        <div class="text-center text-muted" style="padding: 2rem;">
                            <i class="fas fa-history" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                            <p>No recent activity</p>
                            <small>Start uploading videos and engaging with the community!</small>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading activity:', error);
                activityTimeline.innerHTML = '<div class="text-center text-error">Failed to load activity</div>';
            }
        }

        // Loading state management
        function showLoadingState() {
            // Add shimmer effect to stat cards
            const statCards = document.querySelectorAll('.stat-card h3');
            statCards.forEach(stat => {
                stat.style.opacity = '0.3';
                stat.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            });
        }

        function hideLoadingState() {
            // Loading complete - stats will be populated by updateDashboardStats
        }
    </script>
    
    <!-- Dashboard specific styles -->
    <style>
        .dashboard-sidebar .dashboard-nav a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: var(--radius-md);
            margin-bottom: 0.25rem;
            transition: all var(--transition-base);
        }
        
        .dashboard-sidebar .dashboard-nav a:hover {
            background: var(--gray-50);
            color: var(--indigo);
        }
        
        .dashboard-sidebar .dashboard-nav a.active {
            background: var(--indigo);
            color: white;
        }
        
        .dashboard-sidebar .dashboard-nav a i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }
        
        .activity-timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gray-200);
        }
        
        .activity-item {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .activity-icon {
            position: absolute;
            left: -35px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .avatar-sm {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .avatar-lg {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            cursor: pointer;
        }
        
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            margin-top: 0.5rem;
            z-index: 100;
        }
        
        .user-menu-dropdown a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--gray-700);
            text-decoration: none;
            transition: background var(--transition-base);
        }
        
        .user-menu-dropdown a:hover {
            background: var(--gray-50);
        }
        
        .user-menu-dropdown a i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }

        /* Runegold Shop Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 1001;
            width: 90%;
            max-width: 900px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--gray-500);
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-close:hover {
            color: var(--error);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .shop-categories {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .shop-category-btn {
            min-width: 120px;
        }

        .shop-category-btn.active {
            background: var(--indigo);
            color: white;
            border-color: var(--indigo);
        }

        .shop-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .shop-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .price-tag {
            margin: 1rem 0;
        }

        .price {
            font-size: 1.5rem;
            font-weight: bold;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
    
    <!-- Dashboard JavaScript -->
    <script>
        // User menu toggle
        document.getElementById('userMenuToggle')?.addEventListener('click', function() {
            const dropdown = document.getElementById('userMenuDropdown');
            dropdown?.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('userMenuDropdown');
            if (userMenu && !userMenu.contains(e.target)) {
                dropdown?.classList.add('hidden');
            }
        });

        // Runegold Shop Functions
        function openRunegoldShop() {
            const modal = document.getElementById('runegoldShopModal');
            if (modal) {
                modal.style.display = 'flex';
                loadShopBalance();
            }
        }

        function closeRunegoldShop() {
            const modal = document.getElementById('runegoldShopModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadShopBalance() {
            try {
                const response = await APIClient.auth.getProfile();
                const balance = response.user.runegoldBalance || 0;
                const balanceEl = document.getElementById('shopRunegoldBalance');
                if (balanceEl) {
                    balanceEl.textContent = balance;
                }
            } catch (error) {
                console.error('Error loading balance:', error);
                // Fallback to localStorage
                const userData = localStorage.getItem('mlnf_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    const balanceEl = document.getElementById('shopRunegoldBalance');
                    if (balanceEl) {
                        balanceEl.textContent = user.runegoldBalance || 0;
                    }
                }
            }
        }

        // Shop Category Filtering
        document.querySelectorAll('.shop-category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('.shop-category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Filter items
                const category = this.dataset.category;
                const items = document.querySelectorAll('.shop-item');
                
                items.forEach(item => {
                    if (category === 'all' || item.dataset.category === category) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });

        // Purchase Badge
        async function purchaseBadge(badgeName, cost) {
            if (!MLNFAuth.isLoggedIn()) {
                showNotification('Please login to make purchases', 'error');
                return;
            }

            if (!confirm(`Purchase ${badgeName.replace('_', ' ')} badge for ${cost} Runegold?`)) {
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/runegold/spend/badge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify({ badgeName })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`Badge purchased! New balance: ${data.balance} RG`, 'success');
                    loadShopBalance();
                    // Update main dashboard balance too
                    const dashboardBalance = document.querySelectorAll('.runegold-balance, .runegold-amount');
                    dashboardBalance.forEach(el => el.textContent = data.balance);
                } else {
                    showNotification(data.error || 'Purchase failed', 'error');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showNotification('Failed to complete purchase', 'error');
            }
        }

        // Purchase Feature
        async function purchaseFeature(featureName, cost) {
            if (!MLNFAuth.isLoggedIn()) {
                showNotification('Please login to make purchases', 'error');
                return;
            }

            if (!confirm(`Purchase ${featureName.replace('_', ' ')} for ${cost} Runegold?`)) {
                return;
            }

            try {
                // For now, use badge endpoint (will create dedicated feature endpoint later)
                const response = await fetch('http://localhost:5000/api/runegold/spend/badge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify({ badgeName: featureName })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`Feature purchased! New balance: ${data.balance} RG`, 'success');
                    loadShopBalance();
                    const dashboardBalance = document.querySelectorAll('.runegold-balance, .runegold-amount');
                    dashboardBalance.forEach(el => el.textContent = data.balance);
                } else {
                    showNotification(data.error || 'Purchase failed', 'error');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showNotification('Failed to complete purchase', 'error');
            }
        }

        // Purchase Cosmetic
        async function purchaseCosmetic(cosmeticName, cost) {
            if (!MLNFAuth.isLoggedIn()) {
                showNotification('Please login to make purchases', 'error');
                return;
            }

            if (!confirm(`Purchase ${cosmeticName.replace('_', ' ')} for ${cost} Runegold?`)) {
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/runegold/spend/badge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify({ badgeName: cosmeticName })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`Cosmetic purchased! New balance: ${data.balance} RG`, 'success');
                    loadShopBalance();
                    const dashboardBalance = document.querySelectorAll('.runegold-balance, .runegold-amount');
                    dashboardBalance.forEach(el => el.textContent = data.balance);
                } else {
                    showNotification(data.error || 'Purchase failed', 'error');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showNotification('Failed to complete purchase', 'error');
            }
        }

        // Boost Video Selector (will implement later)
        function showBoostVideoSelector() {
            showNotification('Select a video from your videos to boost', 'info');
            // TODO: Show video selection modal
        }

        // Highlight Comment Selector (will implement later)
        function showHighlightCommentSelector() {
            showNotification('Go to a video and select a comment to highlight', 'info');
            // TODO: Show comment selection interface
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification notification-${type}`;
            notif.textContent = message;
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: var(--navy);
                color: white;
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            if (type === 'success') notif.style.background = 'var(--success)';
            if (type === 'error') notif.style.background = 'var(--error)';
            if (type === 'info') notif.style.background = 'var(--indigo)';
            
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 5000);
        }

        // Add click handlers to shop buttons in main dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Open shop when clicking "Get More Runegold" or shop links
            document.querySelectorAll('[href="#runegold"], .btn-viking').forEach(btn => {
                if (btn.textContent.includes('Get More Runegold') || btn.textContent.includes('Shop')) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        openRunegoldShop();
                    });
                }
            });

            // Open profile edit when clicking profile or settings links
            document.querySelectorAll('[href="#profile"], [href="#settings"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    openProfileEdit();
                });
            });

            // Bio character counter
            const bioTextarea = document.getElementById('editBio');
            const bioCharCount = document.getElementById('bioCharCount');
            if (bioTextarea && bioCharCount) {
                bioTextarea.addEventListener('input', function() {
                    bioCharCount.textContent = this.value.length;
                });
            }
        });

        // Profile Edit Functions
        async function openProfileEdit() {
            const modal = document.getElementById('profileEditModal');
            if (modal) {
                modal.style.display = 'flex';
                await loadProfileData();
            }
        }

        function closeProfileEdit() {
            const modal = document.getElementById('profileEditModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadProfileData() {
            try {
                const response = await APIClient.auth.getProfile();
                const user = response.user;
                
                // Populate form fields
                document.getElementById('editUsername').value = user.username || '';
                document.getElementById('editFirstName').value = user.firstName || '';
                document.getElementById('editLastName').value = user.lastName || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editBio').value = user.bio || '';
                document.getElementById('editTwitter').value = user.socialLinks?.twitter || '';
                document.getElementById('editYoutube').value = user.socialLinks?.youtube || '';
                document.getElementById('editTelegram').value = user.socialLinks?.telegram || '';
                document.getElementById('editWebsite').value = user.socialLinks?.website || '';
                document.getElementById('editLocation').value = user.location || '';
                document.getElementById('editPrivateProfile').checked = user.privateProfile || false;
                document.getElementById('editHideEmail').checked = user.hideEmail || false;
                
                // Update character count
                document.getElementById('bioCharCount').textContent = (user.bio || '').length;
                
                // Update avatar preview if exists
                if (user.avatar) {
                    document.getElementById('profileAvatarPreview').src = user.avatar;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                // Try localStorage fallback
                const userData = localStorage.getItem('mlnf_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    document.getElementById('editUsername').value = user.username || '';
                    document.getElementById('editEmail').value = user.email || '';
                }
            }
        }

        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showNotification('Avatar image must be less than 2MB', 'error');
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select an image file', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profileAvatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Handle profile edit form submission
        document.getElementById('profileEditForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!MLNFAuth.isLoggedIn()) {
                showNotification('Please login first', 'error');
                return;
            }

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;

            try {
                // Prepare profile data
                const profileData = {
                    firstName: document.getElementById('editFirstName').value.trim(),
                    lastName: document.getElementById('editLastName').value.trim(),
                    email: document.getElementById('editEmail').value.trim(),
                    bio: document.getElementById('editBio').value.trim(),
                    socialLinks: {
                        twitter: document.getElementById('editTwitter').value.trim(),
                        youtube: document.getElementById('editYoutube').value.trim(),
                        telegram: document.getElementById('editTelegram').value.trim(),
                        website: document.getElementById('editWebsite').value.trim()
                    },
                    location: document.getElementById('editLocation').value.trim(),
                    privateProfile: document.getElementById('editPrivateProfile').checked,
                    hideEmail: document.getElementById('editHideEmail').checked
                };

                // Handle avatar upload if file selected
                const avatarFile = document.getElementById('avatarUpload').files[0];
                if (avatarFile) {
                    // TODO: Upload avatar to backend
                    // For now, we'll use the base64 preview
                    const avatarPreview = document.getElementById('profileAvatarPreview').src;
                    if (avatarPreview && !avatarPreview.includes('placeholder')) {
                        profileData.avatar = avatarPreview;
                    }
                }

                // Send update to backend
                const response = await fetch('http://localhost:5000/api/auth/update-profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify(profileData)
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification('Profile updated successfully!', 'success');
                    
                    // Update localStorage
                    const currentUser = JSON.parse(localStorage.getItem('mlnf_user') || '{}');
                    const updatedUser = { ...currentUser, ...data.user };
                    localStorage.setItem('mlnf_user', JSON.stringify(updatedUser));
                    
                    // Update UI
                    document.querySelectorAll('.username-display').forEach(el => {
                        el.textContent = data.user.username;
                    });
                    
                    closeProfileEdit();
                } else {
                    showNotification(data.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showNotification('Failed to update profile. Please try again.', 'error');
            } finally {
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // ===== LIVESTREAMING FUNCTIONALITY =====

        let currentStream = null;
        let viewerCountInterval = null;

        // Dashboard Navigation
        document.querySelectorAll('.dashboard-nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();

                // Remove active class from all links
                document.querySelectorAll('.dashboard-nav a').forEach(l => l.classList.remove('active'));
                // Add active to clicked link
                link.classList.add('active');

                // Get section from href
                const section = link.getAttribute('href').substring(1); // Remove #

                // Hide all sections first
                document.getElementById('statsOverview').style.display = 'none';
                document.getElementById('livestreamSection')?.classList.add('hidden');
                document.getElementById('messagesSection')?.classList.add('hidden');

                // Show selected section
                if (section === 'overview') {
                    document.getElementById('statsOverview').style.display = 'grid';
                } else if (section === 'livestream') {
                    document.getElementById('livestreamSection')?.classList.remove('hidden');
                    loadUserStreams();
                } else if (section === 'messages') {
                    document.getElementById('messagesSection')?.classList.remove('hidden');
                    loadConversations();
                }
            });
        });

        // ===== MESSAGING FUNCTIONALITY =====

        let currentConversation = null;

        // Load user's conversations
        async function loadConversations() {
            const conversationsList = document.getElementById('conversationsList');
            if (!conversationsList) return;

            conversationsList.innerHTML = '<div class="text-center text-muted" style="padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading conversations...</div>';

            try {
                // In full implementation, this would fetch from /api/messages or similar
                // For now, show empty state
                conversationsList.innerHTML = `
                    <div class="text-center text-muted" style="padding: 3rem 1rem;">
                        <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>No conversations yet</p>
                        <small>Send a message to start chatting!</small>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading conversations:', error);
                conversationsList.innerHTML = '<div class="text-center text-error">Failed to load conversations</div>';
            }
        }

        // Open new message dialog
        function openNewMessage() {
            showNotification('Direct messaging coming soon! For now, connect with warriors in the Message Board.', 'info');
            // In full implementation, this would open a modal to select a user and start a conversation
        }

        // Open a conversation
        function openConversation(conversationId, username) {
            currentConversation = conversationId;

            // Show chat header and input
            document.getElementById('chatHeader')?.classList.remove('hidden');
            document.getElementById('messageInput')?.classList.remove('hidden');

            // Update chat header
            document.getElementById('chatUsername').textContent = username;

            // Load messages for this conversation
            loadMessages(conversationId);
        }

        // Load messages for a conversation
        async function loadMessages(conversationId) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            chatMessages.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';

            try {
                // In full implementation, fetch from /api/messages/{conversationId}
                // For now, show empty state
                chatMessages.innerHTML = `
                    <div class="text-center text-muted" style="padding: 2rem;">
                        <p>No messages yet. Say hi!</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading messages:', error);
                chatMessages.innerHTML = '<div class="text-center text-error">Failed to load messages</div>';
            }
        }

        // Close chat
        function closeChat() {
            currentConversation = null;
            document.getElementById('chatHeader')?.classList.add('hidden');
            document.getElementById('messageInput')?.classList.add('hidden');

            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div class="text-center text-muted" style="padding: 3rem 1rem;">
                        <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>Select a conversation to start chatting</p>
                    </div>
                `;
            }
        }

        // Send message
        document.getElementById('sendMessageForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const messageText = document.getElementById('messageText');
            if (!messageText || !messageText.value.trim()) return;

            const message = messageText.value.trim();

            try {
                // In full implementation, POST to /api/messages
                // For now, show notification
                showNotification('Direct messaging API coming soon!', 'info');

                // Clear input
                messageText.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message', 'error');
            }
        });

        // Conversation search
        document.getElementById('conversationSearch')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const conversations = document.querySelectorAll('.conversation-item');

            conversations.forEach(conv => {
                const username = conv.getAttribute('data-username')?.toLowerCase() || '';
                if (username.includes(searchTerm)) {
                    conv.style.display = 'flex';
                } else {
                    conv.style.display = 'none';
                }
            });
        });

        // Toggle OBS Guide
        function toggleOBSGuide() {
            const guide = document.getElementById('obsGuide');
            guide.classList.toggle('hidden');
        }

        // Create Stream Form
        document.getElementById('createStreamForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('streamTitle').value;
            const category = document.getElementById('streamCategory').value;
            const description = document.getElementById('streamDescription').value;

            try {
                const response = await fetch('/api/livestream/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ title, category, description })
                });

                const data = await response.json();

                if (response.ok) {
                    currentStream = data.stream;

                    // Show stream key
                    document.getElementById('streamKeyValue').value = data.stream.streamKey;
                    document.getElementById('streamKeyDisplay').classList.remove('hidden');

                    // Show OBS guide
                    document.getElementById('obsGuide').classList.remove('hidden');

                    showNotification('Stream created successfully! Copy your stream key and configure OBS.', 'success');

                    // Clear form
                    document.getElementById('createStreamForm').reset();
                } else {
                    showNotification(data.error || 'Failed to create stream', 'error');
                }
            } catch (error) {
                console.error('Create stream error:', error);
                showNotification('Failed to create stream. Please try again.', 'error');
            }
        });

        // Toggle Stream Key Visibility
        function toggleStreamKeyVisibility() {
            const keyInput = document.getElementById('streamKeyValue');
            const icon = document.getElementById('streamKeyToggleIcon');

            if (keyInput.type === 'password') {
                keyInput.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                keyInput.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Copy Stream Key
        async function copyStreamKey() {
            const keyInput = document.getElementById('streamKeyValue');

            try {
                await navigator.clipboard.writeText(keyInput.value);
                showNotification('Stream key copied to clipboard!', 'success');
            } catch (error) {
                // Fallback for older browsers
                keyInput.select();
                document.execCommand('copy');
                showNotification('Stream key copied!', 'success');
            }
        }

        // Go Live
        async function goLive() {
            if (!currentStream) {
                showNotification('No stream found. Please create a stream first.', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/livestream/${currentStream._id}/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Show live status banner
                    document.getElementById('liveStatusBanner').style.display = 'block';
                    document.getElementById('streamStartTime').textContent = 'just now';

                    // Hide Go Live button
                    document.getElementById('goLiveButton').disabled = true;
                    document.getElementById('goLiveButton').innerHTML = '<i class="fas fa-check-circle"></i> You\'re Live!';

                    showNotification('You\'re now live! Warriors can see your stream.', 'success');

                    // Start viewer count updates
                    updateViewerCount();
                    viewerCountInterval = setInterval(updateViewerCount, 10000); // Update every 10 seconds
                } else {
                    showNotification(data.error || 'Failed to go live', 'error');
                }
            } catch (error) {
                console.error('Go live error:', error);
                showNotification('Failed to go live. Make sure OBS is streaming first!', 'error');
            }
        }

        // End Stream
        async function endStream() {
            if (!currentStream) return;

            if (!confirm('Are you sure you want to end your stream?')) return;

            try {
                const response = await fetch(`/api/livestream/${currentStream._id}/end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Hide live status banner
                    document.getElementById('liveStatusBanner').style.display = 'none';

                    // Clear viewer count interval
                    if (viewerCountInterval) {
                        clearInterval(viewerCountInterval);
                        viewerCountInterval = null;
                    }

                    // Reset stream
                    currentStream = null;
                    document.getElementById('streamKeyDisplay').classList.add('hidden');
                    document.getElementById('goLiveButton').disabled = false;
                    document.getElementById('goLiveButton').innerHTML = '<i class="fas fa-play-circle"></i> ⚡ Go Live!';

                    showNotification('Stream ended successfully!', 'success');

                    // Reload streams list
                    loadUserStreams();
                } else {
                    showNotification(data.error || 'Failed to end stream', 'error');
                }
            } catch (error) {
                console.error('End stream error:', error);
                showNotification('Failed to end stream. Please try again.', 'error');
            }
        }

        // Update Viewer Count
        async function updateViewerCount() {
            if (!currentStream) return;

            try {
                const response = await fetch(`/api/livestream/${currentStream._id}`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('currentViewers').textContent = data.currentViewers || 0;

                    // Update stream start time
                    if (data.startedAt) {
                        const startTime = new Date(data.startedAt);
                        const now = new Date();
                        const diff = now - startTime;
                        const hours = Math.floor(diff / 3600000);
                        const minutes = Math.floor((diff % 3600000) / 60000);

                        if (hours > 0) {
                            document.getElementById('streamStartTime').textContent = `${hours}h ${minutes}m`;
                        } else {
                            document.getElementById('streamStartTime').textContent = `${minutes}m`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating viewer count:', error);
            }
        }

        // Load User Streams
        async function loadUserStreams() {
            try {
                const response = await fetch('/api/livestream/my-streams', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.streams && data.streams.length > 0) {
                    const streamsList = document.getElementById('userStreamsList');
                    streamsList.innerHTML = '';

                    data.streams.forEach(stream => {
                        const streamCard = document.createElement('div');
                        streamCard.className = 'card mb-2';
                        streamCard.style.border = stream.status === 'live' ? '2px solid var(--error)' : '';

                        streamCard.innerHTML = `
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div style="flex: 1;">
                                        <h5>${stream.title}</h5>
                                        <div class="flex gap-md text-sm text-muted" style="margin-top: 0.5rem;">
                                            <span><i class="fas fa-eye"></i> ${stream.peakViewers || 0} peak viewers</span>
                                            <span><i class="fas fa-coins text-gold"></i> ${stream.runegoldEarned || 0} RG earned</span>
                                            <span><i class="fas fa-calendar"></i> ${new Date(stream.createdAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <span class="badge ${stream.status === 'live' ? 'badge-error' : stream.status === 'ended' ? 'badge-secondary' : 'badge-warning'}">
                                            ${stream.status.toUpperCase()}
                                        </span>
                                        ${stream.status === 'ended' && stream.duration ? `
                                            <div class="text-sm text-muted" style="margin-top: 0.5rem;">
                                                Duration: ${Math.floor(stream.duration / 60)} min
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;

                        streamsList.appendChild(streamCard);
                    });
                }
            } catch (error) {
                console.error('Error loading streams:', error);
            }
        }
    </script>

    <!-- Socket.IO for real-time messaging -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- MLNF Dashboard Integration -->
    <script src="js/dashboard-api.js"></script>
    <script src="js/messaging.js"></script>
    <script src="js/dashboard-init.js"></script>
    <script src="js/site-enhancements.js"></script>
    <script src="js/mobile-viewport-handler.js"></script>
</body>
</html>