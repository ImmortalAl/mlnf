<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="User Dashboard - Much Love, No Fear">
    <title>Dashboard - Much Love, No Fear</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/dashboard-viking.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <div class="flex flex-between">
                <div class="site-logo">
                    <i class="fas fa-shield-alt site-logo-icon"></i>
                    <span>Much Love, No Fear</span>
                </div>
                
                <nav class="site-nav" id="mainNav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="pages/live.html" class="nav-link">Live</a>
                    <a href="pages/archive.html" class="nav-link">The Vault</a>
                    <a href="pages/blog.html" class="nav-link">Blog</a>
                    <a href="pages/news.html" class="nav-link">News</a>
                    <a href="pages/messageboard.html" class="nav-link">Board</a>
                    <a href="pages/donations.html" class="nav-link">Support</a>
                    <a href="pages/merch.html" class="nav-link">Merch</a>
                    <a href="dashboard.html" class="nav-link active" id="dashboardLink">Dashboard</a>
                    
                    <!-- Notification Bell -->
                    <div class="notification-bell" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">3</span>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="user-menu">
                        <button class="user-menu-toggle" id="userMenuToggle">
                            <img src="https://via.placeholder.com/150/4A90E2/FFFFFF?text=User" alt="User" class="avatar-sm user-avatar">
                            <span class="username-display">User</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="user-menu-dropdown hidden" id="userMenuDropdown">
                            <a href="#profile"><i class="fas fa-user"></i> Profile</a>
                            <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
                            <a href="#" onclick="MLNFAuth.logout(); return false;"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <button class="btn-icon" id="themeToggle" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </nav>
                
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Dashboard Content -->
    <section style="padding: 2rem 0;">
        <div class="container">
            <div class="grid" style="grid-template-columns: 250px 1fr; gap: 2rem;">
                <!-- Sidebar Navigation -->
                <aside class="dashboard-sidebar">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <img src="https://via.placeholder.com/150/4A90E2/FFFFFF?text=User" alt="User" class="avatar-lg mb-2 user-avatar">
                                <h4 class="username-display">User</h4>
                                <div class="badge badge-gold user-badge">New Viking</div>
                            </div>
                            
                            <div class="runegold-display mb-3" style="background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md);">
                                <div class="flex flex-between">
                                    <span>Runegold Balance</span>
                                    <strong style="color: var(--gold);" class="runegold-amount" id="sidebarRunegold">0</strong>
                                </div>
                            </div>
                            
                            <nav class="dashboard-nav">
                                <a href="#overview" class="active"><i class="fas fa-home"></i> Overview</a>
                                <a href="#livestream"><i class="fas fa-broadcast-tower"></i> Go Live</a>
                                <a href="#videos"><i class="fas fa-video"></i> My Videos</a>
                                <a href="#blog-posts"><i class="fas fa-pen"></i> Blog Posts</a>
                                <a href="#runegold"><i class="fas fa-coins"></i> Runegold Shop</a>
                                <a href="#messages"><i class="fas fa-envelope"></i> Messages</a>
                                <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
                                <a href="#badges"><i class="fas fa-medal"></i> Badges</a>
                                <a href="#subscription"><i class="fas fa-crown"></i> Subscription</a>
                            </nav>
                        </div>
                    </div>
                </aside>

                <!-- Main Dashboard Area -->
                <main>
                    <!-- Stats Overview -->
                    <div class="grid grid-4 mb-3" id="statsOverview">
                        <div class="card">
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div>
                                        <p class="text-muted text-sm">Total Views</p>
                                        <h3 id="totalViews">0</h3>
                                    </div>
                                    <i class="fas fa-eye text-indigo" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div>
                                        <p class="text-muted text-sm">Followers</p>
                                        <h3 id="totalFollowers">0</h3>
                                    </div>
                                    <i class="fas fa-users text-peach" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div>
                                        <p class="text-muted text-sm">Videos</p>
                                        <h3 id="totalVideos">0</h3>
                                    </div>
                                    <i class="fas fa-video text-gold" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div>
                                        <p class="text-muted text-sm">Comments</p>
                                        <h3 id="totalComments">0</h3>
                                    </div>
                                    <i class="fas fa-comments text-success" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Creator Studio - Livestreaming Section (hidden by default) -->
                    <div id="livestreamSection" class="hidden">
                        <!-- Live Status Banner - Enhanced -->
                        <div class="card mb-3" id="liveStatusBanner" style="display: none; background: linear-gradient(135deg, var(--error) 0%, var(--peach) 100%); color: white; border: none; box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4); position: relative; overflow: hidden;">
                            <!-- Animated background effect -->
                            <div style="position: absolute; top: 0; right: 0; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); opacity: 0.5;"></div>

                            <div class="card-body" style="position: relative; z-index: 1;">
                                <div class="flex flex-between" style="align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div>
                                        <h3 style="color: white; margin: 0; font-size: 1.75rem;">
                                            <i class="fas fa-circle" style="animation: pulse-live 2s infinite; margin-right: 0.5rem;"></i>
                                            You're Live!
                                        </h3>
                                        <p style="margin: 0.5rem 0 0; opacity: 0.95; font-size: 1rem;" id="liveStreamTitle">
                                            Streaming now...
                                        </p>
                                    </div>
                                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                        <!-- Live Stats Cards -->
                                        <div style="display: flex; gap: 0.75rem;">
                                            <div style="text-align: center; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 0.75rem 1rem; border-radius: var(--radius-md); min-width: 80px;">
                                                <div style="font-size: 1.5rem; font-weight: 800; line-height: 1;">
                                                    <span id="currentViewers">0</span>
                                                </div>
                                                <div style="font-size: 0.7rem; opacity: 0.9; margin-top: 0.25rem;">
                                                    <i class="fas fa-users"></i> Viewers
                                                </div>
                                            </div>
                                            <div style="text-align: center; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 0.75rem 1rem; border-radius: var(--radius-md); min-width: 80px;">
                                                <div style="font-size: 1.5rem; font-weight: 800; line-height: 1;">
                                                    <span id="peakViewers">0</span>
                                                </div>
                                                <div style="font-size: 0.7rem; opacity: 0.9; margin-top: 0.25rem;">
                                                    <i class="fas fa-chart-line"></i> Peak
                                                </div>
                                            </div>
                                            <div style="text-align: center; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 0.75rem 1rem; border-radius: var(--radius-md); min-width: 80px;">
                                                <div style="font-size: 1.5rem; font-weight: 800; line-height: 1;">
                                                    <span id="streamStartTime">0:00</span>
                                                </div>
                                                <div style="font-size: 0.7rem; opacity: 0.9; margin-top: 0.25rem;">
                                                    <i class="fas fa-clock"></i> Duration
                                                </div>
                                            </div>
                                            <div style="text-align: center; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 0.75rem 1rem; border-radius: var(--radius-md); min-width: 80px;">
                                                <div style="font-size: 1.5rem; font-weight: 800; line-height: 1; color: var(--gold);">
                                                    <span id="liveRunegold">0</span>
                                                </div>
                                                <div style="font-size: 0.7rem; opacity: 0.9; margin-top: 0.25rem;">
                                                    <i class="fas fa-coins"></i> Earned
                                                </div>
                                            </div>
                                        </div>
                                        <!-- End stream button -->
                                        <button class="btn" style="background: white; color: var(--error); font-weight: 700; padding: 0.75rem 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2);" onclick="endStream()">
                                            <i class="fas fa-stop-circle"></i> End Stream
                                        </button>
                                    </div>
                                </div>

                                <!-- Stream Health Indicator -->
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2);">
                                    <div class="flex flex-between" style="align-items: center;">
                                        <div class="flex gap-md" style="align-items: center;">
                                            <span style="font-size: 0.875rem;"><i class="fas fa-signal"></i> Stream Health:</span>
                                            <span id="streamHealth" style="background: var(--success); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700;">
                                                <i class="fas fa-check-circle"></i> Excellent
                                            </span>
                                            <span style="font-size: 0.75rem; opacity: 0.8;" id="streamBitrate">-- kbps</span>
                                        </div>
                                        <div class="flex gap-sm">
                                            <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: none;" onclick="openStreamChat()">
                                                <i class="fas fa-comments"></i> Chat
                                            </button>
                                            <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: none;" onclick="copyStreamLink()">
                                                <i class="fas fa-share-alt"></i> Share
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stream Preview (when live) -->
                        <div class="card mb-3" id="streamPreviewCard" style="display: none;">
                            <div class="card-body">
                                <h4 class="mb-2"><i class="fas fa-tv"></i> Stream Preview</h4>
                                <div id="streamPreview" style="background: #000; border-radius: var(--radius-md); overflow: hidden; aspect-ratio: 16/9; position: relative;">
                                    <video id="previewPlayer" style="width: 100%; height: 100%; object-fit: contain;" autoplay muted></video>
                                    <div style="position: absolute; top: 10px; left: 10px; background: var(--error); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">
                                        <i class="fas fa-circle" style="animation: pulse-live 1s infinite;"></i> LIVE
                                    </div>
                                </div>
                                <p class="text-sm text-muted mt-2"><i class="fas fa-info-circle"></i> This is how viewers see your stream</p>
                            </div>
                        </div>

                        <!-- Create New Stream -->
                        <div class="card mb-3" style="border: 2px solid var(--gold); box-shadow: var(--shadow-viking);">
                            <div class="card-body">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--gray-200);">
                                    <div>
                                        <h3 style="margin: 0; color: var(--navy);"><i class="fas fa-broadcast-tower text-gold"></i> Creator Studio</h3>
                                        <p style="margin: 0.5rem 0 0; color: var(--gray-600); font-size: 0.9375rem;">Prepare your stream for the warriors</p>
                                    </div>
                                    <div style="background: linear-gradient(135deg, var(--gold) 0%, #C4A035 100%); color: var(--navy); padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; font-size: 0.875rem;">
                                        <i class="fas fa-shield-alt"></i> Ready to Broadcast
                                    </div>
                                </div>

                                <form id="createStreamForm" class="mb-3">
                                    <!-- Row 1: Title and Category -->
                                    <div class="grid grid-2 gap-md mb-3">
                                        <div class="form-group">
                                            <label for="streamTitle">Stream Title *</label>
                                            <input type="text" id="streamTitle" class="form-control" placeholder="Enter an engaging title..." maxlength="100" required>
                                            <small class="text-muted">Make it descriptive so warriors know what to expect</small>
                                        </div>

                                        <div class="form-group">
                                            <label for="streamCategory">Category</label>
                                            <select id="streamCategory" class="form-control">
                                                <option value="General">General</option>
                                                <option value="Politics">Politics & News</option>
                                                <option value="Health">Health & Wellness</option>
                                                <option value="Finance">Finance & Economics</option>
                                                <option value="Tech">Technology</option>
                                                <option value="Spirituality">Spirituality</option>
                                                <option value="Education">Education</option>
                                                <option value="Entertainment">Entertainment</option>
                                                <option value="Gaming">Gaming</option>
                                                <option value="Music">Music</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Row 2: Thumbnail and Tags -->
                                    <div class="grid grid-2 gap-md mb-3">
                                        <div class="form-group">
                                            <label>Stream Thumbnail</label>
                                            <div style="display: flex; gap: 1rem; align-items: center;">
                                                <div id="thumbnailPreview" style="width: 160px; height: 90px; background: var(--gray-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px dashed var(--gray-300);">
                                                    <span class="text-muted text-sm"><i class="fas fa-image"></i> No image</span>
                                                </div>
                                                <div>
                                                    <input type="file" id="streamThumbnail" accept="image/*" style="display: none;" onchange="previewThumbnail(this)">
                                                    <button type="button" class="btn btn-sm btn-outline" onclick="document.getElementById('streamThumbnail').click()">
                                                        <i class="fas fa-upload"></i> Upload
                                                    </button>
                                                    <p class="text-muted text-sm mt-1">16:9 ratio, max 2MB</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="streamTags">Tags</label>
                                            <input type="text" id="streamTags" class="form-control" placeholder="truth, freedom, awakening (comma separated)">
                                            <small class="text-muted">Help warriors find your stream</small>
                                        </div>
                                    </div>

                                    <!-- Row 3: Description -->
                                    <div class="form-group mb-3">
                                        <label for="streamDescription">Description</label>
                                        <textarea id="streamDescription" class="form-control" rows="3" placeholder="What will you be discussing? Add links, resources, or talking points..." maxlength="2000"></textarea>
                                    </div>

                                    <!-- Row 4: Stream Settings -->
                                    <div class="grid grid-3 gap-md mb-3" style="background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md);">
                                        <div class="form-group" style="margin: 0;">
                                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                                <input type="checkbox" id="streamChatEnabled" checked style="width: 18px; height: 18px;">
                                                <span><i class="fas fa-comments text-indigo"></i> Enable Chat</span>
                                            </label>
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                                <input type="checkbox" id="streamNotifyFollowers" checked style="width: 18px; height: 18px;">
                                                <span><i class="fas fa-bell text-gold"></i> Notify Followers</span>
                                            </label>
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                                <input type="checkbox" id="streamSaveVOD" checked style="width: 18px; height: 18px;">
                                                <span><i class="fas fa-archive text-peach"></i> Save Recording</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Pre-Stream Checklist -->
                                    <div id="preStreamChecklist" style="background: linear-gradient(135deg, var(--cream), #fff); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; border: 1px solid var(--gold);">
                                        <h5 style="margin-bottom: 0.75rem; color: var(--navy);"><i class="fas fa-clipboard-check text-gold"></i> Pre-Stream Checklist</h5>
                                        <div class="grid grid-2 gap-sm">
                                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                                                <input type="checkbox" class="checklist-item" style="width: 16px; height: 16px;">
                                                <span>Audio levels tested</span>
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                                                <input type="checkbox" class="checklist-item" style="width: 16px; height: 16px;">
                                                <span>Camera/screen share ready</span>
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                                                <input type="checkbox" class="checklist-item" style="width: 16px; height: 16px;">
                                                <span>OBS scenes configured</span>
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                                                <input type="checkbox" class="checklist-item" style="width: 16px; height: 16px;">
                                                <span>Notifications silenced</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="flex gap-md" style="flex-wrap: wrap;">
                                        <button type="submit" class="btn btn-viking">
                                            <i class="fas fa-plus-circle"></i> Create Stream & Get Key
                                        </button>
                                        <button type="button" class="btn btn-outline" onclick="toggleOBSGuide()">
                                            <i class="fas fa-question-circle"></i> OBS Setup Guide
                                        </button>
                                        <button type="button" class="btn btn-outline" onclick="toggleScheduleStream()">
                                            <i class="fas fa-calendar-alt"></i> Schedule for Later
                                        </button>
                                    </div>
                                </form>

                                <!-- Schedule Stream Panel (hidden by default) -->
                                <div id="scheduleStreamPanel" class="hidden" style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-md); margin-top: 1rem;">
                                    <h4 class="mb-2"><i class="fas fa-calendar-alt text-indigo"></i> Schedule Your Stream</h4>
                                    <div class="grid grid-2 gap-md mb-3">
                                        <div class="form-group">
                                            <label for="scheduleDate">Date</label>
                                            <input type="date" id="scheduleDate" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label for="scheduleTime">Time</label>
                                            <input type="time" id="scheduleTime" class="form-control">
                                        </div>
                                    </div>
                                    <p class="text-sm text-muted mb-2"><i class="fas fa-info-circle"></i> Followers will be notified before your scheduled stream</p>
                                    <button type="button" class="btn btn-viking" onclick="scheduleStream()">
                                        <i class="fas fa-clock"></i> Schedule Stream
                                    </button>
                                </div>

                                <!-- OBS Setup Guide (collapsed by default) -->
                                <div id="obsGuide" class="hidden" style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-md); margin-top: 1rem;">
                                    <h4 class="mb-2"><i class="fas fa-desktop"></i> How to Stream with OBS</h4>
                                    <ol style="line-height: 1.8;">
                                        <li>Create your stream above to get your unique stream key</li>
                                        <li>Open OBS Studio (Download from <a href="https://obsproject.com/" target="_blank">obsproject.com</a>)</li>
                                        <li>Go to <strong>Settings → Stream</strong></li>
                                        <li>Service: <strong>Custom</strong></li>
                                        <li>Server: <code style="background: var(--gray-100); padding: 0.25rem 0.5rem; border-radius: 4px;">rtmp://150.136.140.253:1935/live</code></li>
                                        <li>Stream Key: <strong>Paste your key from below</strong></li>
                                        <li>Click "Start Streaming" in OBS</li>
                                        <li>Come back here and click "Go Live" to make your stream visible to warriors!</li>
                                    </ol>
                                    <div style="margin-top: 1rem; padding: 1rem; background: var(--indigo); color: white; border-radius: var(--radius-md);">
                                        <strong><i class="fas fa-shield-alt"></i> Pro Tip:</strong> Test your stream settings before going live. Recommended bitrate: 3500-6000 Kbps for 1080p.
                                    </div>
                                </div>

                                <!-- Stream Key Display (appears after creating stream) -->
                                <div id="streamKeyDisplay" class="hidden" style="background: linear-gradient(135deg, var(--navy), var(--indigo)); color: white; padding: 1.5rem; border-radius: var(--radius-md); margin-top: 1rem;">
                                    <h4 style="color: var(--gold); margin-bottom: 1rem;"><i class="fas fa-key"></i> Your Stream Key</h4>
                                    <div class="flex gap-md" style="align-items: center;">
                                        <input type="password" id="streamKeyValue" class="form-control" style="flex: 1; font-family: monospace; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white;" readonly>
                                        <button class="btn" style="background: var(--gold); color: var(--navy);" onclick="toggleStreamKeyVisibility()">
                                            <i class="fas fa-eye" id="streamKeyToggleIcon"></i>
                                        </button>
                                        <button class="btn" style="background: var(--peach); color: white;" onclick="copyStreamKey()">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                    </div>
                                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: var(--radius-md);">
                                        <strong style="color: var(--gold);"><i class="fas fa-exclamation-triangle"></i> Keep this secret!</strong> Anyone with your stream key can broadcast to your channel.
                                    </div>
                                    <div style="margin-top: 1rem;">
                                        <button class="btn btn-viking" onclick="goLive()" id="goLiveButton">
                                            <i class="fas fa-play-circle"></i> ⚡ Go Live!
                                        </button>
                                        <small style="display: block; margin-top: 0.5rem; opacity: 0.8;">Make sure OBS is streaming before clicking this!</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Your Streams -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h3 class="mb-3"><i class="fas fa-history"></i> Your Streams</h3>
                                <div id="userStreamsList">
                                    <div class="text-center text-muted" style="padding: 2rem;">
                                        <i class="fas fa-broadcast-tower" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                        <p>No streams yet. Create your first stream above!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <h3 class="mb-3">Recent Activity</h3>
                            <div class="activity-timeline">
                                <!-- Activity items loaded dynamically -->
                                <div class="text-center text-muted" style="padding: 2rem;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                    <p>Loading activity...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Section (instant messaging) -->
                    <div id="messagesSection" class="hidden">
                        <!-- Messages Header -->
                        <div class="card mb-3" style="background: linear-gradient(135deg, var(--indigo), var(--navy)); color: white; border: none;">
                            <div class="card-body">
                                <div class="flex flex-between" style="align-items: center;">
                                    <div>
                                        <h3 style="color: white; margin: 0;"><i class="fas fa-envelope"></i> Messages</h3>
                                        <p style="margin: 0.5rem 0 0; opacity: 0.9;">Connect directly with warriors</p>
                                    </div>
                                    <button class="btn" style="background: var(--gold); color: var(--navy);" onclick="openNewMessage()">
                                        <i class="fas fa-plus-circle"></i> New Message
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Interface -->
                        <div class="grid grid-2 gap-md" style="min-height: 600px;">
                            <!-- Conversations List -->
                            <div class="card">
                                <div class="card-body" style="padding: 0;">
                                    <div style="padding: 1rem; border-bottom: 2px solid var(--gray-200);">
                                        <input type="search" class="form-control" placeholder="Search conversations..." id="conversationSearch" style="border-radius: 20px;">
                                    </div>

                                    <div id="conversationsList" style="max-height: 500px; overflow-y: auto;">
                                        <!-- Conversations will be loaded here -->
                                        <div class="text-center text-muted" style="padding: 3rem 1rem;">
                                            <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                            <p>No conversations yet</p>
                                            <small>Send a message to start chatting!</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Window -->
                            <div class="card">
                                <div class="card-body" style="padding: 0; display: flex; flex-direction: column; height: 600px;">
                                    <!-- Chat Header -->
                                    <div id="chatHeader" class="hidden" style="padding: 1rem; border-bottom: 2px solid var(--gray-200); background: var(--gray-50);">
                                        <div class="flex gap-md" style="align-items: center;">
                                            <div class="thread-avatar" style="width: 40px; height: 40px; font-size: 1rem;">
                                                U
                                            </div>
                                            <div style="flex: 1;">
                                                <h5 style="margin: 0;" id="chatUsername">Username</h5>
                                                <small class="text-muted" id="chatStatus">Online</small>
                                            </div>
                                            <button class="btn btn-sm btn-outline" onclick="closeChat()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Chat Messages -->
                                    <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 1.5rem; background: white;">
                                        <div class="text-center text-muted" style="padding: 3rem 1rem;">
                                            <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                            <p>Select a conversation to start chatting</p>
                                        </div>
                                    </div>

                                    <!-- Message Input -->
                                    <div id="messageInput" class="hidden" style="padding: 1rem; border-top: 2px solid var(--gray-200); background: var(--gray-50);">
                                        <form id="sendMessageForm" class="flex gap-md" style="align-items: center;">
                                            <input type="text" class="form-control" placeholder="Type a message..." id="messageText" required style="flex: 1; border-radius: 20px;">
                                            <button type="submit" class="btn btn-viking" style="border-radius: 50%; width: 48px; height: 48px; padding: 0;">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Your Videos Section -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="flex flex-between mb-3">
                                <h3>Your Videos</h3>
                                <button class="btn btn-viking btn-sm">
                                    <i class="fas fa-upload"></i> Upload New
                                </button>
                            </div>

                            <div class="grid grid-3" id="yourVideosGrid">
                                <!-- Videos loaded dynamically -->
                                <div class="col-span-3 text-center" style="padding: 2rem;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--indigo);"></i>
                                    <p class="mt-2 text-muted">Loading your videos...</p>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <a href="#" class="btn btn-outline">View All Videos</a>
                            </div>
                        </div>
                    </div>

                    <!-- Runegold Shop -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <h3 class="mb-3">
                                <i class="fas fa-coins text-gold"></i> Runegold Shop
                            </h3>
                            <p class="text-muted mb-3">Use your Runegold to boost videos, highlight comments, and get exclusive perks!</p>
                            
                            <div class="grid grid-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-rocket text-peach" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                        <h5>Video Boost</h5>
                                        <p class="text-muted text-sm">Promote your video</p>
                                        <div class="price text-gold">100 RG</div>
                                        <button class="btn btn-sm btn-outline mt-2">Purchase</button>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-star text-gold" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                        <h5>Pin Comment</h5>
                                        <p class="text-muted text-sm">Highlight your message</p>
                                        <div class="price text-gold">50 RG</div>
                                        <button class="btn btn-sm btn-outline mt-2">Purchase</button>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-badge text-indigo" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                        <h5>Custom Badge</h5>
                                        <p class="text-muted text-sm">Stand out in comments</p>
                                        <div class="price text-gold">200 RG</div>
                                        <button class="btn btn-sm btn-outline mt-2">Purchase</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <button class="btn btn-viking">
                                    <i class="fas fa-plus-circle"></i> Get More Runegold
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Goal Section -->
                    <div class="card mb-3" id="monthlyGoalSection">
                        <div class="card-body">
                            <div class="flex flex-between mb-3">
                                <h3><i class="fas fa-bullseye text-peach"></i> Monthly Goal</h3>
                                <button class="btn btn-sm btn-outline" onclick="editMonthlyGoal()">
                                    <i class="fas fa-edit"></i> Edit Goal
                                </button>
                            </div>

                            <div class="monthly-goal-display" id="monthlyGoalDisplay">
                                <!-- Goal will be loaded dynamically -->
                                <div class="goal-card" style="background: linear-gradient(135deg, var(--navy) 0%, var(--indigo) 100%); color: white; padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 1rem;">
                                    <div class="flex flex-between" style="align-items: center;">
                                        <div>
                                            <p style="opacity: 0.8; font-size: 0.875rem; margin-bottom: 0.25rem;">Current Goal</p>
                                            <h4 style="color: var(--gold); margin: 0;" id="goalTitle">Upload 10 videos this month</h4>
                                        </div>
                                        <div style="text-align: center; min-width: 80px;">
                                            <div style="font-size: 2rem; font-weight: 800; color: var(--gold);" id="goalProgress">3/10</div>
                                            <p style="opacity: 0.8; font-size: 0.75rem; margin: 0;">Progress</p>
                                        </div>
                                    </div>

                                    <!-- Progress Bar -->
                                    <div style="margin-top: 1rem; background: rgba(255,255,255,0.2); height: 12px; border-radius: 6px; overflow: hidden;">
                                        <div id="goalProgressBar" style="height: 100%; background: linear-gradient(90deg, var(--gold), var(--peach)); width: 30%; transition: width 0.5s ease; border-radius: 6px;"></div>
                                    </div>

                                    <div class="flex flex-between" style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.8;">
                                        <span id="goalDaysLeft">15 days remaining</span>
                                        <span id="goalPercentage">30% complete</span>
                                    </div>
                                </div>

                                <!-- Goal Milestones -->
                                <div class="grid grid-3 gap-md">
                                    <div class="milestone-card" style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-md); border: 2px solid var(--success);">
                                        <i class="fas fa-check-circle text-success" style="font-size: 1.5rem;"></i>
                                        <p style="margin: 0.5rem 0 0; font-size: 0.875rem; font-weight: 600;">First Video</p>
                                        <small class="text-muted">Completed</small>
                                    </div>
                                    <div class="milestone-card" style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-md); border: 2px dashed var(--gray-300);">
                                        <i class="fas fa-circle text-gray" style="font-size: 1.5rem; opacity: 0.3;"></i>
                                        <p style="margin: 0.5rem 0 0; font-size: 0.875rem; font-weight: 600;">5 Videos</p>
                                        <small class="text-muted">50 RG reward</small>
                                    </div>
                                    <div class="milestone-card" style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-md); border: 2px dashed var(--gray-300);">
                                        <i class="fas fa-trophy text-gold" style="font-size: 1.5rem; opacity: 0.3;"></i>
                                        <p style="margin: 0.5rem 0 0; font-size: 0.875rem; font-weight: 600;">Goal Complete</p>
                                        <small class="text-muted">100 RG + badge</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State (shown when no goal set) -->
                            <div class="goal-empty-state hidden" id="goalEmptyState" style="text-align: center; padding: 2rem;">
                                <i class="fas fa-bullseye" style="font-size: 3rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                                <h4 style="color: var(--gray-600);">No Goal Set</h4>
                                <p class="text-muted">Set a monthly goal to stay motivated and earn Runegold!</p>
                                <button class="btn btn-viking mt-2" onclick="editMonthlyGoal()">
                                    <i class="fas fa-plus-circle"></i> Set Your First Goal
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hall of Vikings (Community Leaderboard) -->
                    <div class="card mb-3" id="hallOfVikingsSection">
                        <div class="card-body">
                            <div class="flex flex-between mb-3">
                                <h3><i class="fas fa-crown text-gold"></i> Hall of Vikings</h3>
                                <div class="flex gap-sm">
                                    <button class="btn btn-sm btn-outline active" data-leaderboard="weekly" onclick="switchLeaderboard('weekly')">This Week</button>
                                    <button class="btn btn-sm btn-outline" data-leaderboard="monthly" onclick="switchLeaderboard('monthly')">This Month</button>
                                    <button class="btn btn-sm btn-outline" data-leaderboard="alltime" onclick="switchLeaderboard('alltime')">All Time</button>
                                </div>
                            </div>

                            <!-- Top 3 Podium -->
                            <div class="podium-display" style="display: flex; justify-content: center; align-items: flex-end; gap: 1rem; margin-bottom: 2rem; padding: 1rem 0;">
                                <!-- 2nd Place -->
                                <div class="podium-place" style="text-align: center; width: 120px;">
                                    <img src="https://via.placeholder.com/60/C0C0C0/FFFFFF?text=2" alt="2nd" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #C0C0C0; margin-bottom: 0.5rem;" id="vikingAvatar2">
                                    <p style="font-weight: 600; margin: 0; font-size: 0.875rem;" id="vikingName2">SilverWarrior</p>
                                    <p style="color: var(--gold); font-weight: 700; margin: 0; font-size: 0.875rem;" id="vikingScore2">12,450 pts</p>
                                    <div style="background: linear-gradient(180deg, #C0C0C0, #A8A8A8); height: 60px; border-radius: 8px 8px 0 0; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 1.5rem; font-weight: 800; color: white;">2</span>
                                    </div>
                                </div>

                                <!-- 1st Place -->
                                <div class="podium-place" style="text-align: center; width: 140px;">
                                    <i class="fas fa-crown" style="color: var(--gold); font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                    <img src="https://via.placeholder.com/80/FFD700/FFFFFF?text=1" alt="1st" style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--gold); box-shadow: 0 0 20px rgba(212, 175, 55, 0.5); margin-bottom: 0.5rem;" id="vikingAvatar1">
                                    <p style="font-weight: 700; margin: 0; font-size: 1rem;" id="vikingName1">TruthSeeker99</p>
                                    <p style="color: var(--gold); font-weight: 800; margin: 0; font-size: 1rem;" id="vikingScore1">18,720 pts</p>
                                    <div style="background: linear-gradient(180deg, var(--gold), #C4A035); height: 80px; border-radius: 8px 8px 0 0; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 2rem; font-weight: 800; color: white;">1</span>
                                    </div>
                                </div>

                                <!-- 3rd Place -->
                                <div class="podium-place" style="text-align: center; width: 120px;">
                                    <img src="https://via.placeholder.com/60/CD7F32/FFFFFF?text=3" alt="3rd" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #CD7F32; margin-bottom: 0.5rem;" id="vikingAvatar3">
                                    <p style="font-weight: 600; margin: 0; font-size: 0.875rem;" id="vikingName3">BronzeKnight</p>
                                    <p style="color: var(--gold); font-weight: 700; margin: 0; font-size: 0.875rem;" id="vikingScore3">9,830 pts</p>
                                    <div style="background: linear-gradient(180deg, #CD7F32, #A66A2A); height: 40px; border-radius: 8px 8px 0 0; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 1.5rem; font-weight: 800; color: white;">3</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Rest of Leaderboard -->
                            <div class="leaderboard-list" id="leaderboardList">
                                <div class="leaderboard-item flex flex-between" style="padding: 0.75rem 1rem; background: var(--gray-50); border-radius: var(--radius-md); margin-bottom: 0.5rem;">
                                    <div class="flex gap-md" style="align-items: center;">
                                        <span style="font-weight: 700; width: 30px; color: var(--gray-600);">4</span>
                                        <img src="https://via.placeholder.com/40/4A90E2/FFFFFF?text=U" alt="User" style="width: 40px; height: 40px; border-radius: 50%;">
                                        <div>
                                            <p style="margin: 0; font-weight: 600;">FreedomFighter</p>
                                            <small class="text-muted">Level 12 Warrior</small>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="margin: 0; font-weight: 700; color: var(--gold);">7,650 pts</p>
                                        <small class="text-success"><i class="fas fa-arrow-up"></i> +450</small>
                                    </div>
                                </div>

                                <div class="leaderboard-item flex flex-between" style="padding: 0.75rem 1rem; background: var(--gray-50); border-radius: var(--radius-md); margin-bottom: 0.5rem;">
                                    <div class="flex gap-md" style="align-items: center;">
                                        <span style="font-weight: 700; width: 30px; color: var(--gray-600);">5</span>
                                        <img src="https://via.placeholder.com/40/E24A90/FFFFFF?text=U" alt="User" style="width: 40px; height: 40px; border-radius: 50%;">
                                        <div>
                                            <p style="margin: 0; font-weight: 600;">LightWorker</p>
                                            <small class="text-muted">Level 10 Warrior</small>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="margin: 0; font-weight: 700; color: var(--gold);">6,230 pts</p>
                                        <small class="text-success"><i class="fas fa-arrow-up"></i> +120</small>
                                    </div>
                                </div>

                                <!-- Your Rank -->
                                <div class="leaderboard-item flex flex-between" style="padding: 0.75rem 1rem; background: linear-gradient(135deg, var(--indigo), var(--navy)); color: white; border-radius: var(--radius-md); margin-top: 1rem; border: 2px solid var(--gold);">
                                    <div class="flex gap-md" style="align-items: center;">
                                        <span style="font-weight: 700; width: 30px;" id="yourRank">42</span>
                                        <img src="https://via.placeholder.com/40/4A90E2/FFFFFF?text=You" alt="You" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--gold);" id="yourAvatar">
                                        <div>
                                            <p style="margin: 0; font-weight: 600;">You</p>
                                            <small style="opacity: 0.8;">Keep climbing!</small>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="margin: 0; font-weight: 700; color: var(--gold);" id="yourScore">1,250 pts</p>
                                        <small style="opacity: 0.8;"><i class="fas fa-arrow-up"></i> +50</small>
                                    </div>
                                </div>
                            </div>

                            <!-- How Points Work -->
                            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-md);">
                                <h5 style="margin-bottom: 0.5rem;"><i class="fas fa-info-circle text-indigo"></i> How to Earn Points</h5>
                                <div class="grid grid-4 gap-sm" style="font-size: 0.75rem;">
                                    <div><i class="fas fa-video text-gold"></i> Upload Video: +50</div>
                                    <div><i class="fas fa-comment text-indigo"></i> Comment: +5</div>
                                    <div><i class="fas fa-thumbs-up text-peach"></i> Get Upvote: +10</div>
                                    <div><i class="fas fa-broadcast-tower text-error"></i> Go Live: +100</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Achievements -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <h3 class="mb-3"><i class="fas fa-medal text-gold"></i> Your Achievements</h3>
                            <div class="grid grid-6">
                                <div class="text-center achievement-badge" style="cursor: pointer;" title="Earned for joining the resistance">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--gold);">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <p class="text-sm">Truth Warrior</p>
                                </div>

                                <div class="text-center achievement-badge" style="cursor: pointer;" title="Earned for uploading your first video">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--indigo);">
                                        <i class="fas fa-video"></i>
                                    </div>
                                    <p class="text-sm">Content Creator</p>
                                </div>

                                <div class="text-center achievement-badge" style="cursor: pointer;" title="Earned for gaining 100 followers">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--peach);">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <p class="text-sm">Community Leader</p>
                                </div>

                                <div class="text-center achievement-badge" style="cursor: pointer;" title="Earned for 50 comments">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--success);">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <p class="text-sm">Active Commenter</p>
                                </div>

                                <div class="text-center achievement-badge locked" style="cursor: pointer; opacity: 0.5;" title="Reach 1,000 followers to unlock">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--gray-400);">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <p class="text-sm">Rising Star</p>
                                </div>

                                <div class="text-center achievement-badge locked" style="cursor: pointer; opacity: 0.5;" title="Go live 10 times to unlock">
                                    <div class="badge-icon" style="font-size: 3rem; color: var(--gray-400);">
                                        <i class="fas fa-broadcast-tower"></i>
                                    </div>
                                    <p class="text-sm">Live Legend</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Your Blog Posts Section -->
                    <div class="card mb-3" id="blogPostsSection">
                        <div class="card-body">
                            <div class="flex flex-between mb-3">
                                <h3><i class="fas fa-feather-alt text-indigo"></i> Your Blog Posts</h3>
                                <a href="pages/blog.html" class="btn btn-viking btn-sm">
                                    <i class="fas fa-pen"></i> Write New
                                </a>
                            </div>

                            <div id="userBlogPosts">
                                <!-- Loading State -->
                                <div class="text-center text-muted" style="padding: 2rem;" id="blogPostsLoading">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                                    <p style="margin-top: 1rem;">Loading your posts...</p>
                                </div>

                                <!-- Empty State (shown when no posts) -->
                                <div class="hidden" id="blogPostsEmpty" style="text-align: center; padding: 2rem;">
                                    <i class="fas fa-feather-alt" style="font-size: 3rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                                    <h4 style="color: var(--gray-600);">No Blog Posts Yet</h4>
                                    <p class="text-muted">Share your thoughts and insights with the community!</p>
                                    <a href="pages/blog.html" class="btn btn-viking mt-2">
                                        <i class="fas fa-pen"></i> Write Your First Post
                                    </a>
                                </div>

                                <!-- Blog Posts List (populated dynamically) -->
                                <div class="hidden" id="blogPostsList"></div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </section>

    <!-- Profile Edit Modal -->
    <div class="modal" id="profileEditModal" style="display: none;">
        <div class="modal-overlay" onclick="closeProfileEdit()"></div>
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Edit Profile</h2>
                <button class="modal-close" onclick="closeProfileEdit()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="profileEditForm">
                    <!-- Avatar Upload -->
                    <div class="form-group text-center mb-4">
                        <div class="avatar-upload-container" style="position: relative; display: inline-block;">
                            <img id="profileAvatarPreview" src="https://via.placeholder.com/150/4A90E2/FFFFFF?text=User" alt="Avatar" class="avatar-xl" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover;">
                            <label for="avatarUpload" class="avatar-upload-btn" style="position: absolute; bottom: 0; right: 0; background: var(--indigo); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="previewAvatar(event)">
                        </div>
                        <p class="text-sm text-muted mt-2">Click camera icon to change avatar</p>
                    </div>

                    <!-- Basic Info -->
                    <div class="form-group">
                        <label for="editUsername">Username</label>
                        <input type="text" id="editUsername" class="form-control" placeholder="Your username" readonly style="background: var(--gray-50);">
                        <small class="text-muted">Username cannot be changed</small>
                    </div>

                    <div class="grid grid-2 gap-md">
                        <div class="form-group">
                            <label for="editFirstName">First Name</label>
                            <input type="text" id="editFirstName" class="form-control" placeholder="First name">
                        </div>
                        
                        <div class="form-group">
                            <label for="editLastName">Last Name</label>
                            <input type="text" id="editLastName" class="form-control" placeholder="Last name">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editEmail">Email (Optional)</label>
                        <input type="email" id="editEmail" class="form-control" placeholder="your@email.com">
                    </div>

                    <div class="form-group">
                        <label for="editBio">Bio</label>
                        <textarea id="editBio" class="form-control" rows="4" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                        <small class="text-muted"><span id="bioCharCount">0</span>/500 characters</small>
                    </div>

                    <!-- Social Links -->
                    <h4 class="mt-4 mb-3"><i class="fas fa-share-alt"></i> Social Links</h4>
                    
                    <div class="form-group">
                        <label for="editTwitter">
                            <i class="fab fa-twitter text-indigo"></i> Twitter/X
                        </label>
                        <input type="url" id="editTwitter" class="form-control" placeholder="https://twitter.com/yourhandle">
                    </div>

                    <div class="form-group">
                        <label for="editYoutube">
                            <i class="fab fa-youtube text-error"></i> YouTube
                        </label>
                        <input type="url" id="editYoutube" class="form-control" placeholder="https://youtube.com/@yourchannel">
                    </div>

                    <div class="form-group">
                        <label for="editTelegram">
                            <i class="fab fa-telegram text-info"></i> Telegram
                        </label>
                        <input type="url" id="editTelegram" class="form-control" placeholder="https://t.me/yourhandle">
                    </div>

                    <div class="form-group">
                        <label for="editWebsite">
                            <i class="fas fa-globe text-success"></i> Website
                        </label>
                        <input type="url" id="editWebsite" class="form-control" placeholder="https://yourwebsite.com">
                    </div>

                    <!-- Location -->
                    <div class="form-group">
                        <label for="editLocation">
                            <i class="fas fa-map-marker-alt text-error"></i> Location
                        </label>
                        <input type="text" id="editLocation" class="form-control" placeholder="City, Country">
                    </div>

                    <!-- Privacy Settings -->
                    <h4 class="mt-4 mb-3"><i class="fas fa-shield-alt"></i> Privacy</h4>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editPrivateProfile"> Make profile private
                        </label>
                        <p class="text-sm text-muted" style="margin: 0.5rem 0 0 1.5rem;">Only followers can see your profile</p>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editHideEmail"> Hide email from public
                        </label>
                        <p class="text-sm text-muted" style="margin: 0.5rem 0 0 1.5rem;">Email won't be visible to other users</p>
                        </div>

                    <!-- Save Button -->
                    <div class="flex gap-md mt-4">
                        <button type="submit" class="btn btn-viking btn-lg">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-outline btn-lg" onclick="closeProfileEdit()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Runegold Shop Modal -->
    <div class="modal" id="runegoldShopModal" style="display: none;">
        <div class="modal-overlay" onclick="closeRunegoldShop()"></div>
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-coins text-gold"></i> Runegold Shop</h2>
                <button class="modal-close" onclick="closeRunegoldShop()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Balance Display -->
                <div class="card mb-3" style="background: linear-gradient(135deg, var(--gold), var(--peach)); color: white;">
                    <div class="card-body text-center">
                        <h4 style="color: white;">Your Balance</h4>
                        <div style="font-size: 3rem; font-weight: bold;" id="shopRunegoldBalance">0</div>
                        <p style="opacity: 0.9;">Runegold</p>
                    </div>
                </div>

                <!-- Shop Categories -->
                <div class="shop-categories mb-3">
                    <button class="btn btn-outline shop-category-btn active" data-category="all">
                        <i class="fas fa-th"></i> All Items
                    </button>
                    <button class="btn btn-outline shop-category-btn" data-category="badges">
                        <i class="fas fa-medal"></i> Badges
                    </button>
                    <button class="btn btn-outline shop-category-btn" data-category="features">
                        <i class="fas fa-star"></i> Features
                    </button>
                    <button class="btn btn-outline shop-category-btn" data-category="cosmetics">
                        <i class="fas fa-palette"></i> Cosmetics
                    </button>
                </div>

                <!-- Shop Items Grid -->
                <div class="grid grid-3 gap-md" id="shopItemsGrid">
                    <!-- Badge Items -->
                    <div class="card shop-item" data-category="badges">
                        <div class="card-body text-center">
                            <i class="fas fa-shield-alt text-gold" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Viking Warrior</h4>
                            <p class="text-muted text-sm">Show your dedication</p>
                            <div class="price-tag">
                                <span class="price text-gold">100 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseBadge('viking_warrior', 100)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="badges">
                        <div class="card-body text-center">
                            <i class="fas fa-crown text-gold" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Truth Seeker</h4>
                            <p class="text-muted text-sm">Elite truth warrior</p>
                            <div class="price-tag">
                                <span class="price text-gold">200 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseBadge('truth_seeker', 200)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="badges">
                        <div class="card-body text-center">
                            <i class="fas fa-fire text-peach" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Content Creator</h4>
                            <p class="text-muted text-sm">Premium creator badge</p>
                            <div class="price-tag">
                                <span class="price text-gold">150 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseBadge('content_creator', 150)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <!-- Feature Items -->
                    <div class="card shop-item" data-category="features">
                        <div class="card-body text-center">
                            <i class="fas fa-ad text-indigo" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Ad-Free Experience</h4>
                            <p class="text-muted text-sm">30 days no ads</p>
                            <div class="price-tag">
                                <span class="price text-gold">500 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseFeature('ad_free', 500)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="features">
                        <div class="card-body text-center">
                            <i class="fas fa-rocket text-peach" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Video Boost</h4>
                            <p class="text-muted text-sm">Featured for 1 hour</p>
                            <div class="price-tag">
                                <span class="price text-gold">50 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="showBoostVideoSelector()">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="features">
                        <div class="card-body text-center">
                            <i class="fas fa-star text-gold" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Highlight Comment</h4>
                            <p class="text-muted text-sm">Make it stand out</p>
                            <div class="price-tag">
                                <span class="price text-gold">20 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="showHighlightCommentSelector()">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <!-- Cosmetic Items -->
                    <div class="card shop-item" data-category="cosmetics">
                        <div class="card-body text-center">
                            <i class="fas fa-palette text-indigo" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Custom Profile Color</h4>
                            <p class="text-muted text-sm">Stand out everywhere</p>
                            <div class="price-tag">
                                <span class="price text-gold">100 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseCosmetic('profile_color', 100)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="cosmetics">
                        <div class="card-body text-center">
                            <i class="fas fa-comment-dots text-success" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Custom Username Color</h4>
                            <p class="text-muted text-sm">Unique display</p>
                            <div class="price-tag">
                                <span class="price text-gold">75 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseCosmetic('username_color', 75)">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card shop-item" data-category="cosmetics">
                        <div class="card-body text-center">
                            <i class="fas fa-image text-peach" style="font-size: 3rem;"></i>
                            <h4 class="mt-2">Profile Banner</h4>
                            <p class="text-muted text-sm">Custom header image</p>
                            <div class="price-tag">
                                <span class="price text-gold">150 RG</span>
                            </div>
                            <button class="btn btn-viking btn-sm mt-2" onclick="purchaseCosmetic('profile_banner', 150)">
                                Purchase
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: var(--navy); color: var(--cream); padding: 3rem 0;">
        <div class="container">
            <div class="grid grid-3">
                <div>
                    <h4 style="color: var(--gold);">Much Love, No Fear</h4>
                    <p>A sanctuary for truth-seekers and free thinkers.</p>
                    <div class="flex gap-md" style="margin-top: 1rem;">
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-twitter"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-discord"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Quick Links</h5>
                    <ul style="list-style: none;">
                        <li><a href="pages/archive.html" style="color: var(--cream);">The Vault</a></li>
                        <li><a href="pages/blog.html" style="color: var(--cream);">Blog</a></li>
                        <li><a href="pages/messageboard.html" style="color: var(--cream);">Message Board</a></li>
                        <li><a href="pages/donations.html" style="color: var(--cream);">Support Us</a></li>
                    </ul>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Community</h5>
                    <ul style="list-style: none;">
                        <li><a href="#" style="color: var(--cream);">Guidelines</a></li>
                        <li><a href="#" style="color: var(--cream);">Privacy Policy</a></li>
                        <li><a href="#" style="color: var(--cream);">Terms of Service</a></li>
                        <li><a href="#" style="color: var(--cream);">Contact</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="text-center" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <p>&copy; 2024 Much Love, No Fear. All rights reserved. Built with ❤️ and Viking spirit.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="api-client.js"></script>
    <script src="auth-handler.js"></script>
    <script src="mock-data.js"></script>
    <!-- Load scripts.js BEFORE page-loader.js so APIClient is defined -->
    <script src="scripts.js"></script>
    <script src="notifications.js"></script>
    <script src="page-loader.js"></script>
    
    <!-- Dashboard Real Data Loader -->
    <script>
        // Load real user data from API with proper loading states
        document.addEventListener('DOMContentLoaded', async function() {
            // Show loading indicators
            showLoadingState();

            try {
                // Fetch current user data from API
                const response = await APIClient.auth.getProfile();
                const user = response.user;

                console.log('✅ Dashboard - Loaded user data:', user);

                // Update Runegold balance
                const runegoldElements = document.querySelectorAll('.runegold-balance, .runegold-amount, #runegoldAmount');
                runegoldElements.forEach(el => {
                    animateNumber(el, 0, user.runegoldBalance || 0, 800);
                });

                // Update user stats from REAL data
                updateDashboardStats(user);

                // Load user's actual videos
                await loadUserVideos(user._id);

                // Load real activity feed
                await loadRecentActivity(user._id);

                // Hide loading indicators
                hideLoadingState();

            } catch (error) {
                console.error('❌ Error loading dashboard data:', error);
                hideLoadingState();

                // Show error message to user
                showNotification('Failed to load dashboard data. Please refresh the page.', 'error');

                // Fallback to localStorage data
                const userData = localStorage.getItem('mlnf_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    console.log('📦 Using cached user data:', user);

                    // Update runegold
                    const runegoldElements = document.querySelectorAll('.runegold-balance, .runegold-amount, #runegoldAmount');
                    runegoldElements.forEach(el => {
                        el.textContent = user.runegoldBalance || 0;
                    });

                    // Update stats from cached data
                    updateDashboardStats(user);

                    // Load activity from cached data
                    loadRecentActivity(user._id);

                    // Load videos from cached data
                    loadUserVideos(user._id);
                } else {
                    // No cached data - show empty states
                    showEmptyActivityState();
                    showEmptyVideosState();
                }
            }
        });

        // Update dashboard stats with real data
        function updateDashboardStats(user) {
            // Update username displays
            const username = user.username || user.displayName || 'User';
            document.querySelectorAll('.username-display').forEach(el => {
                el.textContent = username;
            });

            // Update avatar images
            const avatarUrl = user.avatar || user.profilePicture || `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=D4AF37&color=1A2332&size=150`;
            document.querySelectorAll('.user-avatar').forEach(img => {
                img.src = avatarUrl;
                img.alt = username;
            });

            // Update user badge based on subscription or role
            const badgeEl = document.querySelector('.user-badge');
            if (badgeEl) {
                const badge = user.badge || user.role || 'New Viking';
                badgeEl.textContent = badge;
            }

            // Total Videos (from uploadedVideos array)
            const totalVideos = user.uploadedVideos ? user.uploadedVideos.length : 0;
            const totalVideosEl = document.getElementById('totalVideos');
            if (totalVideosEl) {
                animateNumber(totalVideosEl, 0, totalVideos, 600);
            }

            // Total Followers (from followers array)
            const totalFollowers = user.followers ? user.followers.length : 0;
            const totalFollowersEl = document.getElementById('totalFollowers');
            if (totalFollowersEl) {
                animateNumber(totalFollowersEl, 0, totalFollowers, 600);
            }

            // Calculate total views from user's videos
            let totalViews = 0;
            if (user.uploadedVideos && user.uploadedVideos.length > 0) {
                totalViews = user.uploadedVideos.reduce((sum, video) => sum + (video.views || 0), 0);
            }
            const totalViewsEl = document.getElementById('totalViews');
            if (totalViewsEl) {
                animateNumber(totalViewsEl, 0, totalViews, 800);
            }

            // Total Comments (would need separate API call in full implementation)
            // For now, show 0 or calculate from videos if comments are embedded
            const totalCommentsEl = document.getElementById('totalComments');
            if (totalCommentsEl) {
                totalCommentsEl.textContent = '0';
                totalCommentsEl.style.opacity = '0.5';
            }

            console.log('✅ Dashboard stats updated:', {
                username,
                avatarUrl,
                totalVideos,
                totalFollowers,
                totalViews
            });
        }

        // Animate number changes (smooth counting effect)
        function animateNumber(element, start, end, duration) {
            const startTime = performance.now();
            const range = end - start;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Easing function (ease-out)
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (range * easeOut));

                element.textContent = current.toLocaleString();

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        // Load user's actual videos
        async function loadUserVideos(userId) {
            const videosContainer = document.getElementById('yourVideosGrid');
            if (!videosContainer) return;

            // Show loading state (already set in HTML, but reset if needed)
            videosContainer.innerHTML = '<div class="col-span-3 text-center" style="padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--indigo);"></i><p class="mt-2 text-muted">Loading your videos...</p></div>';

            try {
                // Fetch user's videos from API
                const response = await fetch(`${APIClient.auth.getProfile().then(r => r.user._id) === userId ? '/api' : 'https://much-love-no-fear.onrender.com/api'}/videos?userId=${userId}`);
                const data = await response.json();

                if (data.videos && data.videos.length > 0) {
                    // Clear loading message
                    videosContainer.innerHTML = '';

                    // Display up to 3 most recent videos
                    const recentVideos = data.videos.slice(0, 3);
                    recentVideos.forEach(video => {
                        const videoCard = createVideoCard(video);
                        videosContainer.appendChild(videoCard);
                    });
                } else {
                    // No videos uploaded yet
                    videosContainer.innerHTML = `
                        <div class="col-span-3 text-center" style="padding: 3rem;">
                            <i class="fas fa-video" style="font-size: 4rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                            <h4 style="color: var(--gray-600);">No videos yet</h4>
                            <p class="text-muted">Upload your first video to share with warriors!</p>
                            <button class="btn btn-viking mt-3">
                                <i class="fas fa-upload"></i> Upload Video
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading videos:', error);
                videosContainer.innerHTML = `
                    <div class="col-span-3 text-center text-error" style="padding: 2rem;">
                        <i class="fas fa-exclamation-triangle"></i> Failed to load videos
                    </div>
                `;
            }
        }

        // Create video card element
        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'video-card';

            const thumbnail = video.thumbnail || 'https://via.placeholder.com/320x180/333333/FFFFFF?text=Video';
            const isLive = video.status === 'live';

            card.innerHTML = `
                <div class="video-thumbnail" style="position: relative;">
                    <img src="${thumbnail}" alt="${video.title}" style="width: 100%; border-radius: var(--radius-md); aspect-ratio: 16/9; object-fit: cover;">
                    ${isLive ? '<span class="badge badge-error" style="position: absolute; top: 10px; right: 10px;">LIVE</span>' : ''}
                </div>
                <h5 class="mt-2" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${video.title}">${video.title}</h5>
                <div class="flex gap-md text-sm text-muted">
                    <span><i class="fas fa-eye"></i> ${formatNumber(video.views || 0)}</span>
                    <span><i class="fas fa-thumbs-up"></i> ${formatNumber(video.upvotes || 0)}</span>
                    <span><i class="fas fa-comment"></i> ${formatNumber(video.comments?.length || 0)}</span>
                </div>
            `;

            // Make clickable
            card.style.cursor = 'pointer';
            card.addEventListener('click', () => {
                window.location.href = `/pages/video.html?id=${video._id}`;
            });

            return card;
        }

        // Format large numbers (1000 -> 1k, 1000000 -> 1M)
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        // Load recent activity feed
        async function loadRecentActivity(userId) {
            const activityTimeline = document.querySelector('.activity-timeline');
            if (!activityTimeline) return;

            // Clear placeholder activity
            activityTimeline.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading activity...</div>';

            try {
                // In a full implementation, this would fetch from an activity/notifications endpoint
                // For now, we'll generate activity from user's actual data
                const response = await APIClient.auth.getProfile();
                const user = response.user;

                const activities = [];

                // Check if user has videos with views
                if (user.uploadedVideos && user.uploadedVideos.length > 0) {
                    const topVideo = user.uploadedVideos.reduce((prev, current) =>
                        (current.views > (prev?.views || 0)) ? current : prev
                    , null);

                    if (topVideo && topVideo.views > 0) {
                        activities.push({
                            icon: 'fa-video',
                            color: 'var(--success)',
                            text: `Your video "${topVideo.title}" has ${formatNumber(topVideo.views)} views!`,
                            time: 'Recently'
                        });
                    }
                }

                // Check if user has followers
                if (user.followers && user.followers.length > 0) {
                    const recentFollower = user.followers[user.followers.length - 1];
                    activities.push({
                        icon: 'fa-user-plus',
                        color: 'var(--peach)',
                        text: `<strong>${recentFollower.username}</strong> started following you`,
                        time: 'Recently'
                    });
                }

                // If user has Runegold
                if (user.runegoldBalance > 0) {
                    activities.push({
                        icon: 'fa-coins',
                        color: 'var(--gold)',
                        text: `Your Runegold balance: <strong>${user.runegoldBalance} RG</strong>`,
                        time: 'Current'
                    });
                }

                // Display activities or show empty state
                if (activities.length > 0) {
                    activityTimeline.innerHTML = activities.map(activity => `
                        <div class="activity-item">
                            <div class="activity-icon" style="background: ${activity.color};">
                                <i class="fas ${activity.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <p>${activity.text}</p>
                                <small class="text-muted">${activity.time}</small>
                            </div>
                        </div>
                    `).join('');
                } else {
                    activityTimeline.innerHTML = `
                        <div class="text-center text-muted" style="padding: 2rem;">
                            <i class="fas fa-history" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                            <p>No recent activity</p>
                            <small>Start uploading videos and engaging with the community!</small>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading activity:', error);
                activityTimeline.innerHTML = '<div class="text-center text-error">Failed to load activity</div>';
            }
        }

        // Loading state management
        function showLoadingState() {
            // Add shimmer effect to stat cards
            const statCards = document.querySelectorAll('.stat-card h3');
            statCards.forEach(stat => {
                stat.style.opacity = '0.3';
                stat.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            });
        }

        function hideLoadingState() {
            // Loading complete - stats will be populated by updateDashboardStats
        }

        // Show empty state when no user data available
        function showEmptyActivityState() {
            const activityTimeline = document.querySelector('.activity-timeline');
            if (activityTimeline) {
                activityTimeline.innerHTML = `
                    <div class="text-center text-muted" style="padding: 2rem;">
                        <i class="fas fa-history" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                        <p>No recent activity</p>
                        <small>Log in to see your activity feed!</small>
                    </div>
                `;
            }
        }

        // Show empty videos state
        function showEmptyVideosState() {
            const videosContainer = document.getElementById('yourVideosGrid');
            if (videosContainer) {
                videosContainer.innerHTML = `
                    <div class="col-span-3 text-center" style="padding: 3rem;">
                        <i class="fas fa-video" style="font-size: 4rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                        <h4 style="color: var(--gray-600);">No videos yet</h4>
                        <p class="text-muted">Upload your first video to share with warriors!</p>
                        <button class="btn btn-viking mt-3">
                            <i class="fas fa-upload"></i> Upload Video
                        </button>
                    </div>
                `;
            }
        }

        // ==========================================
        // MONTHLY GOAL FUNCTIONALITY
        // ==========================================

        // Load user's monthly goal from localStorage or API
        async function loadMonthlyGoal() {
            const goalDisplay = document.getElementById('monthlyGoalDisplay');
            const goalEmpty = document.getElementById('goalEmptyState');

            // Try to get goal from localStorage first
            const savedGoal = localStorage.getItem('mlnf_monthly_goal');

            if (savedGoal) {
                const goal = JSON.parse(savedGoal);
                updateGoalDisplay(goal);
                goalDisplay.classList.remove('hidden');
                goalEmpty.classList.add('hidden');
            } else {
                // Show empty state
                goalDisplay.classList.add('hidden');
                goalEmpty.classList.remove('hidden');
            }
        }

        function updateGoalDisplay(goal) {
            document.getElementById('goalTitle').textContent = goal.title;
            document.getElementById('goalProgress').textContent = `${goal.current}/${goal.target}`;

            const percentage = Math.min((goal.current / goal.target) * 100, 100);
            document.getElementById('goalProgressBar').style.width = `${percentage}%`;
            document.getElementById('goalPercentage').textContent = `${Math.round(percentage)}% complete`;

            // Calculate days remaining
            const endDate = new Date(goal.endDate || new Date().setDate(new Date().getDate() + 30));
            const today = new Date();
            const daysLeft = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));
            document.getElementById('goalDaysLeft').textContent = `${daysLeft} days remaining`;
        }

        function editMonthlyGoal() {
            const goalTitle = prompt('What is your goal for this month?', 'Upload 10 videos this month');
            if (!goalTitle) return;

            const goalTarget = prompt('Target number to reach:', '10');
            if (!goalTarget || isNaN(goalTarget)) return;

            const goal = {
                title: goalTitle,
                target: parseInt(goalTarget),
                current: 0,
                startDate: new Date().toISOString(),
                endDate: new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString()
            };

            localStorage.setItem('mlnf_monthly_goal', JSON.stringify(goal));
            loadMonthlyGoal();
            showNotification('Monthly goal set! Stay motivated and earn rewards!', 'success');
        }

        // ==========================================
        // HALL OF VIKINGS (LEADERBOARD) FUNCTIONALITY
        // ==========================================

        async function loadLeaderboard(period = 'weekly') {
            const leaderboardList = document.getElementById('leaderboardList');

            try {
                // Fetch leaderboard from API
                const response = await fetch(`/api/leaderboard?period=${period}`);

                if (response.ok) {
                    const data = await response.json();
                    updateLeaderboardDisplay(data.leaderboard);
                } else {
                    // Use mock data if API not available
                    console.log('Using mock leaderboard data');
                }
            } catch (error) {
                console.log('Leaderboard API not available, using mock data');
            }
        }

        function switchLeaderboard(period) {
            // Update button states
            document.querySelectorAll('[data-leaderboard]').forEach(btn => {
                btn.classList.remove('active', 'btn-viking');
                btn.classList.add('btn-outline');
            });
            const activeBtn = document.querySelector(`[data-leaderboard="${period}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            loadLeaderboard(period);
        }

        function updateLeaderboardDisplay(leaders) {
            if (!leaders || leaders.length === 0) return;

            // Update top 3 podium
            if (leaders[0]) {
                document.getElementById('vikingName1').textContent = leaders[0].username;
                document.getElementById('vikingScore1').textContent = formatNumber(leaders[0].points) + ' pts';
            }
            if (leaders[1]) {
                document.getElementById('vikingName2').textContent = leaders[1].username;
                document.getElementById('vikingScore2').textContent = formatNumber(leaders[1].points) + ' pts';
            }
            if (leaders[2]) {
                document.getElementById('vikingName3').textContent = leaders[2].username;
                document.getElementById('vikingScore3').textContent = formatNumber(leaders[2].points) + ' pts';
            }
        }

        // ==========================================
        // BLOG POSTS FUNCTIONALITY
        // ==========================================

        async function loadUserBlogPosts() {
            const loadingEl = document.getElementById('blogPostsLoading');
            const emptyEl = document.getElementById('blogPostsEmpty');
            const listEl = document.getElementById('blogPostsList');

            try {
                const response = await fetch('/api/blog?limit=5');

                if (response.ok) {
                    const data = await response.json();

                    // Filter to user's posts
                    const userPosts = data.posts || [];

                    loadingEl.classList.add('hidden');

                    if (userPosts.length === 0) {
                        emptyEl.classList.remove('hidden');
                        listEl.classList.add('hidden');
                    } else {
                        emptyEl.classList.add('hidden');
                        listEl.classList.remove('hidden');
                        renderBlogPosts(userPosts.slice(0, 3));
                    }
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.log('Blog API not available, showing empty state');
                loadingEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
            }
        }

        function renderBlogPosts(posts) {
            const listEl = document.getElementById('blogPostsList');

            listEl.innerHTML = posts.map(post => `
                <div class="blog-post-item" style="padding: 1rem; background: var(--gray-50); border-radius: var(--radius-md); margin-bottom: 0.75rem;">
                    <div class="flex flex-between" style="align-items: flex-start;">
                        <div style="flex: 1;">
                            <h5 style="margin: 0 0 0.5rem; color: var(--navy);">${post.title}</h5>
                            <p class="text-muted text-sm" style="margin: 0; line-height: 1.4;">${post.excerpt || post.content?.substring(0, 100) + '...'}</p>
                            <div class="flex gap-md text-sm text-muted" style="margin-top: 0.5rem;">
                                <span><i class="fas fa-eye"></i> ${formatNumber(post.views || 0)}</span>
                                <span><i class="fas fa-heart"></i> ${post.likes || 0}</span>
                                <span><i class="fas fa-comment"></i> ${post.comments?.length || 0}</span>
                            </div>
                        </div>
                        <div class="flex gap-sm">
                            <button class="btn btn-sm btn-outline" onclick="editBlogPost('${post._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline text-error" onclick="deleteBlogPost('${post._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editBlogPost(postId) {
            window.location.href = `pages/blog.html?edit=${postId}`;
        }

        async function deleteBlogPost(postId) {
            if (!confirm('Are you sure you want to delete this post?')) return;

            try {
                const response = await fetch(`/api/blog/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    }
                });

                if (response.ok) {
                    showNotification('Blog post deleted', 'success');
                    loadUserBlogPosts();
                } else {
                    showNotification('Failed to delete post', 'error');
                }
            } catch (error) {
                showNotification('Error deleting post', 'error');
            }
        }

        // ==========================================
        // INITIALIZE NEW SECTIONS
        // ==========================================

        document.addEventListener('DOMContentLoaded', function() {
            // Load monthly goal
            loadMonthlyGoal();

            // Load leaderboard
            loadLeaderboard('weekly');

            // Load user blog posts
            loadUserBlogPosts();
        });
    </script>
    
    <!-- Dashboard specific styles -->
    <style>
        .dashboard-sidebar .dashboard-nav a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: var(--radius-md);
            margin-bottom: 0.25rem;
            transition: all var(--transition-base);
        }
        
        .dashboard-sidebar .dashboard-nav a:hover {
            background: var(--gray-50);
            color: var(--indigo);
        }
        
        .dashboard-sidebar .dashboard-nav a.active {
            background: var(--indigo);
            color: white;
        }
        
        .dashboard-sidebar .dashboard-nav a i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }
        
        .activity-timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gray-200);
        }
        
        .activity-item {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .activity-icon {
            position: absolute;
            left: -35px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .avatar-sm {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .avatar-lg {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            cursor: pointer;
        }
        
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            margin-top: 0.5rem;
            z-index: 100;
        }
        
        .user-menu-dropdown a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--gray-700);
            text-decoration: none;
            transition: background var(--transition-base);
        }
        
        .user-menu-dropdown a:hover {
            background: var(--gray-50);
        }
        
        .user-menu-dropdown a i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }

        /* Runegold Shop Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 1001;
            width: 90%;
            max-width: 900px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--gray-500);
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-close:hover {
            color: var(--error);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .shop-categories {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .shop-category-btn {
            min-width: 120px;
        }

        .shop-category-btn.active {
            background: var(--indigo);
            color: white;
            border-color: var(--indigo);
        }

        .shop-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .shop-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .price-tag {
            margin: 1rem 0;
        }

        .price {
            font-size: 1.5rem;
            font-weight: bold;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
    
    <!-- Dashboard JavaScript -->
    <script>
        // API Configuration - Auto-detect environment
        const DASHBOARD_API_BASE = (function() {
            const hostname = window.location.hostname;
            if (hostname.includes('netlify.app') || hostname.includes('mlnf.net') || hostname.includes('vercel.app')) {
                return 'https://much-love-no-fear.onrender.com/api';
            }
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:5000/api';
            }
            return 'https://much-love-no-fear.onrender.com/api';
        })();

        // User menu toggle
        document.getElementById('userMenuToggle')?.addEventListener('click', function() {
            const dropdown = document.getElementById('userMenuDropdown');
            dropdown?.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('userMenuDropdown');
            if (userMenu && !userMenu.contains(e.target)) {
                dropdown?.classList.add('hidden');
            }
        });

        // Runegold Shop Functions
        function openRunegoldShop() {
            const modal = document.getElementById('runegoldShopModal');
            if (modal) {
                modal.style.display = 'flex';
                loadShopBalance();
            }
        }

        function closeRunegoldShop() {
            const modal = document.getElementById('runegoldShopModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadShopBalance() {
            try {
                const response = await APIClient.auth.getProfile();
                const balance = response.user.runegoldBalance || 0;
                const balanceEl = document.getElementById('shopRunegoldBalance');
                if (balanceEl) {
                    balanceEl.textContent = balance;
                }
            } catch (error) {
                console.error('Error loading balance:', error);
                // Fallback to localStorage
                const userData = localStorage.getItem('mlnf_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    const balanceEl = document.getElementById('shopRunegoldBalance');
                    if (balanceEl) {
                        balanceEl.textContent = user.runegoldBalance || 0;
                    }
                }
            }
        }

        // Shop Category Filtering
        document.querySelectorAll('.shop-category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('.shop-category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Filter items
                const category = this.dataset.category;
                const items = document.querySelectorAll('.shop-item');
                
                items.forEach(item => {
                    if (category === 'all' || item.dataset.category === category) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });

        // Purchase Badge
        async function purchaseBadge(badgeName, cost) {
            if (!MLNFAuth.isLoggedIn()) {
                showNotification('Please login to make purchases', 'error');
                return;
            }

            if (!confirm(`Purchase ${badgeName.replace('_', ' ')} badge for ${cost} Runegold?`)) {
                return;
            }

            try {
                const response = await fetch(`${DASHBOARD_API_BASE}/runegold/spend/badge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify({ badgeName })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`Badge purchased! New balance: ${data.balance} RG`, 'success');
                    loadShopBalance();
                    // Update main dashboard balance too
                    const dashboardBalance = document.querySelectorAll('.runegold-balance, .runegold-amount');
                    dashboardBalance.forEach(el => el.textContent = data.balance);
                } else {
                    showNotification(data.error || 'Purchase failed', 'error');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showNotification('Failed to complete purchase', 'error');
            }
        }

        // Purchase Feature
        async function purchaseFeature(featureName, cost) {
            if (!MLNFAuth.isLoggedIn()) {
                showNotification('Please login to make purchases', 'error');
                return;
            }

            if (!confirm(`Purchase ${featureName.replace('_', ' ')} for ${cost} Runegold?`)) {
                return;
            }

            try {
                // For now, use badge endpoint (will create dedicated feature endpoint later)
                const response = await fetch(`${DASHBOARD_API_BASE}/runegold/spend/badge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify({ badgeName: featureName })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`Feature purchased! New balance: ${data.balance} RG`, 'success');
                    loadShopBalance();
                    const dashboardBalance = document.querySelectorAll('.runegold-balance, .runegold-amount');
                    dashboardBalance.forEach(el => el.textContent = data.balance);
                } else {
                    showNotification(data.error || 'Purchase failed', 'error');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showNotification('Failed to complete purchase', 'error');
            }
        }

        // Purchase Cosmetic
        async function purchaseCosmetic(cosmeticName, cost) {
            if (!MLNFAuth.isLoggedIn()) {
                showNotification('Please login to make purchases', 'error');
                return;
            }

            if (!confirm(`Purchase ${cosmeticName.replace('_', ' ')} for ${cost} Runegold?`)) {
                return;
            }

            try {
                const response = await fetch(`${DASHBOARD_API_BASE}/runegold/spend/badge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify({ badgeName: cosmeticName })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`Cosmetic purchased! New balance: ${data.balance} RG`, 'success');
                    loadShopBalance();
                    const dashboardBalance = document.querySelectorAll('.runegold-balance, .runegold-amount');
                    dashboardBalance.forEach(el => el.textContent = data.balance);
                } else {
                    showNotification(data.error || 'Purchase failed', 'error');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showNotification('Failed to complete purchase', 'error');
            }
        }

        // Boost Video Selector (will implement later)
        function showBoostVideoSelector() {
            showNotification('Select a video from your videos to boost', 'info');
            // TODO: Show video selection modal
        }

        // Highlight Comment Selector (will implement later)
        function showHighlightCommentSelector() {
            showNotification('Go to a video and select a comment to highlight', 'info');
            // TODO: Show comment selection interface
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification notification-${type}`;
            notif.textContent = message;
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: var(--navy);
                color: white;
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            if (type === 'success') notif.style.background = 'var(--success)';
            if (type === 'error') notif.style.background = 'var(--error)';
            if (type === 'info') notif.style.background = 'var(--indigo)';
            
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 5000);
        }

        // Add click handlers to shop buttons in main dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Open shop when clicking "Get More Runegold" or shop links
            document.querySelectorAll('[href="#runegold"], .btn-viking').forEach(btn => {
                if (btn.textContent.includes('Get More Runegold') || btn.textContent.includes('Shop')) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        openRunegoldShop();
                    });
                }
            });

            // Open profile edit when clicking profile or settings links
            document.querySelectorAll('[href="#profile"], [href="#settings"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    openProfileEdit();
                });
            });

            // Bio character counter
            const bioTextarea = document.getElementById('editBio');
            const bioCharCount = document.getElementById('bioCharCount');
            if (bioTextarea && bioCharCount) {
                bioTextarea.addEventListener('input', function() {
                    bioCharCount.textContent = this.value.length;
                });
            }
        });

        // Profile Edit Functions
        async function openProfileEdit() {
            const modal = document.getElementById('profileEditModal');
            if (modal) {
                modal.style.display = 'flex';
                await loadProfileData();
            }
        }

        function closeProfileEdit() {
            const modal = document.getElementById('profileEditModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadProfileData() {
            try {
                const response = await APIClient.auth.getProfile();
                const user = response.user;
                
                // Populate form fields
                document.getElementById('editUsername').value = user.username || '';
                document.getElementById('editFirstName').value = user.firstName || '';
                document.getElementById('editLastName').value = user.lastName || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editBio').value = user.bio || '';
                document.getElementById('editTwitter').value = user.socialLinks?.twitter || '';
                document.getElementById('editYoutube').value = user.socialLinks?.youtube || '';
                document.getElementById('editTelegram').value = user.socialLinks?.telegram || '';
                document.getElementById('editWebsite').value = user.socialLinks?.website || '';
                document.getElementById('editLocation').value = user.location || '';
                document.getElementById('editPrivateProfile').checked = user.privateProfile || false;
                document.getElementById('editHideEmail').checked = user.hideEmail || false;
                
                // Update character count
                document.getElementById('bioCharCount').textContent = (user.bio || '').length;
                
                // Update avatar preview if exists
                if (user.avatar) {
                    document.getElementById('profileAvatarPreview').src = user.avatar;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                // Try localStorage fallback
                const userData = localStorage.getItem('mlnf_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    document.getElementById('editUsername').value = user.username || '';
                    document.getElementById('editEmail').value = user.email || '';
                }
            }
        }

        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showNotification('Avatar image must be less than 2MB', 'error');
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select an image file', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profileAvatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Handle profile edit form submission
        document.getElementById('profileEditForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!MLNFAuth.isLoggedIn()) {
                showNotification('Please login first', 'error');
                return;
            }

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;

            try {
                // Prepare profile data
                const profileData = {
                    firstName: document.getElementById('editFirstName').value.trim(),
                    lastName: document.getElementById('editLastName').value.trim(),
                    email: document.getElementById('editEmail').value.trim(),
                    bio: document.getElementById('editBio').value.trim(),
                    socialLinks: {
                        twitter: document.getElementById('editTwitter').value.trim(),
                        youtube: document.getElementById('editYoutube').value.trim(),
                        telegram: document.getElementById('editTelegram').value.trim(),
                        website: document.getElementById('editWebsite').value.trim()
                    },
                    location: document.getElementById('editLocation').value.trim(),
                    privateProfile: document.getElementById('editPrivateProfile').checked,
                    hideEmail: document.getElementById('editHideEmail').checked
                };

                // Handle avatar upload if file selected
                const avatarFile = document.getElementById('avatarUpload').files[0];
                if (avatarFile) {
                    // TODO: Upload avatar to backend
                    // For now, we'll use the base64 preview
                    const avatarPreview = document.getElementById('profileAvatarPreview').src;
                    if (avatarPreview && !avatarPreview.includes('placeholder')) {
                        profileData.avatar = avatarPreview;
                    }
                }

                // Send update to backend
                const response = await fetch(`${DASHBOARD_API_BASE}/auth/update-profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify(profileData)
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification('Profile updated successfully!', 'success');
                    
                    // Update localStorage
                    const currentUser = JSON.parse(localStorage.getItem('mlnf_user') || '{}');
                    const updatedUser = { ...currentUser, ...data.user };
                    localStorage.setItem('mlnf_user', JSON.stringify(updatedUser));
                    
                    // Update UI
                    document.querySelectorAll('.username-display').forEach(el => {
                        el.textContent = data.user.username;
                    });
                    
                    closeProfileEdit();
                } else {
                    showNotification(data.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showNotification('Failed to update profile. Please try again.', 'error');
            } finally {
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // ===== LIVESTREAMING FUNCTIONALITY =====

        let currentStream = null;
        let viewerCountInterval = null;

        // Dashboard Navigation
        document.querySelectorAll('.dashboard-nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();

                // Remove active class from all links
                document.querySelectorAll('.dashboard-nav a').forEach(l => l.classList.remove('active'));
                // Add active to clicked link
                link.classList.add('active');

                // Get section from href
                const section = link.getAttribute('href').substring(1); // Remove #

                // Hide all sections first
                document.getElementById('statsOverview').style.display = 'none';
                document.getElementById('livestreamSection')?.classList.add('hidden');
                document.getElementById('messagesSection')?.classList.add('hidden');

                // Show selected section
                if (section === 'overview') {
                    document.getElementById('statsOverview').style.display = 'grid';
                } else if (section === 'livestream') {
                    document.getElementById('livestreamSection')?.classList.remove('hidden');
                    loadUserStreams();
                } else if (section === 'messages') {
                    document.getElementById('messagesSection')?.classList.remove('hidden');
                    loadConversations();
                }
            });
        });

        // ===== MESSAGING FUNCTIONALITY =====

        let currentConversation = null;

        // Load user's conversations
        async function loadConversations() {
            const conversationsList = document.getElementById('conversationsList');
            if (!conversationsList) return;

            conversationsList.innerHTML = '<div class="text-center text-muted" style="padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading conversations...</div>';

            try {
                // In full implementation, this would fetch from /api/messages or similar
                // For now, show empty state
                conversationsList.innerHTML = `
                    <div class="text-center text-muted" style="padding: 3rem 1rem;">
                        <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>No conversations yet</p>
                        <small>Send a message to start chatting!</small>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading conversations:', error);
                conversationsList.innerHTML = '<div class="text-center text-error">Failed to load conversations</div>';
            }
        }

        // Open new message dialog
        function openNewMessage() {
            showNotification('Direct messaging coming soon! For now, connect with warriors in the Message Board.', 'info');
            // In full implementation, this would open a modal to select a user and start a conversation
        }

        // Open a conversation
        function openConversation(conversationId, username) {
            currentConversation = conversationId;

            // Show chat header and input
            document.getElementById('chatHeader')?.classList.remove('hidden');
            document.getElementById('messageInput')?.classList.remove('hidden');

            // Update chat header
            document.getElementById('chatUsername').textContent = username;

            // Load messages for this conversation
            loadMessages(conversationId);
        }

        // Load messages for a conversation
        async function loadMessages(conversationId) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            chatMessages.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';

            try {
                // In full implementation, fetch from /api/messages/{conversationId}
                // For now, show empty state
                chatMessages.innerHTML = `
                    <div class="text-center text-muted" style="padding: 2rem;">
                        <p>No messages yet. Say hi!</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading messages:', error);
                chatMessages.innerHTML = '<div class="text-center text-error">Failed to load messages</div>';
            }
        }

        // Close chat
        function closeChat() {
            currentConversation = null;
            document.getElementById('chatHeader')?.classList.add('hidden');
            document.getElementById('messageInput')?.classList.add('hidden');

            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div class="text-center text-muted" style="padding: 3rem 1rem;">
                        <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>Select a conversation to start chatting</p>
                    </div>
                `;
            }
        }

        // Send message
        document.getElementById('sendMessageForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const messageText = document.getElementById('messageText');
            if (!messageText || !messageText.value.trim()) return;

            const message = messageText.value.trim();

            try {
                // In full implementation, POST to /api/messages
                // For now, show notification
                showNotification('Direct messaging API coming soon!', 'info');

                // Clear input
                messageText.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message', 'error');
            }
        });

        // Conversation search
        document.getElementById('conversationSearch')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const conversations = document.querySelectorAll('.conversation-item');

            conversations.forEach(conv => {
                const username = conv.getAttribute('data-username')?.toLowerCase() || '';
                if (username.includes(searchTerm)) {
                    conv.style.display = 'flex';
                } else {
                    conv.style.display = 'none';
                }
            });
        });

        // Toggle OBS Guide
        function toggleOBSGuide() {
            const guide = document.getElementById('obsGuide');
            guide.classList.toggle('hidden');
        }

        // Toggle Schedule Stream Panel
        function toggleScheduleStream() {
            const panel = document.getElementById('scheduleStreamPanel');
            panel.classList.toggle('hidden');
        }

        // Preview Thumbnail
        function previewThumbnail(input) {
            const preview = document.getElementById('thumbnailPreview');
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Check file size (2MB max)
                if (file.size > 2 * 1024 * 1024) {
                    showNotification('Thumbnail must be under 2MB', 'error');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // Schedule Stream
        async function scheduleStream() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const title = document.getElementById('streamTitle').value;

            if (!date || !time) {
                showNotification('Please select both date and time', 'error');
                return;
            }

            if (!title) {
                showNotification('Please enter a stream title first', 'error');
                return;
            }

            const scheduledFor = new Date(`${date}T${time}`);
            if (scheduledFor <= new Date()) {
                showNotification('Scheduled time must be in the future', 'error');
                return;
            }

            try {
                const response = await fetch(`${DASHBOARD_API_BASE}/livestream/schedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify({
                        title,
                        category: document.getElementById('streamCategory').value,
                        description: document.getElementById('streamDescription').value,
                        tags: document.getElementById('streamTags').value.split(',').map(t => t.trim()).filter(t => t),
                        scheduledFor: scheduledFor.toISOString()
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(`Stream scheduled for ${scheduledFor.toLocaleString()}!`, 'success');
                    document.getElementById('scheduleStreamPanel').classList.add('hidden');
                    loadUserStreams();
                } else {
                    showNotification(data.error || 'Failed to schedule stream', 'error');
                }
            } catch (error) {
                console.error('Schedule error:', error);
                showNotification('Failed to schedule stream', 'error');
            }
        }

        // Open Stream Chat
        function openStreamChat() {
            if (!currentStream) return;
            // Open chat in new window or modal
            window.open(`/pages/live.html?stream=${currentStream._id}&chat=true`, 'StreamChat', 'width=400,height=600');
        }

        // Copy Stream Link
        function copyStreamLink() {
            if (!currentStream) return;
            const link = `${window.location.origin}/pages/live.html?stream=${currentStream._id}`;
            navigator.clipboard.writeText(link).then(() => {
                showNotification('Stream link copied! Share it with warriors!', 'success');
            }).catch(() => {
                showNotification('Failed to copy link', 'error');
            });
        }

        // Update stream health indicator
        function updateStreamHealth(bitrate) {
            const healthEl = document.getElementById('streamHealth');
            const bitrateEl = document.getElementById('streamBitrate');

            if (!healthEl) return;

            bitrateEl.textContent = `${bitrate} kbps`;

            if (bitrate >= 4000) {
                healthEl.innerHTML = '<i class="fas fa-check-circle"></i> Excellent';
                healthEl.style.background = 'var(--success)';
            } else if (bitrate >= 2500) {
                healthEl.innerHTML = '<i class="fas fa-check-circle"></i> Good';
                healthEl.style.background = 'var(--success)';
            } else if (bitrate >= 1500) {
                healthEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Fair';
                healthEl.style.background = 'var(--warning)';
            } else {
                healthEl.innerHTML = '<i class="fas fa-times-circle"></i> Poor';
                healthEl.style.background = 'var(--error)';
            }
        }

        // Track peak viewers and stream timing
        let peakViewerCount = 0;
        let streamStartTimestamp = null;
        let streamDurationInterval = null;

        // Update stream duration display
        function updateStreamDuration() {
            if (!streamStartTimestamp) return;

            const elapsed = Date.now() - streamStartTimestamp;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            let display;
            if (hours > 0) {
                display = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            document.getElementById('streamStartTime').textContent = display;
        }

        // Initialize stream preview player
        function initStreamPreview() {
            if (!currentStream) return;

            const previewPlayer = document.getElementById('previewPlayer');
            if (!previewPlayer) return;

            // Use HLS.js for stream preview
            const streamUrl = `https://stream.mlnf.net/hls/${currentStream.streamKey}.m3u8`;

            if (Hls && Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true
                });
                hls.loadSource(streamUrl);
                hls.attachMedia(previewPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    previewPlayer.play().catch(e => console.log('Preview autoplay blocked'));
                });
            } else if (previewPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                previewPlayer.src = streamUrl;
                previewPlayer.addEventListener('loadedmetadata', () => {
                    previewPlayer.play().catch(e => console.log('Preview autoplay blocked'));
                });
            } else {
                console.log('HLS not supported, preview unavailable');
                document.getElementById('streamPreviewCard').style.display = 'none';
            }
        }

        // Create Stream Form
        document.getElementById('createStreamForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('streamTitle').value;
            const category = document.getElementById('streamCategory').value;
            const description = document.getElementById('streamDescription').value;

            try {
                const response = await fetch(`${DASHBOARD_API_BASE}/livestream/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    },
                    body: JSON.stringify({ title, category, description })
                });

                const data = await response.json();

                if (response.ok) {
                    currentStream = data.stream;

                    // Show stream key
                    document.getElementById('streamKeyValue').value = data.stream.streamKey;
                    document.getElementById('streamKeyDisplay').classList.remove('hidden');

                    // Show OBS guide
                    document.getElementById('obsGuide').classList.remove('hidden');

                    showNotification('Stream created successfully! Copy your stream key and configure OBS.', 'success');

                    // Clear form
                    document.getElementById('createStreamForm').reset();
                } else {
                    showNotification(data.error || 'Failed to create stream', 'error');
                }
            } catch (error) {
                console.error('Create stream error:', error);
                showNotification('Failed to create stream. Please try again.', 'error');
            }
        });

        // Toggle Stream Key Visibility
        function toggleStreamKeyVisibility() {
            const keyInput = document.getElementById('streamKeyValue');
            const icon = document.getElementById('streamKeyToggleIcon');

            if (keyInput.type === 'password') {
                keyInput.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                keyInput.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Copy Stream Key
        async function copyStreamKey() {
            const keyInput = document.getElementById('streamKeyValue');

            try {
                await navigator.clipboard.writeText(keyInput.value);
                showNotification('Stream key copied to clipboard!', 'success');
            } catch (error) {
                // Fallback for older browsers
                keyInput.select();
                document.execCommand('copy');
                showNotification('Stream key copied!', 'success');
            }
        }

        // Go Live
        async function goLive() {
            if (!currentStream) {
                showNotification('No stream found. Please create a stream first.', 'error');
                return;
            }

            try {
                const response = await fetch(`${DASHBOARD_API_BASE}/livestream/${currentStream._id}/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Show live status banner
                    document.getElementById('liveStatusBanner').style.display = 'block';
                    document.getElementById('streamStartTime').textContent = '0:00';

                    // Update stream title in banner
                    const titleEl = document.getElementById('liveStreamTitle');
                    if (titleEl && currentStream.title) {
                        titleEl.textContent = currentStream.title;
                    }

                    // Show stream preview
                    document.getElementById('streamPreviewCard').style.display = 'block';
                    initStreamPreview();

                    // Reset peak viewers
                    peakViewerCount = 0;
                    document.getElementById('peakViewers').textContent = '0';
                    document.getElementById('liveRunegold').textContent = '0';

                    // Hide Go Live button
                    document.getElementById('goLiveButton').disabled = true;
                    document.getElementById('goLiveButton').innerHTML = '<i class="fas fa-check-circle"></i> You\'re Live!';

                    showNotification('You\'re now live! Warriors can see your stream.', 'success');

                    // Start viewer count updates (more frequent - every 5 seconds)
                    updateViewerCount();
                    viewerCountInterval = setInterval(updateViewerCount, 5000);

                    // Start duration timer
                    streamStartTimestamp = Date.now();
                    streamDurationInterval = setInterval(updateStreamDuration, 1000);
                } else {
                    showNotification(data.error || 'Failed to go live', 'error');
                }
            } catch (error) {
                console.error('Go live error:', error);
                showNotification('Failed to go live. Make sure OBS is streaming first!', 'error');
            }
        }

        // End Stream (accepts optional streamId for ending from list)
        async function endStream(streamId = null) {
            const idToEnd = streamId || (currentStream ? currentStream._id : null);
            if (!idToEnd) return;

            if (!confirm('Are you sure you want to end this stream?')) return;

            try {
                const response = await fetch(`${DASHBOARD_API_BASE}/livestream/${idToEnd}/end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Hide live status banner and preview
                    document.getElementById('liveStatusBanner').style.display = 'none';
                    document.getElementById('streamPreviewCard').style.display = 'none';

                    // Stop preview player
                    const previewPlayer = document.getElementById('previewPlayer');
                    if (previewPlayer) {
                        previewPlayer.pause();
                        previewPlayer.src = '';
                    }

                    // Clear viewer count interval
                    if (viewerCountInterval) {
                        clearInterval(viewerCountInterval);
                        viewerCountInterval = null;
                    }

                    // Clear duration timer
                    if (streamDurationInterval) {
                        clearInterval(streamDurationInterval);
                        streamDurationInterval = null;
                    }
                    streamStartTimestamp = null;

                    // Reset peak viewers
                    peakViewerCount = 0;

                    // Reset stream
                    currentStream = null;
                    document.getElementById('streamKeyDisplay').classList.add('hidden');
                    document.getElementById('goLiveButton').disabled = false;
                    document.getElementById('goLiveButton').innerHTML = '<i class="fas fa-play-circle"></i> ⚡ Go Live!';

                    showNotification('Stream ended successfully!', 'success');

                    // Reload streams list
                    loadUserStreams();
                } else {
                    showNotification(data.error || 'Failed to end stream', 'error');
                }
            } catch (error) {
                console.error('End stream error:', error);
                showNotification('Failed to end stream. Please try again.', 'error');
            }
        }

        // Update Viewer Count and Stats
        async function updateViewerCount() {
            if (!currentStream) return;

            try {
                const response = await fetch(`${DASHBOARD_API_BASE}/livestream/${currentStream._id}`);
                const data = await response.json();

                if (response.ok) {
                    const currentViewers = data.currentViewers || 0;
                    document.getElementById('currentViewers').textContent = currentViewers;

                    // Track peak viewers
                    if (currentViewers > peakViewerCount) {
                        peakViewerCount = currentViewers;
                        document.getElementById('peakViewers').textContent = peakViewerCount;
                    }

                    // Update Runegold earned (if provided by API)
                    if (data.runegoldEarned !== undefined) {
                        document.getElementById('liveRunegold').textContent = data.runegoldEarned;
                    }

                    // Update stream health (if bitrate is available)
                    if (data.bitrate) {
                        updateStreamHealth(data.bitrate);
                    }
                }
            } catch (error) {
                console.error('Error updating viewer count:', error);
            }
        }

        // Load User Streams
        async function loadUserStreams() {
            try {
                const response = await fetch(`${DASHBOARD_API_BASE}/livestream/my-streams`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('mlnf_token')}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.streams && data.streams.length > 0) {
                    const streamsList = document.getElementById('userStreamsList');
                    streamsList.innerHTML = '';

                    data.streams.forEach(stream => {
                        const streamCard = document.createElement('div');
                        streamCard.className = 'card mb-2';
                        streamCard.style.border = stream.status === 'live' ? '2px solid var(--error)' : '';

                        streamCard.innerHTML = `
                            <div class="card-body">
                                <div class="flex flex-between">
                                    <div style="flex: 1;">
                                        <h5>${stream.title}</h5>
                                        <div class="flex gap-md text-sm text-muted" style="margin-top: 0.5rem;">
                                            <span><i class="fas fa-eye"></i> ${stream.peakViewers || 0} peak viewers</span>
                                            <span><i class="fas fa-coins text-gold"></i> ${stream.runegoldEarned || 0} RG earned</span>
                                            <span><i class="fas fa-calendar"></i> ${new Date(stream.createdAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <span class="badge ${stream.status === 'live' ? 'badge-error' : stream.status === 'ended' ? 'badge-secondary' : 'badge-warning'}">
                                            ${stream.status.toUpperCase()}
                                        </span>
                                        ${stream.status === 'ended' && stream.duration ? `
                                            <div class="text-sm text-muted" style="margin-top: 0.5rem;">
                                                Duration: ${Math.floor(stream.duration / 60)} min
                                            </div>
                                        ` : ''}
                                        ${stream.status === 'offline' || stream.status === 'live' ? `
                                            <button class="btn btn-sm btn-outline" style="margin-top: 0.5rem;" onclick="endStream('${stream._id}')">
                                                <i class="fas fa-stop-circle"></i> End Stream
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;

                        streamsList.appendChild(streamCard);
                    });
                }
            } catch (error) {
                console.error('Error loading streams:', error);
            }
        }
    </script>

    <!-- Socket.IO for real-time messaging -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- MLNF Dashboard Integration -->
    <script src="js/dashboard-api.js"></script>
    <script src="js/messaging.js"></script>
    <script src="js/dashboard-init.js"></script>
    <script src="js/site-enhancements.js"></script>
    <script src="js/mobile-viewport-handler.js"></script>

    <!-- Sidebar Toggle Button (outside sidebar for proper fixed positioning) -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-chevron-right"></i>
    </button>

    <!-- Sidebar - Online Users -->
    <aside class="sidebar" id="sidebar">

        <div class="runegold-display" id="runegoldDisplay">
            <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">Your Runegold</div>
            <div class="runegold-amount" id="runegoldAmount">0</div>
            <a href="runegold.html" class="btn btn-sm btn-primary" style="margin-top: 0.5rem; width: 100%;">
                <i class="fas fa-shopping-cart"></i> Shop
            </a>
        </div>

        <h6 style="margin-bottom: 1rem;">
            <i class="fas fa-users"></i> Online Users
            <span id="onlineCount" style="font-size: 0.75rem; opacity: 0.7;">(0)</span>
        </h6>

        <ul class="online-users-list" id="onlineUsersList">
            <li class="text-center text-muted" style="padding: 2rem 0;">
                <i class="fas fa-user-slash" style="font-size: 2rem; opacity: 0.3;"></i>
                <p style="margin-top: 1rem; font-size: 0.875rem;">No users online</p>
            </li>
        </ul>
    </aside>
</body>
</html>