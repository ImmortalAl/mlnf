<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Uncensored News - Real-time updates on Much Love, No Fear">
    <title>News - Much Love, No Fear</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../css/viking-components.css">
    <link rel="stylesheet" href="../css/mobile-optimized.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <div class="flex flex-between">
                <div class="site-logo">
                    <i class="fas fa-shield-alt site-logo-icon"></i>
                    <span>Much Love, No Fear</span>
                </div>
                
                <nav class="site-nav" id="mainNav">
                    <a href="../index.html" class="nav-link">Home</a>
                    <a href="live.html" class="nav-link">Live</a>
                    <a href="archive.html" class="nav-link">The Vault</a>
                    <a href="blog.html" class="nav-link">Blog</a>
                    <a href="news.html" class="nav-link active">News</a>
                    <a href="messageboard.html" class="nav-link">Board</a>
                    <a href="donations.html" class="nav-link">Support</a>
                    <a href="merch.html" class="nav-link">Merch</a>
                    <a href="auth.html" class="nav-link" id="authLink">Login</a>
                    <a href="../dashboard.html" class="nav-link hidden" id="dashboardLink">Dashboard</a>
                    
                    <!-- Notification Bell -->
                    <div class="notification-bell hidden" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge hidden" id="notificationBadge">0</span>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <button class="btn-icon" id="themeToggle" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </nav>
                
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Page Hero -->
    <section class="page-hero" style="background: linear-gradient(135deg, var(--peach) 0%, var(--navy) 100%); color: var(--cream);">
        <div class="container">
            <h1 style="color: var(--gold); text-shadow: 2px 2px 8px rgba(0,0,0,0.5);">
                <i class="fas fa-newspaper"></i> Uncensored News
            </h1>
            <p style="font-size: 1.25rem; margin-top: 1rem;">
                Real-time updates from independent journalists and citizen reporters
            </p>
        </div>
    </section>

    <!-- Breaking News Ticker -->
    <section id="breakingTickerSection" style="background: var(--error); color: white; padding: 1rem 0; display: none;">
        <div class="container">
            <div class="flex gap-md">
                <span class="badge badge-light" style="background: white; color: var(--error);">
                    <i class="fas fa-bolt"></i> BREAKING
                </span>
                <div class="news-ticker" style="flex: 1; overflow: hidden;">
                    <span id="tickerText" style="display: inline-block; white-space: nowrap; animation: scroll-left 30s linear infinite;">
                        Loading latest headlines...
                    </span>
                </div>
            </div>
        </div>
    </section>

    <!-- News Categories -->
    <section style="padding: 2rem 0; background: var(--gray-50);">
        <div class="container">
            <div class="flex gap-md flex-wrap">
                <button class="btn btn-outline active" data-category="all">All News</button>
                <button class="btn-viking-secondary" data-category="breaking">Breaking</button>
                <button class="btn-viking-secondary" data-category="world">World</button>
                <button class="btn-viking-secondary" data-category="health">Health</button>
                <button class="btn-viking-secondary" data-category="finance">Finance</button>
                <button class="btn-viking-secondary" data-category="tech">Technology</button>
                <button class="btn-viking-secondary" data-category="politics">Politics</button>
                <button class="btn-viking-secondary" id="submitNewsBtn">
                    <i class="fas fa-plus-circle"></i> Submit News
                </button>
            </div>
        </div>
    </section>

    <!-- Main News Layout -->
    <section style="padding: 3rem 0;">
        <div class="container">
            <div class="grid news-layout-grid" style="gap: 2rem;">
                <!-- Main News Feed -->
                <div>
                    <!-- Featured Story (dynamically loaded) -->
                    <article class="card card-viking mb-3" id="featuredStory" style="display: none;">
                        <div class="card-body" id="featuredStoryContent">
                            <!-- Featured article will be loaded here -->
                        </div>
                    </article>

                    <!-- News List -->
                    <div class="news-list" id="newsFeed">
                        <!-- News articles will load here dynamically from API -->
                    </div>

                    <!-- Load More -->
                    <div class="text-center mt-3">
                        <button class="btn btn-viking btn-lg">
                            <i class="fas fa-plus-circle"></i> Load More News
                        </button>
                    </div>
                </div>

                <!-- Sidebar -->
                <aside>
                    <!-- Trending Topics (dynamically loaded) -->
                    <div class="card mb-3" id="trendingTopicsCard" style="display: none;">
                        <div class="card-body">
                            <h3 class="mb-3"><i class="fas fa-fire text-peach"></i> Trending Topics</h3>
                            <ul style="list-style: none;" id="trendingTopicsList">
                                <!-- Trending topics will be loaded here -->
                            </ul>
                        </div>
                    </div>

                    <!-- Most Discussed (dynamically loaded) -->
                    <div class="card mb-3" id="mostDiscussedCard" style="display: none;">
                        <div class="card-body">
                            <h3 class="mb-3"><i class="fas fa-eye text-indigo"></i> Most Viewed</h3>
                            <div id="mostDiscussedList">
                                <!-- Most discussed articles will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Submit News Tip -->
                    <div class="card card-viking">
                        <div class="card-body text-center">
                            <i class="fas fa-bullhorn" style="font-size: 3rem; color: var(--gold); margin-bottom: 1rem;"></i>
                            <h4 class="mb-2">Have a News Tip?</h4>
                            <p class="mb-3">Share your story with our community of truth-seekers</p>
                            <button class="btn btn-viking btn-sm" style="width: 100%;" onclick="document.getElementById('submitNewsBtn').click()">
                                <i class="fas fa-paper-plane"></i> Submit News
                            </button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer style="background: var(--navy); color: var(--cream); padding: 3rem 0;">
        <div class="container">
            <div class="grid grid-3">
                <div>
                    <h4 style="color: var(--gold);">Much Love, No Fear</h4>
                    <p>A sanctuary for truth-seekers and free thinkers.</p>
                    <div class="flex gap-md" style="margin-top: 1rem;">
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-twitter"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-discord"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Quick Links</h5>
                    <ul style="list-style: none;">
                        <li><a href="archive.html" style="color: var(--cream);">The Vault</a></li>
                        <li><a href="blog.html" style="color: var(--cream);">Blog</a></li>
                        <li><a href="messageboard.html" style="color: var(--cream);">Message Board</a></li>
                        <li><a href="donations.html" style="color: var(--cream);">Support Us</a></li>
                    </ul>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Community</h5>
                    <ul style="list-style: none;">
                        <li><a href="#" style="color: var(--cream);">Guidelines</a></li>
                        <li><a href="#" style="color: var(--cream);">Privacy Policy</a></li>
                        <li><a href="#" style="color: var(--cream);">Terms of Service</a></li>
                        <li><a href="#" style="color: var(--cream);">Contact</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="text-center" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <p>&copy; 2024 Much Love, No Fear. All rights reserved. Built with ❤️ and Viking spirit.</p>
            </div>
        </div>
    </footer>

    <!-- Sidebar Toggle Button (outside sidebar for proper fixed positioning) -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-chevron-left"></i>
    </button>

    <!-- Sidebar - Online Users -->
    <aside class="sidebar" id="sidebar">
        <div class="runegold-display" id="runegoldDisplay">
            <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">Your Runegold</div>
            <div class="runegold-amount" id="runegoldAmount">0</div>
            <a href="runegold-shop.html" class="btn btn-sm btn-primary" style="margin-top: 0.5rem; width: 100%;">
                <i class="fas fa-coins"></i> Runegold Shop
            </a>
        </div>
        
        <h6 style="margin-bottom: 1rem;">
            <i class="fas fa-users"></i> Online Users
            <span id="onlineCount" style="font-size: 0.75rem; opacity: 0.7;">(0)</span>
        </h6>
        
        <ul class="online-users-list" id="onlineUsersList">
            <li class="text-center text-muted" style="padding: 2rem 0;">
                <i class="fas fa-user-slash" style="font-size: 2rem; opacity: 0.3;"></i>
                <p style="margin-top: 1rem; font-size: 0.875rem;">No users online</p>
            </li>
        </ul>
    </aside>

    <!-- Custom News Ticker Animation -->
    <style>
        @keyframes scroll-left {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>

    <!-- Submit News Modal -->
    <div class="modal" id="submitNewsModal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Submit News Article</h2>
                <button class="btn-close" onclick="document.getElementById('submitNewsModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <form id="submitNewsForm">
                    <div class="viking-form-group">
                        <label class="viking-label" for="newsTitle">Article Title *</label>
                        <input type="text" id="newsTitle" class="viking-input" required maxlength="200" 
                               placeholder="Enter breaking news headline...">
                    </div>
                    
                    <div class="viking-form-group">
                        <label class="viking-label" for="newsExcerpt">Excerpt (Short Summary) *</label>
                        <textarea class="viking-textarea" id="newsExcerpt" class="viking-input" rows="2" required maxlength="300"
                                  placeholder="Write a brief summary that will appear in the news listing..."></textarea>
                        <small class="text-muted">Maximum 300 characters</small>
                    </div>
                    
                    <div class="viking-form-group">
                        <label class="viking-label" for="newsCategory">Category *</label>
                        <select class="viking-select" id="newsCategory" class="viking-input" required>
                            <option value="">Select a category...</option>
                            <option value="Breaking">Breaking News</option>
                            <option value="Politics">Politics</option>
                            <option value="Health">Health</option>
                            <option value="Finance">Finance</option>
                            <option value="Technology">Technology</option>
                            <option value="World">World Events</option>
                        </select>
                    </div>
                    
                    <div class="viking-form-group">
                        <label class="viking-label" for="newsSource">Source (Optional)</label>
                        <input type="text" id="newsSource" class="viking-input" 
                               placeholder="e.g., Independent Reporters Network, Citizen Journalist">
                        <small class="text-muted">Credit the original source if applicable</small>
                    </div>
                    
                    <div class="viking-form-group">
                        <label class="viking-label" for="newsContent">Full Article *</label>
                        <textarea class="viking-textarea" id="newsContent" class="viking-input" rows="12" required
                                  placeholder="Write the full article here... (HTML supported: &lt;h2&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;li&gt;, &lt;strong&gt;, &lt;em&gt;)"></textarea>
                        <small class="text-muted">You can use basic HTML formatting</small>
                    </div>
                    
                    <div class="viking-form-group">
                        <label class="viking-label" class="checkbox-label">
                            <input type="checkbox" id="newsBreaking">
                            <span>Mark as Breaking News</span>
                        </label>
                    </div>
                    
                    <div class="flex gap-md">
                        <button type="submit" class="btn btn-viking btn-lg">
                            <i class="fas fa-paper-plane"></i> Submit News
                        </button>
                        <button type="button" class="btn btn-outline btn-lg" 
                                onclick="document.getElementById('submitNewsModal').style.display='none'">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="../auth-handler.js"></script>
    <script src="../api-client.js"></script>
    <script src="../mock-data.js"></script>
    <!-- Load scripts.js BEFORE page-loader.js so APIClient is defined -->
    <script src="../scripts.js"></script>
    <script src="../page-loader.js"></script>
    
    <!-- News Page Specific Script -->
    <script>
        // Submit News Button
        document.getElementById('submitNewsBtn').addEventListener('click', function() {
            // Check if user is logged in
            const token = localStorage.getItem('mlnf_token');
            if (!token) {
                alert('Please log in to submit news.');
                window.location.href = 'auth.html';
                return;
            }
            document.getElementById('submitNewsModal').style.display = 'flex';
        });
        
        // Submit News Form
        document.getElementById('submitNewsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                const title = document.getElementById('newsTitle').value.trim();
                const excerpt = document.getElementById('newsExcerpt').value.trim();
                const content = document.getElementById('newsContent').value.trim();
                const category = document.getElementById('newsCategory').value;
                const source = document.getElementById('newsSource').value.trim() || 'Community Submission';
                const breaking = document.getElementById('newsBreaking').checked;
                
                // Create slug from title
                const slug = title.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
                
                const articleData = {
                    title,
                    slug,
                    excerpt,
                    content,
                    category,
                    source,
                    breaking,
                    trending: false
                };
                
                const response = await APIClient.news.create(articleData);

                alert('✅ News article published successfully!');
                
                // Close modal and reset form
                document.getElementById('submitNewsModal').style.display = 'none';
                document.getElementById('submitNewsForm').reset();
                
                // Reload news articles (only admins will see their article immediately)
                if (typeof PageLoader !== 'undefined') {
                    PageLoader.loadNews();
                }
                
            } catch (error) {
                console.error('Error submitting news:', error);
                let errorMsg = error.message || 'Please try again';
                
                // Add helpful hints based on error type
                if (errorMsg.includes('authenticate')) {
                    errorMsg += '\n\nPlease log out and log back in, your session may have expired.';
                } else if (errorMsg.includes('validation') || errorMsg.includes('invalid')) {
                    errorMsg += '\n\nPlease check all required fields are filled correctly.';
                }
                
                alert('❌ Failed to submit news:\n\n' + errorMsg);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    </script>

    <!-- News Loading Script -->
    <script>
        // Load news articles from API
        async function loadNewsArticles(category = 'all', page = 1) {
            const newsFeed = document.getElementById('newsFeed');
            const token = localStorage.getItem('mlnf_token');
            const isAdmin = isUserAdmin();

            // Show loading state
            newsFeed.innerHTML = `
                <div class="card mb-2" style="padding: 1rem;">
                    <div class="skeleton" style="height: 24px; width: 80%; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton" style="height: 16px; width: 60%;"></div>
                </div>
                <div class="card mb-2" style="padding: 1rem;">
                    <div class="skeleton" style="height: 24px; width: 70%; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton" style="height: 16px; width: 50%;"></div>
                </div>
                <div class="card mb-2" style="padding: 1rem;">
                    <div class="skeleton" style="height: 24px; width: 90%; margin-bottom: 0.5rem;"></div>
                    <div class="skeleton" style="height: 16px; width: 40%;"></div>
                </div>
            `;

            try {
                let url = category === 'all'
                    ? `/api/news?page=${page}&limit=10`
                    : `/api/news?category=${category}&page=${page}&limit=10`;

                // Admins see all articles including hidden ones
                if (isAdmin) {
                    url += '&includeHidden=true';
                }

                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(url, { headers });

                if (response.ok) {
                    const data = await response.json();
                    renderNewsArticles(data.articles || []);
                } else {
                    // Use sample data if API not available
                    renderSampleNews();
                }
            } catch (error) {
                console.log('News API not available, using sample data');
                renderSampleNews();
            }
        }

        // Check if current user is admin
        function isUserAdmin() {
            const userStr = localStorage.getItem('mlnf_user');
            if (!userStr) return false;
            try {
                const user = JSON.parse(userStr);
                return user.role === 'admin';
            } catch (e) {
                return false;
            }
        }

        // Admin actions
        async function deleteNewsArticle(articleId, event) {
            event.stopPropagation(); // Prevent card click
            if (!confirm('Are you sure you want to delete this article? This cannot be undone.')) return;

            try {
                const token = localStorage.getItem('mlnf_token');
                const response = await fetch(`/api/news/${articleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showNotification('Article deleted successfully', 'success');
                    loadNewsArticles();
                    loadFeaturedStory();
                    loadBreakingTicker();
                    loadTrendingTopics();
                    loadMostDiscussed();
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Failed to delete article', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Failed to delete article', 'error');
            }
        }

        async function toggleNewsVisibility(articleId, event) {
            event.stopPropagation(); // Prevent card click

            try {
                const token = localStorage.getItem('mlnf_token');
                const response = await fetch(`/api/news/${articleId}/toggle-visibility`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(`Article ${data.published ? 'published' : 'hidden'} successfully`, 'success');
                    loadNewsArticles();
                    loadFeaturedStory();
                    loadBreakingTicker();
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Failed to toggle visibility', 'error');
                }
            } catch (error) {
                console.error('Toggle visibility error:', error);
                showNotification('Failed to toggle visibility', 'error');
            }
        }

        async function toggleNewsBreaking(articleId, event) {
            event.stopPropagation(); // Prevent card click

            try {
                const token = localStorage.getItem('mlnf_token');
                const response = await fetch(`/api/news/${articleId}/toggle-breaking`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(data.message, 'success');
                    loadNewsArticles();
                    loadFeaturedStory();
                    loadBreakingTicker();
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Failed to toggle breaking status', 'error');
                }
            } catch (error) {
                console.error('Toggle breaking error:', error);
                showNotification('Failed to toggle breaking status', 'error');
            }
        }

        async function toggleNewsTrending(articleId, event) {
            event.stopPropagation(); // Prevent card click

            try {
                const token = localStorage.getItem('mlnf_token');
                const response = await fetch(`/api/news/${articleId}/toggle-trending`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(data.message, 'success');
                    loadNewsArticles();
                    loadTrendingTopics();
                    loadBreakingTicker();
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Failed to toggle trending status', 'error');
                }
            } catch (error) {
                console.error('Toggle trending error:', error);
                showNotification('Failed to toggle trending status', 'error');
            }
        }

        // Simple notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: var(--radius-md);
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--navy)'};
                color: white;
                font-weight: 500;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            `;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;

            document.body.appendChild(notification);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function renderNewsArticles(articles) {
            const newsFeed = document.getElementById('newsFeed');
            const isAdmin = isUserAdmin();

            if (articles.length === 0) {
                newsFeed.innerHTML = `
                    <div class="text-center" style="padding: 3rem;">
                        <i class="fas fa-newspaper" style="font-size: 4rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--gray-600);">No News Yet</h3>
                        <p class="text-muted">Be the first to break a story!</p>
                        <button class="btn btn-viking mt-2" onclick="document.getElementById('submitNewsBtn').click()">
                            <i class="fas fa-plus-circle"></i> Submit News
                        </button>
                    </div>
                `;
                return;
            }

            newsFeed.innerHTML = articles.map(article => `
                <article class="card news-article-card mb-2" onclick="viewNewsArticle('${article._id || article.slug}')" style="cursor: pointer; transition: all 0.3s ease;">
                    <div class="card-body">
                        <div class="flex gap-sm mb-2 flex-wrap">
                            ${article.breaking ? '<span class="badge badge-error">BREAKING</span>' : ''}
                            <span class="badge" style="background: var(--indigo); color: white;">${article.category || 'News'}</span>
                            ${article.trending ? '<span class="badge badge-peach">Trending</span>' : ''}
                            ${!article.published ? '<span class="badge" style="background: var(--gray-500); color: white;">Hidden</span>' : ''}
                        </div>
                        <h4 style="color: var(--navy); margin-bottom: 0.5rem;">${article.title}</h4>
                        <p class="text-muted" style="margin-bottom: 1rem; line-height: 1.5;">${article.excerpt || article.content?.substring(0, 150) + '...'}</p>
                        <div class="flex flex-between text-sm text-muted">
                            <div class="flex gap-md">
                                <span><i class="fas fa-user"></i> ${article.source || article.author?.username || 'Community'}</span>
                                <span><i class="fas fa-clock"></i> ${formatTimeAgo(article.createdAt)}</span>
                            </div>
                            <div class="flex gap-md">
                                <span><i class="fas fa-eye"></i> ${formatNumber(article.views || 0)}</span>
                                <span><i class="fas fa-comment"></i> ${article.comments?.length || 0}</span>
                            </div>
                        </div>
                        ${isAdmin ? `
                        <div class="admin-controls mt-2 pt-2" style="border-top: 1px solid var(--gray-200); display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-sm ${article.breaking ? 'btn-viking' : 'btn-outline'}" onclick="toggleNewsBreaking('${article._id}', event)" title="${article.breaking ? 'Remove from breaking' : 'Mark as breaking'}">
                                <i class="fas fa-bolt"></i> ${article.breaking ? 'Breaking ✓' : 'Breaking'}
                            </button>
                            <button class="btn btn-sm ${article.trending ? 'btn-viking' : 'btn-outline'}" onclick="toggleNewsTrending('${article._id}', event)" title="${article.trending ? 'Remove from trending' : 'Mark as trending'}">
                                <i class="fas fa-fire"></i> ${article.trending ? 'Trending ✓' : 'Trending'}
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="toggleNewsVisibility('${article._id}', event)" title="${article.published ? 'Hide' : 'Show'} article">
                                <i class="fas fa-${article.published ? 'eye-slash' : 'eye'}"></i> ${article.published ? 'Hide' : 'Show'}
                            </button>
                            <button class="btn btn-outline btn-sm" style="color: var(--error); border-color: var(--error);" onclick="deleteNewsArticle('${article._id}', event)" title="Delete article">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </article>
            `).join('');

            // Add hover effects
            document.querySelectorAll('.news-article-card').forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-4px)';
                    card.style.boxShadow = '0 8px 30px rgba(0,0,0,0.12)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = '';
                });
            });
        }

        function renderSampleNews() {
            // Show empty state instead of fake sample news
            renderNewsArticles([]);
        }

        // Load breaking news ticker
        async function loadBreakingTicker() {
            try {
                const response = await fetch('/api/news/stats/breaking-ticker');
                if (response.ok) {
                    const data = await response.json();
                    if (data.headlines && data.headlines.length > 0) {
                        const tickerText = data.headlines.join(' • ');
                        document.getElementById('tickerText').textContent = tickerText;
                        document.getElementById('breakingTickerSection').style.display = 'block';
                    }
                }
            } catch (error) {
                console.log('Breaking ticker not available');
            }
        }

        // Load featured story
        async function loadFeaturedStory() {
            try {
                const response = await fetch('/api/news/stats/featured');
                if (response.ok) {
                    const data = await response.json();
                    if (data.featured) {
                        renderFeaturedStory(data.featured);
                    }
                }
            } catch (error) {
                console.log('Featured story not available');
            }
        }

        function renderFeaturedStory(article) {
            const container = document.getElementById('featuredStory');
            const content = document.getElementById('featuredStoryContent');

            const authorName = article.author?.username || article.source || 'Anonymous';
            const imageUrl = article.featuredImage || `https://picsum.photos/seed/${article._id}/800/400`;

            content.innerHTML = `
                <div class="badge ${article.breaking ? 'badge-error' : 'badge-gold'} mb-2">
                    ${article.breaking ? 'BREAKING' : 'FEATURED'}
                </div>
                <h2 class="mb-2">${article.title}</h2>
                <div class="flex gap-md text-muted mb-3" style="flex-wrap: wrap;">
                    <span><i class="fas fa-user"></i> ${authorName}</span>
                    <span><i class="fas fa-clock"></i> ${formatTimeAgo(article.createdAt)}</span>
                    <span><i class="fas fa-eye"></i> ${formatNumber(article.views || 0)} views</span>
                </div>
                <img src="${imageUrl}"
                     alt="${article.title}"
                     style="width: 100%; height: 300px; object-fit: cover; border-radius: var(--radius-md); margin-bottom: 1rem;"
                     onerror="this.style.display='none'">
                <p style="font-size: 1.1rem; line-height: 1.8; margin-bottom: 1rem;">
                    ${article.excerpt || (article.content ? article.content.substring(0, 300) + '...' : '')}
                </p>
                <div class="flex flex-between" style="flex-wrap: wrap; gap: 1rem;">
                    <a href="news-article.html?id=${article._id}" class="btn-viking-primary">Read Full Story</a>
                    <div class="flex gap-md">
                        <button class="btn btn-outline btn-sm" onclick="shareArticle('${article._id}', '${article.title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-share"></i> Share
                        </button>
                    </div>
                </div>
            `;

            container.style.display = 'block';
        }

        // Load trending topics
        async function loadTrendingTopics() {
            try {
                const response = await fetch('/api/news/stats/trending');
                if (response.ok) {
                    const data = await response.json();
                    if (data.trending && data.trending.length > 0) {
                        renderTrendingTopics(data.trending);
                    }
                }
            } catch (error) {
                console.log('Trending topics not available');
            }
        }

        function renderTrendingTopics(topics) {
            const container = document.getElementById('trendingTopicsList');
            const card = document.getElementById('trendingTopicsCard');

            container.innerHTML = topics.map(topic => `
                <li class="mb-2">
                    <a href="#" class="flex flex-between" onclick="filterByCategory('${topic.category}'); return false;" style="text-decoration: none; color: inherit;">
                        <span style="color: var(--peach); font-weight: 600;">${topic.hashtag}</span>
                        <span class="badge badge-secondary">${formatNumber(topic.views)}</span>
                    </a>
                </li>
            `).join('');

            card.style.display = 'block';
        }

        function filterByCategory(category) {
            // Find and click the category button
            const btn = document.querySelector(`[data-category="${category.toLowerCase()}"]`);
            if (btn) {
                btn.click();
            } else {
                loadNewsArticles(category);
            }
        }

        // Load most discussed/viewed articles
        async function loadMostDiscussed() {
            try {
                const response = await fetch('/api/news/stats/most-discussed');
                if (response.ok) {
                    const data = await response.json();
                    if (data.articles && data.articles.length > 0) {
                        renderMostDiscussed(data.articles);
                    }
                }
            } catch (error) {
                console.log('Most discussed not available');
            }
        }

        function renderMostDiscussed(articles) {
            const container = document.getElementById('mostDiscussedList');
            const card = document.getElementById('mostDiscussedCard');

            container.innerHTML = articles.map(article => `
                <div class="mb-3" style="cursor: pointer;" onclick="viewNewsArticle('${article._id}')">
                    <h5 class="mb-1" style="font-size: 0.95rem; line-height: 1.4;">${article.title}</h5>
                    <div class="text-muted" style="font-size: 0.875rem;">
                        <span><i class="fas fa-eye"></i> ${formatNumber(article.views)} views</span>
                        <span style="margin-left: 0.75rem;"><i class="fas fa-folder"></i> ${article.category}</span>
                    </div>
                </div>
            `).join('');

            card.style.display = 'block';
        }

        function shareArticle(articleId, title) {
            const url = `${window.location.origin}/pages/news-article.html?id=${articleId}`;
            if (navigator.share) {
                navigator.share({ title, url });
            } else {
                navigator.clipboard.writeText(url);
                alert('Link copied to clipboard!');
            }
        }

        function viewNewsArticle(articleId) {
            window.location.href = `news-article.html?id=${articleId}`;
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toString();
        }

        function formatTimeAgo(dateStr) {
            if (!dateStr) return 'Just now';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        // Category filter buttons
        document.querySelectorAll('[data-category]').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('[data-category]').forEach(b => {
                    b.classList.remove('active', 'btn-viking');
                    b.classList.add('btn-outline');
                });
                this.classList.add('active');
                this.classList.remove('btn-outline');

                // Load articles for category
                loadNewsArticles(this.dataset.category);
            });
        });

        // Initialize news page on load
        document.addEventListener('DOMContentLoaded', function() {
            // Load all dynamic content in parallel
            loadNewsArticles();
            loadBreakingTicker();
            loadFeaturedStory();
            loadTrendingTopics();
            loadMostDiscussed();
        });
    </script>
    <script src="../js/site-enhancements.js"></script>
    <script src="js/mobile-viewport-handler.js"></script>
</body>
</html>