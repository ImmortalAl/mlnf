<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Watch Video - Much Love, No Fear">
    <title>Video Player - Much Love, No Fear</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <div class="flex flex-between">
                <div class="site-logo">
                    <i class="fas fa-shield-alt site-logo-icon"></i>
                    <span>Much Love, No Fear</span>
                </div>
                
                <nav class="site-nav" id="mainNav">
                    <a href="../index.html" class="nav-link">Home</a>
                    <a href="archive.html" class="nav-link active">Love Vault</a>
                    <a href="blog.html" class="nav-link">Blog</a>
                    <a href="news.html" class="nav-link">News</a>
                    <a href="messageboard.html" class="nav-link">Board</a>
                    <a href="donations.html" class="nav-link">Support</a>
                    <a href="merch.html" class="nav-link">Merch</a>
                    <a href="auth.html" class="nav-link" id="authLink">Login</a>
                    <a href="../dashboard.html" class="nav-link hidden" id="dashboardLink">Dashboard</a>
                    
                    <!-- Notification Bell -->
                    <div class="notification-bell hidden" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge hidden" id="notificationBadge">0</span>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <button class="btn-icon" id="themeToggle" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </nav>
                
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Video Player Section -->
    <section style="padding: 2rem 0; background: var(--gray-900);">
        <div class="container">
            <!-- Video Player -->
            <div class="video-player-wrapper" style="position: relative; width: 100%; max-width: 1280px; margin: 0 auto;">
                <video 
                    id="videoPlayer" 
                    class="video-player" 
                    controls 
                    controlsList="nodownload"
                    style="width: 100%; border-radius: var(--radius-lg); background: #000; box-shadow: var(--shadow-xl);"
                    poster="https://via.placeholder.com/160x90/333333/FFFFFF?text=Video">
                    <source id="videoSource" src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                
                <!-- Loading Overlay -->
                <div id="videoLoading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; border-radius: var(--radius-lg); display: none;">
                    <div style="text-align: center; color: white;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.25rem;">Loading video...</p>
                    </div>
                </div>
                
                <!-- Error Overlay -->
                <div id="videoError" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; border-radius: var(--radius-lg); display: none;">
                    <div style="text-align: center; color: white; padding: 2rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: var(--error);"></i>
                        <p style="font-size: 1.25rem; margin-bottom: 1rem;">Unable to load video</p>
                        <p style="opacity: 0.7; margin-bottom: 1.5rem;">The video may be processing or unavailable</p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                </div>
                
                <!-- Custom Controls Overlay -->
                <div id="customControls" style="position: absolute; bottom: 0; left: 0; width: 100%; padding: 1rem; background: linear-gradient(transparent, rgba(0,0,0,0.8)); display: none;">
                    <div class="flex gap-md" style="align-items: center;">
                        <button id="playbackSpeed" class="btn btn-sm btn-outline" style="color: white; border-color: white;">
                            <i class="fas fa-tachometer-alt"></i> 1x
                        </button>
                        <button id="qualityToggle" class="btn btn-sm btn-outline" style="color: white; border-color: white;">
                            <i class="fas fa-cog"></i> Auto
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Video Info -->
    <section style="padding: 2rem 0;">
        <div class="container">
            <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 2rem;">
                <!-- Main Content -->
                <div>
                    <h1 id="videoTitle">The Great Awakening: Truth Revealed</h1>
                    
                    <div class="flex flex-between mb-3" style="padding: 1rem 0; border-bottom: 1px solid var(--gray-200);">
                        <div class="flex gap-md">
                            <span><i class="fas fa-eye"></i> <span id="videoViews">15,234</span> views</span>
                            <span><i class="fas fa-calendar"></i> 2 days ago</span>
                        </div>
                        
                        <div class="flex gap-md">
                            <!-- Vote Buttons -->
                            <button class="btn btn-outline btn-sm" id="upvoteBtn">
                                <i class="fas fa-thumbs-up"></i> <span id="upvoteCount">892</span>
                            </button>
                            <button class="btn btn-outline btn-sm" id="downvoteBtn">
                                <i class="fas fa-thumbs-down"></i> <span id="downvoteCount">45</span>
                            </button>
                            
                            <!-- Share Button -->
                            <button class="btn btn-outline btn-sm">
                                <i class="fas fa-share"></i> Share
                            </button>
                            
                            <!-- Boost Button -->
                            <button class="btn btn-viking btn-sm" id="boostBtn">
                                <i class="fas fa-rocket"></i> Boost (50 RG)
                            </button>
                        </div>
                    </div>

                    <!-- Uploader Info -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="flex flex-between">
                                <div class="flex gap-md">
                                    <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        TS
                                    </div>
                                    <div>
                                        <h4 id="uploaderName">TruthSeeker99</h4>
                                        <p class="text-muted text-sm">1.2K followers</p>
                                    </div>
                                </div>
                                <button class="btn btn-primary">
                                    <i class="fas fa-user-plus"></i> Follow
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Video Description -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <h3 class="mb-2">Description</h3>
                            <p id="videoDescription">Deep dive into the systematic suppression of truth and how we can fight back. This video explores the mechanisms of censorship and provides actionable strategies for spreading awareness.</p>
                            
                            <div class="flex gap-sm mt-3">
                                <span class="badge badge-primary">truth</span>
                                <span class="badge badge-primary">awakening</span>
                                <span class="badge badge-primary">freedom</span>
                            </div>
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="mb-3"><span id="commentCount">234</span> Comments</h3>
                            
                            <!-- Add Comment Form -->
                            <div class="mb-4" id="commentFormContainer">
                                <textarea id="commentText" class="form-control" rows="3" placeholder="Add a comment... (Login required)"></textarea>
                                <div class="flex gap-md mt-2">
                                    <button class="btn btn-viking" id="submitCommentBtn">
                                        <i class="fas fa-comment"></i> Post Comment
                                    </button>
                                    <button class="btn btn-outline" id="cancelCommentBtn" style="display: none;">
                                        Cancel
                                    </button>
                                </div>
                            </div>

                            <!-- Comments List -->
                            <div id="commentsList">
                                <!-- Comments will be loaded here -->
                                <div class="comment-item" style="padding: 1rem 0; border-bottom: 1px solid var(--gray-100);">
                                    <div class="flex gap-md">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
                                            FF
                                        </div>
                                        <div style="flex: 1;">
                                            <div class="flex gap-sm mb-1">
                                                <strong>FreedomFighter</strong>
                                                <span class="text-muted text-sm">2 hours ago</span>
                                            </div>
                                            <p class="mb-2">This is exactly what we need! Thank you for speaking the truth without fear. The awakening is happening!</p>
                                            <div class="flex gap-md text-sm">
                                                <button class="btn-text"><i class="fas fa-thumbs-up"></i> 45</button>
                                                <button class="btn-text"><i class="fas fa-thumbs-down"></i></button>
                                                <button class="btn-text"><i class="fas fa-reply"></i> Reply</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="comment-item" style="padding: 1rem 0; border-bottom: 1px solid var(--gray-100);">
                                    <div class="flex gap-md">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
                                            AW
                                        </div>
                                        <div style="flex: 1;">
                                            <div class="flex gap-sm mb-1">
                                                <strong>AwakeAndAware</strong>
                                                <span class="text-muted text-sm">5 hours ago</span>
                                            </div>
                                            <p class="mb-2">Shared this with my entire community. Everyone needs to see this. Much love, no fear! 🛡️</p>
                                            <div class="flex gap-md text-sm">
                                                <button class="btn-text"><i class="fas fa-thumbs-up"></i> 32</button>
                                                <button class="btn-text"><i class="fas fa-thumbs-down"></i></button>
                                                <button class="btn-text"><i class="fas fa-reply"></i> Reply</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="comment-item" style="padding: 1rem 0;">
                                    <div class="flex gap-md">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
                                            HW
                                        </div>
                                        <div style="flex: 1;">
                                            <div class="flex gap-sm mb-1">
                                                <strong>HealthWarrior</strong>
                                                <span class="text-muted text-sm">1 day ago</span>
                                            </div>
                                            <p class="mb-2">The information at 12:45 is crucial. Everyone should timestamp that section!</p>
                                            <div class="flex gap-md text-sm">
                                                <button class="btn-text"><i class="fas fa-thumbs-up"></i> 28</button>
                                                <button class="btn-text"><i class="fas fa-thumbs-down"></i></button>
                                                <button class="btn-text"><i class="fas fa-reply"></i> Reply</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Load More -->
                            <div class="text-center mt-3">
                                <button class="btn btn-outline">
                                    <i class="fas fa-chevron-down"></i> Show More Comments
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <aside>
                    <!-- Related Videos -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="mb-3">Related Videos</h3>
                            
                            <div class="related-video" style="display: flex; gap: 0.75rem; margin-bottom: 1rem; cursor: pointer;">
                                <img src="https://via.placeholder.com/160x90/333333/FFFFFF?text=Video" alt="Video" style="width: 160px; height: 90px; object-fit: cover; border-radius: var(--radius-sm);">
                                <div>
                                    <h5 style="font-size: 0.875rem; margin-bottom: 0.25rem; line-height: 1.4;">Natural Immunity: The Science They Hide</h5>
                                    <p class="text-muted text-sm">HealthWarrior</p>
                                    <p class="text-muted text-sm">12.5k views</p>
                                </div>
                            </div>

                            <div class="related-video" style="display: flex; gap: 0.75rem; margin-bottom: 1rem; cursor: pointer;">
                                <img src="https://via.placeholder.com/160x90/333333/FFFFFF?text=Video" alt="Video" style="width: 160px; height: 90px; object-fit: cover; border-radius: var(--radius-sm);">
                                <div>
                                    <h5 style="font-size: 0.875rem; margin-bottom: 0.25rem; line-height: 1.4;">Financial System Collapse: Prepare Now</h5>
                                    <p class="text-muted text-sm">EconViking</p>
                                    <p class="text-muted text-sm">18.9k views</p>
                                </div>
                            </div>

                            <div class="related-video" style="display: flex; gap: 0.75rem; cursor: pointer;">
                                <img src="https://via.placeholder.com/160x90/333333/FFFFFF?text=Video" alt="Video" style="width: 160px; height: 90px; object-fit: cover; border-radius: var(--radius-sm);">
                                <div>
                                    <h5 style="font-size: 0.875rem; margin-bottom: 0.25rem; line-height: 1.4;">Mass Meditation for Global Peace</h5>
                                    <p class="text-muted text-sm">LightWorker</p>
                                    <p class="text-muted text-sm">8.7k views</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer style="background: var(--navy); color: var(--cream); padding: 3rem 0;">
        <div class="container">
            <div class="grid grid-3">
                <div>
                    <h4 style="color: var(--gold);">Much Love, No Fear</h4>
                    <p>A sanctuary for truth-seekers and free thinkers.</p>
                    <div class="flex gap-md" style="margin-top: 1rem;">
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-twitter"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-discord"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Quick Links</h5>
                    <ul style="list-style: none;">
                        <li><a href="archive.html" style="color: var(--cream);">Love Vault</a></li>
                        <li><a href="blog.html" style="color: var(--cream);">Blog</a></li>
                        <li><a href="messageboard.html" style="color: var(--cream);">Message Board</a></li>
                        <li><a href="donations.html" style="color: var(--cream);">Support Us</a></li>
                    </ul>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Community</h5>
                    <ul style="list-style: none;">
                        <li><a href="#" style="color: var(--cream);">Guidelines</a></li>
                        <li><a href="#" style="color: var(--cream);">Privacy Policy</a></li>
                        <li><a href="#" style="color: var(--cream);">Terms of Service</a></li>
                        <li><a href="#" style="color: var(--cream);">Contact</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="text-center" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <p>&copy; 2024 Much Love, No Fear. All rights reserved. Built with ❤️ and Viking spirit.</p>
            </div>
        </div>
    </footer>

    <!-- Sidebar - Online Users -->
    <aside class="sidebar" id="sidebar">
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-chevron-right"></i>
        </button>
        
        <div class="runegold-display" id="runegoldDisplay">
            <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">Your Runegold</div>
            <div class="runegold-amount" id="runegoldAmount">0</div>
            <a href="../dashboard.html" class="btn btn-sm btn-primary" style="margin-top: 0.5rem; width: 100%;">
                <i class="fas fa-shopping-cart"></i> Shop
            </a>
        </div>
        
        <h6 style="margin-bottom: 1rem;">
            <i class="fas fa-users"></i> Online Users
            <span id="onlineCount" style="font-size: 0.75rem; opacity: 0.7;">(0)</span>
        </h6>
        
        <ul class="online-users-list" id="onlineUsersList">
            <li class="text-center text-muted" style="padding: 2rem 0;">
                <i class="fas fa-user-slash" style="font-size: 2rem; opacity: 0.3;"></i>
                <p style="margin-top: 1rem; font-size: 0.875rem;">No users online</p>
            </li>
        </ul>
    </aside>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="../api-client.js"></script>
    <script src="../auth-handler.js"></script>
    <script src="../mock-data.js"></script>
    <!-- Load scripts.js BEFORE page-loader.js so APIClient is defined -->
    <script src="../scripts.js"></script>
    <script src="../page-loader.js"></script>
    
    <!-- Video Page Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Get video ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('id') || 'demo-video-1';
            
            // State variables
            let currentVideo = null;
            let userVote = null; // 'upvote', 'downvote', or null
            
            // Load video data
            async function loadVideoData() {
                try {
                    const response = await APIClient.videos.getById(videoId);
                    currentVideo = response.video;
                    
                    // Update page with video data
                    document.getElementById('videoTitle').textContent = currentVideo.title;
                    document.getElementById('videoDescription').textContent = currentVideo.description;
                    document.getElementById('videoViews').textContent = currentVideo.views.toLocaleString();
                    
                    // Upvotes and downvotes are arrays of ObjectIds - show length
                    const upvoteCount = currentVideo.upvotes?.length || 0;
                    const downvoteCount = currentVideo.downvotes?.length || 0;
                    document.getElementById('upvoteCount').textContent = upvoteCount;
                    document.getElementById('downvoteCount').textContent = downvoteCount;
                    
                    document.getElementById('uploaderName').textContent = currentVideo.uploader?.username || 'Unknown';
                    
                    // Check if user has voted
                    if (MLNFAuth.isLoggedIn()) {
                        const user = MLNFAuth.getUser();
                        const userId = user._id || user.id;
                        
                        // Check if user's ID is in upvotes array
                        if (currentVideo.upvotes?.some(id => id.toString() === userId.toString())) {
                            userVote = 'upvote';
                            document.getElementById('upvoteBtn').classList.remove('btn-outline');
                            document.getElementById('upvoteBtn').classList.add('btn-primary');
                        } 
                        // Check if user's ID is in downvotes array
                        else if (currentVideo.downvotes?.some(id => id.toString() === userId.toString())) {
                            userVote = 'downvote';
                            document.getElementById('downvoteBtn').classList.remove('btn-outline');
                            document.getElementById('downvoteBtn').classList.add('btn-error');
                        }
                    }
                    
                    // Load video stream
                    loadVideoStream();
                } catch (error) {
                    console.error('Error loading video:', error);
                    // Keep placeholder data if API fails
                    document.getElementById('videoError').style.display = 'flex';
                }
            }
            
            // Load video stream
            function loadVideoStream() {
                const videoPlayer = document.getElementById('videoPlayer');
                const videoSource = document.getElementById('videoSource');
                const videoLoading = document.getElementById('videoLoading');
                const videoError = document.getElementById('videoError');
                
                // Show loading overlay
                videoLoading.style.display = 'flex';
                
                // Determine API base URL
                const hostname = window.location.hostname;
                let apiBaseUrl;
                
                if (hostname.includes('netlify.app') || hostname.includes('mlnf.net') || hostname.includes('vercel.app')) {
                    apiBaseUrl = 'https://much-love-no-fear.onrender.com/api';
                } else if (hostname.includes('sandbox.novita.ai') || hostname === 'localhost' || hostname === '127.0.0.1') {
                    apiBaseUrl = 'http://localhost:5000/api';
                } else {
                    apiBaseUrl = 'https://much-love-no-fear.onrender.com/api';
                }
                
                // Set video source
                const streamUrl = `${apiBaseUrl}/videos/stream/${videoId}`;
                videoSource.src = streamUrl;
                
                // Load video
                videoPlayer.load();
                
                // Handle video events
                videoPlayer.addEventListener('loadeddata', () => {
                    videoLoading.style.display = 'none';
                    videoError.style.display = 'none';
                });
                
                videoPlayer.addEventListener('error', () => {
                    videoLoading.style.display = 'none';
                    videoError.style.display = 'flex';
                    console.error('Video playback error');
                });
                
                videoPlayer.addEventListener('canplay', () => {
                    videoLoading.style.display = 'none';
                });
                
                // Playback speed control
                const playbackSpeedBtn = document.getElementById('playbackSpeed');
                const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
                let currentSpeedIndex = 2; // Default 1x
                
                if (playbackSpeedBtn) {
                    playbackSpeedBtn.addEventListener('click', () => {
                        currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
                        const speed = speeds[currentSpeedIndex];
                        videoPlayer.playbackRate = speed;
                        playbackSpeedBtn.innerHTML = `<i class="fas fa-tachometer-alt"></i> ${speed}x`;
                    });
                }
            }
            
            // Load comments
            async function loadComments() {
                try {
                    const response = await APIClient.comments.getByVideoId(videoId);
                    const comments = response.comments || [];
                    
                    const commentsList = document.getElementById('commentsList');
                    
                    if (comments.length === 0) {
                        commentsList.innerHTML = `
                            <div class="text-center py-5" style="color: var(--gray-500);">
                                <i class="fas fa-comment-slash" style="font-size: 3rem; opacity: 0.3;"></i>
                                <p style="margin-top: 1rem;">No comments yet</p>
                                <p style="font-size: 0.875rem;">Be the first to share your thoughts!</p>
                            </div>
                        `;
                        document.getElementById('commentCount').textContent = '0';
                        return;
                    }
                    
                    commentsList.innerHTML = comments.map(comment => {
                        // Comment.user is populated with user object
                        const username = comment.user?.username || 'Unknown User';
                        const initials = username.substring(0, 2).toUpperCase();
                        const timeAgo = getTimeAgo(new Date(comment.createdAt));
                        const likesCount = comment.likes?.length || 0;
                        
                        return `
                            <div class="comment-item" style="padding: 1rem 0; border-bottom: 1px solid var(--gray-100);">
                                <div class="flex gap-md">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
                                        ${initials}
                                    </div>
                                    <div style="flex: 1;">
                                        <div class="flex gap-sm mb-1">
                                            <strong>${username}</strong>
                                            <span class="text-muted text-sm">${timeAgo}</span>
                                        </div>
                                        <p class="mb-2">${escapeHtml(comment.content)}</p>
                                        <div class="flex gap-md text-sm">
                                            <button class="btn-text"><i class="fas fa-thumbs-up"></i> ${likesCount}</button>
                                            <button class="btn-text"><i class="fas fa-thumbs-down"></i></button>
                                            <button class="btn-text"><i class="fas fa-reply"></i> Reply</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('commentCount').textContent = comments.length;
                } catch (error) {
                    console.error('Error loading comments:', error);
                    // Keep placeholder comments if API fails
                }
            }
            
            // Helper function: Time ago
            function getTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                
                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
                if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
                if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
                return Math.floor(seconds / 604800) + ' weeks ago';
            }
            
            // Helper function: Escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Helper function: Show notification
            function showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                notif.className = `notification notification-${type}`;
                notif.textContent = message;
                notif.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; background: var(--navy); color: white; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 10000;';
                
                if (type === 'success') notif.style.background = 'var(--success)';
                if (type === 'error') notif.style.background = 'var(--error)';
                
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            }
            
            // Upvote button handler
            document.getElementById('upvoteBtn').addEventListener('click', async function() {
                if (!MLNFAuth.isLoggedIn()) {
                    showNotification('Please login to vote', 'error');
                    return;
                }
                
                try {
                    // Backend toggles automatically - just send 'upvote'
                    const response = await APIClient.videos.vote(videoId, 'upvote');
                    
                    // Update UI based on backend response
                    document.getElementById('upvoteCount').textContent = response.upvotes;
                    document.getElementById('downvoteCount').textContent = response.downvotes;
                    
                    // Update button states based on action
                    if (response.action === 'upvoted') {
                        userVote = 'upvote';
                        this.classList.remove('btn-outline');
                        this.classList.add('btn-primary');
                        
                        // Remove downvote styling
                        const downvoteBtn = document.getElementById('downvoteBtn');
                        downvoteBtn.classList.remove('btn-error');
                        downvoteBtn.classList.add('btn-outline');
                        
                        showNotification('Upvoted!', 'success');
                    } else if (response.action === 'removed_upvote') {
                        userVote = null;
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline');
                        
                        showNotification('Vote removed', 'success');
                    }
                } catch (error) {
                    console.error('Error voting:', error);
                    showNotification(error.message || 'Failed to vote', 'error');
                }
            });
            
            // Downvote button handler
            document.getElementById('downvoteBtn').addEventListener('click', async function() {
                if (!MLNFAuth.isLoggedIn()) {
                    showNotification('Please login to vote', 'error');
                    return;
                }
                
                try {
                    // Backend toggles automatically - just send 'downvote'
                    const response = await APIClient.videos.vote(videoId, 'downvote');
                    
                    // Update UI based on backend response
                    document.getElementById('upvoteCount').textContent = response.upvotes;
                    document.getElementById('downvoteCount').textContent = response.downvotes;
                    
                    // Update button states based on action
                    if (response.action === 'downvoted') {
                        userVote = 'downvote';
                        this.classList.remove('btn-outline');
                        this.classList.add('btn-error');
                        
                        // Remove upvote styling
                        const upvoteBtn = document.getElementById('upvoteBtn');
                        upvoteBtn.classList.remove('btn-primary');
                        upvoteBtn.classList.add('btn-outline');
                        
                        showNotification('Downvoted', 'success');
                    } else if (response.action === 'removed_downvote') {
                        userVote = null;
                        this.classList.remove('btn-error');
                        this.classList.add('btn-outline');
                        
                        showNotification('Vote removed', 'success');
                    }
                } catch (error) {
                    console.error('Error voting:', error);
                    showNotification(error.message || 'Failed to vote', 'error');
                }
            });
            
            // Boost button handler
            document.getElementById('boostBtn').addEventListener('click', async function() {
                if (!MLNFAuth.isLoggedIn()) {
                    showNotification('Please login to boost videos', 'error');
                    return;
                }
                
                // Confirm boost
                if (!confirm('Boost this video for 50 Runegold? It will be featured for 1 hour.')) {
                    return;
                }
                
                try {
                    // Disable button during request
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Boosting...';
                    
                    const response = await APIClient.videos.boost(videoId);
                    
                    showNotification(`Video boosted! New balance: ${response.balance} RG`, 'success');
                    
                    // Update button to show boosted state
                    this.innerHTML = '<i class="fas fa-check"></i> Boosted!';
                    this.classList.add('btn-success');
                    
                    // Update Runegold balance in sidebar if exists
                    const runegoldAmountEl = document.getElementById('runegoldAmount');
                    if (runegoldAmountEl) {
                        runegoldAmountEl.textContent = response.balance;
                    }
                } catch (error) {
                    console.error('Error boosting video:', error);
                    showNotification(error.message || 'Failed to boost video', 'error');
                    
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-rocket"></i> Boost (50 RG)';
                }
            });
            
            // Comment submission
            document.getElementById('submitCommentBtn').addEventListener('click', async function() {
                if (!MLNFAuth.isLoggedIn()) {
                    showNotification('Please login to comment', 'error');
                    window.location.href = 'auth.html';
                    return;
                }
                
                const commentText = document.getElementById('commentText').value.trim();
                if (!commentText) {
                    showNotification('Please enter a comment', 'error');
                    return;
                }
                
                try {
                    // Disable button during submission
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
                    
                    const response = await APIClient.comments.create(videoId, commentText);
                    
                    // Clear textarea
                    document.getElementById('commentText').value = '';
                    
                    // Reload comments to show new one
                    await loadComments();
                    
                    showNotification('Comment posted successfully!', 'success');
                } catch (error) {
                    console.error('Error posting comment:', error);
                    showNotification(error.message || 'Failed to post comment', 'error');
                } finally {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-comment"></i> Post Comment';
                }
            });
            
            // Initial load
            await loadVideoData();
            await loadComments();
        });
    </script>
</body>
</html>