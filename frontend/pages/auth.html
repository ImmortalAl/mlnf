<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Login or Sign Up - Much Love, No Fear">
    <title>Authentication - Much Love, No Fear</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <div class="flex flex-between">
                <div class="site-logo">
                    <i class="fas fa-shield-alt site-logo-icon"></i>
                    <span>Much Love, No Fear</span>
                </div>
                
                <nav class="site-nav" id="mainNav">
                    <a href="../index.html" class="nav-link">Home</a>
                    <a href="archive.html" class="nav-link">Love Vault</a>
                    <a href="blog.html" class="nav-link">Blog</a>
                    <a href="news.html" class="nav-link">News</a>
                    <a href="messageboard.html" class="nav-link">Board</a>
                    <a href="donations.html" class="nav-link">Support</a>
                    <a href="merch.html" class="nav-link">Merch</a>
                    <a href="auth.html" class="nav-link active" id="authLink">Login</a>
                    <a href="../dashboard.html" class="nav-link hidden" id="dashboardLink">Dashboard</a>
                    
                    <!-- Notification Bell -->
                    <div class="notification-bell hidden" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge hidden" id="notificationBadge">0</span>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <button class="btn-icon" id="themeToggle" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </nav>
                
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Auth Section -->
    <section style="padding: 3rem 0; background: linear-gradient(135deg, var(--navy) 0%, var(--indigo) 100%); min-height: 80vh;">
        <div class="container">
            <div style="max-width: 800px; margin: 0 auto;">
                <!-- Tab Navigation -->
                <div class="flex flex-center gap-md mb-4">
                    <button class="btn btn-lg btn-viking" id="loginTab" onclick="switchTab('login')">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <button class="btn btn-lg btn-outline" style="color: white; border-color: white;" id="signupTab" onclick="switchTab('signup')">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="card card-viking">
                    <div class="card-body" style="padding: 2rem;">
                        <h2 class="text-center mb-4">
                            <i class="fas fa-shield-alt text-gold"></i> Welcome Back, Warrior
                        </h2>
                        
                        <form>
                            <div class="form-group">
                                <label for="loginEmail">Email or Username</label>
                                <input type="text" id="loginEmail" class="form-control" placeholder="Enter your email or username" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="loginPassword">Password</label>
                                <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                            </div>
                            
                            <div class="flex flex-between mb-3">
                                <label>
                                    <input type="checkbox" id="rememberMe"> Remember me
                                </label>
                                <a href="#" style="color: var(--indigo);">Forgot password?</a>
                            </div>
                            
                            <button type="submit" class="btn btn-viking btn-lg" style="width: 100%;">
                                <i class="fas fa-sign-in-alt"></i> Login to Your Account
                            </button>
                        </form>
                        
                        <div class="text-center mt-4">
                            <p>Or continue with</p>
                            <div class="flex flex-center gap-md mt-2">
                                <button class="btn btn-outline">
                                    <i class="fab fa-google"></i> Google
                                </button>
                                <button class="btn btn-outline">
                                    <i class="fab fa-twitter"></i> Twitter
                                </button>
                                <button class="btn btn-outline">
                                    <i class="fab fa-telegram"></i> Telegram
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sign Up Form -->
                <div id="signupForm" class="card card-viking" style="display: none;">
                    <div class="card-body" style="padding: 2rem;">
                        <h2 class="text-center mb-4">
                            <i class="fas fa-user-shield text-gold"></i> Join the Resistance
                        </h2>
                        
                        <form>
                            <div class="grid grid-2 gap-md">
                                <div class="form-group">
                                    <label for="firstName">First Name (Optional)</label>
                                    <input type="text" id="firstName" class="form-control" placeholder="Your first name">
                                </div>
                                
                                <div class="form-group">
                                    <label for="lastName">Last Name (Optional)</label>
                                    <input type="text" id="lastName" class="form-control" placeholder="Your last name">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="signupUsername">Username</label>
                                <input type="text" id="signupUsername" class="form-control" placeholder="Choose a warrior name" required>
                                <small class="text-muted">This will be your public identity</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="signupEmail">Email (Optional)</label>
                                <input type="email" id="signupEmail" class="form-control" placeholder="your@email.com">
                                <small class="text-muted">Optional - We'll never share your email</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="signupPassword">Password</label>
                                <input type="password" id="signupPassword" class="form-control" placeholder="Create a strong password" required>
                                <div class="password-strength mt-2">
                                    <div class="password-strength-bar" style="height: 4px; background: var(--gray-200); border-radius: 2px;">
                                        <div id="strengthBar" style="height: 100%; width: 0%; background: var(--success); border-radius: 2px; transition: all 0.3s;"></div>
                                    </div>
                                    <small class="text-muted">Password strength: <span id="strengthText">Weak</span></small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword">Confirm Password</label>
                                <input type="password" id="confirmPassword" class="form-control" placeholder="Re-enter your password" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Security Question (Optional)</label>
                                <select class="form-control mb-2">
                                    <option>What truth awakened you?</option>
                                    <option>Your first red pill moment?</option>
                                    <option>Favorite freedom fighter?</option>
                                    <option>What year did you wake up?</option>
                                </select>
                                <input type="text" class="form-control" placeholder="Your answer">
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" required> I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox"> Send me uncensored news updates (optional)
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-viking btn-lg" style="width: 100%;">
                                <i class="fas fa-user-plus"></i> Create Free Account
                            </button>
                        </form>
                        
                        <div class="text-center mt-4">
                            <p>Or sign up with</p>
                            <div class="flex flex-center gap-md mt-2">
                                <button class="btn btn-outline">
                                    <i class="fab fa-google"></i> Google
                                </button>
                                <button class="btn btn-outline">
                                    <i class="fab fa-twitter"></i> Twitter
                                </button>
                                <button class="btn btn-outline">
                                    <i class="fab fa-telegram"></i> Telegram
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Benefits Section -->
                <div class="mt-4 text-center" style="color: white;">
                    <h3 style="color: var(--gold); margin-bottom: 1rem;">Why Join Our Community?</h3>
                    <div class="grid grid-4 gap-md">
                        <div>
                            <i class="fas fa-shield-alt" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>
                            <h5>No Censorship</h5>
                            <p style="font-size: 0.875rem; opacity: 0.9;">Speak freely without fear</p>
                        </div>
                        <div>
                            <i class="fas fa-user-secret" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>
                            <h5>Privacy First</h5>
                            <p style="font-size: 0.875rem; opacity: 0.9;">Your data stays yours</p>
                        </div>
                        <div>
                            <i class="fas fa-users" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>
                            <h5>Real Community</h5>
                            <p style="font-size: 0.875rem; opacity: 0.9;">Connect with truth seekers</p>
                        </div>
                        <div>
                            <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>
                            <h5>Earn Runegold</h5>
                            <p style="font-size: 0.875rem; opacity: 0.9;">Get rewarded for contributions</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer style="background: var(--navy); color: var(--cream); padding: 3rem 0;">
        <div class="container">
            <div class="grid grid-3">
                <div>
                    <h4 style="color: var(--gold);">Much Love, No Fear</h4>
                    <p>A sanctuary for truth-seekers and free thinkers.</p>
                    <div class="flex gap-md" style="margin-top: 1rem;">
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-twitter"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-discord"></i></a>
                        <a href="#" style="color: var(--cream); font-size: 1.5rem;"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Quick Links</h5>
                    <ul style="list-style: none;">
                        <li><a href="archive.html" style="color: var(--cream);">Love Vault</a></li>
                        <li><a href="blog.html" style="color: var(--cream);">Blog</a></li>
                        <li><a href="messageboard.html" style="color: var(--cream);">Message Board</a></li>
                        <li><a href="donations.html" style="color: var(--cream);">Support Us</a></li>
                    </ul>
                </div>
                
                <div>
                    <h5 style="color: var(--gold);">Community</h5>
                    <ul style="list-style: none;">
                        <li><a href="#" style="color: var(--cream);">Guidelines</a></li>
                        <li><a href="#" style="color: var(--cream);">Privacy Policy</a></li>
                        <li><a href="#" style="color: var(--cream);">Terms of Service</a></li>
                        <li><a href="#" style="color: var(--cream);">Contact</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="text-center" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <p>&copy; 2024 Much Love, No Fear. All rights reserved. Built with ❤️ and Viking spirit.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="../api-client.js"></script>
    <script src="../auth-handler.js"></script>
    <script src="../scripts.js"></script>
    
    <!-- Authentication Script -->
    <script>
        // Tab Switching
        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            
            if (tab === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                loginTab.classList.add('btn-viking');
                loginTab.classList.remove('btn-outline');
                signupTab.classList.add('btn-outline');
                signupTab.classList.remove('btn-viking');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                signupTab.classList.add('btn-viking');
                signupTab.classList.remove('btn-outline');
                loginTab.classList.add('btn-outline');
                loginTab.classList.remove('btn-viking');
            }
        }
        
        // Password strength checker
        document.getElementById('signupPassword')?.addEventListener('input', function(e) {
            const password = e.target.value;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]+/)) strength++;
            if (password.match(/[A-Z]+/)) strength++;
            if (password.match(/[0-9]+/)) strength++;
            if (password.match(/[$@#&!]+/)) strength++;
            
            const widths = ['0%', '20%', '40%', '60%', '80%', '100%'];
            const colors = ['#ef4444', '#f59e0b', '#eab308', '#84cc16', '#22c55e', '#10b981'];
            const texts = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong', 'Very Strong'];
            
            strengthBar.style.width = widths[strength];
            strengthBar.style.background = colors[strength];
            strengthText.textContent = texts[strength];
        });

        // Initialize authentication handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in and validate token
            const token = localStorage.getItem('mlnf_token');
            if (token) {
                // Validate token before redirecting
                validateAndRedirect(token);
                return;
            }

            // Login Form Handler
            const loginFormElement = document.querySelector('#loginForm form');
            if (loginFormElement) {
                loginFormElement.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    
                    if (!username || !password) {
                        showNotification('Please fill in all fields', 'error');
                        return;
                    }
                    
                    // Show loading state
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                    submitBtn.disabled = true;
                    
                    try {
                        // Try API login
                        const data = await APIClient.auth.login({ username, password });
                        handleLoginSuccess(data);
                        
                    } catch (apiError) {
                        console.error('API login error:', apiError);
                        // Fall back to local authentication
                        console.log('Backend not available, using local authentication');
                        
                        // Local authentication
                        const users = JSON.parse(localStorage.getItem('mlnf_users') || '{}');
                        const user = users[username.toLowerCase()];
                        
                        if (user && user.password === password) {
                            const loginData = {
                                token: 'local_' + Date.now(),
                                user: {
                                    _id: user.id,
                                    username: user.username,
                                    email: user.email,
                                    runegoldBalance: user.runegoldBalance || 100,
                                    createdAt: user.createdAt
                                }
                            };
                            handleLoginSuccess(loginData);
                        } else {
                            showNotification('Invalid username or password', 'error');
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }
                    }
                });
            }
            
            // Signup Form Handler
            const signupFormElement = document.querySelector('#signupForm form');
            if (signupFormElement) {
                signupFormElement.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const firstName = document.getElementById('firstName').value.trim();
                    const lastName = document.getElementById('lastName').value.trim();
                    const username = document.getElementById('signupUsername').value.trim();
                    const email = document.getElementById('signupEmail').value.trim();
                    const password = document.getElementById('signupPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    // Validation
                    if (!username || !password || !confirmPassword) {
                        showNotification('Please fill in username and password', 'error');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showNotification('Passwords do not match', 'error');
                        return;
                    }
                    
                    if (password.length < 8) {
                        showNotification('Password must be at least 8 characters', 'error');
                        return;
                    }
                    
                    if (username.length < 3) {
                        showNotification('Username must be at least 3 characters', 'error');
                        return;
                    }
                    
                    // Show loading state
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
                    submitBtn.disabled = true;
                    
                    try {
                        // Try API registration
                        const data = await APIClient.auth.register({
                            firstName,
                            lastName,
                            username,
                            email: email || undefined,
                            password
                        });
                        
                        handleLoginSuccess(data);
                        
                    } catch (apiError) {
                        console.error('API registration error:', apiError);
                        // Fall back to local storage
                        console.log('Backend not available, using local storage');
                        
                        // Local storage registration
                        const users = JSON.parse(localStorage.getItem('mlnf_users') || '{}');
                        
                        // Check if username already exists
                        if (users[username.toLowerCase()]) {
                            showNotification('Username already taken', 'error');
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                            return;
                        }
                        
                        // Create new user
                        const newUser = {
                            id: 'user_' + Date.now(),
                            username: username,
                            firstName: firstName,
                            lastName: lastName,
                            email: email || '', // Email is optional
                            password: password, // In production, this would be hashed
                            runegoldBalance: 100, // Welcome bonus
                            createdAt: new Date().toISOString()
                        };
                        
                        users[username.toLowerCase()] = newUser;
                        localStorage.setItem('mlnf_users', JSON.stringify(users));
                        
                        // Auto-login after registration
                        const loginData = {
                            token: 'local_' + Date.now(),
                            user: {
                                _id: newUser.id,
                                username: newUser.username,
                                firstName: newUser.firstName,
                                lastName: newUser.lastName,
                                email: newUser.email,
                                runegoldBalance: newUser.runegoldBalance,
                                createdAt: newUser.createdAt
                            }
                        };
                        handleLoginSuccess(loginData);
                    }
                });
            }
        });
        
        // Get API Base URL
        function getAPIBaseURL() {
            const hostname = window.location.hostname;
            
            if (hostname.includes('netlify.app') || hostname.includes('mlnf.net') || hostname.includes('vercel.app')) {
                return 'https://much-love-no-fear.onrender.com/api';
            }
            
            if (hostname.includes('sandbox.novita.ai') || hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:5000/api';
            }
            
            return 'https://much-love-no-fear.onrender.com/api';
        }
        
        // Validate token and redirect to dashboard
        async function validateAndRedirect(token) {
            try {
                const API_BASE_URL = getAPIBaseURL();
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    // Token is valid, redirect to dashboard
                    console.log('✅ Token valid, redirecting to dashboard');
                    window.location.href = '../dashboard.html';
                } else {
                    // Token is invalid or expired, clear it
                    console.log('⚠️ Token invalid, clearing localStorage');
                    localStorage.removeItem('mlnf_token');
                    localStorage.removeItem('mlnf_user');
                    showNotification('Session expired. Please login again.', 'info');
                }
            } catch (error) {
                console.error('Token validation error:', error);
                // If backend is unreachable, allow redirect anyway (offline mode)
                console.log('⚠️ Backend unreachable, allowing offline access');
                window.location.href = '../dashboard.html';
            }
        }
        
        // Handle successful login/registration
        function handleLoginSuccess(data) {
            console.log('✅ Login successful, saving auth data');
            console.log('Token:', data.token ? 'Present' : 'Missing');
            console.log('User:', data.user);
            
            localStorage.setItem('mlnf_token', data.token);
            localStorage.setItem('mlnf_user', JSON.stringify(data.user));
            
            // Verify data was saved
            const savedToken = localStorage.getItem('mlnf_token');
            const savedUser = localStorage.getItem('mlnf_user');
            console.log('Verification - Token saved:', !!savedToken);
            console.log('Verification - User saved:', !!savedUser);
            
            showNotification('Welcome, ' + data.user.username + '!', 'success');
            
            setTimeout(() => {
                console.log('Redirecting to dashboard...');
                window.location.href = '../dashboard.html';
            }, 1000);
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                z-index: 9999;
                animation: slideInRight 0.3s ease-out;
                max-width: 400px;
            `;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html> = localStorage.getItem('mlnf_user');
            console.log('Verification - Token saved:', !!savedToken);
            console.log('Verification - User saved:', !!savedUser);
            
            showNotification('Welcome, ' + data.user.username + '!', 'success');
            
            setTimeout(() => {
                console.log('Redirecting to dashboard...');
                window.location.href = '../dashboard.html';
            }, 1000);
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                z-index: 9999;
                animation: slideInRight 0.3s ease-out;
                max-width: 400px;
            `;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>